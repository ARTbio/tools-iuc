<?xml version="1.0"?>
<macros>
  <xml name="configfile_circos_conf">
    <configfile name="circos_conf"><![CDATA[
<<include colors_fonts_patterns.conf>>
<<include housekeeping.conf>>
karyotype = karyotype.txt

<image>
  <<include etc/image.conf>>
</image>

<<include ticks.conf>>
<<include ideogram.conf>>
<plots>
    <<include 2d.conf>>
    <<include heatmap.conf>>
    <<include plot_highlight.conf>>
</plots>

<<include highlight.conf>>
    ]]></configfile>
  </xml>
  <xml name="configfile_ticks_conf">
    <configfile name="ticks_conf"><![CDATA[
show_ticks          = ${ticks.show_ticks}
show_tick_labels    = yes

<ticks>
    radius           = ${ticks.radius}r
    color            = ${ticks.color}
    thickness        = 2p
    multiplier       = ${ticks.multiplier}

    #for $tick_group in $ticks.tick_group:
    <tick>
        spacing        = ${tick_group.spacing}
        size           = ${tick_group.size}p
        show_label     = ${tick_group.show_tick_labels}
        label_size     = ${tick_group.label_size}p
        label_offset   = ${tick_group.label_offset}p
        format         = ${tick_group.format} kb
        ## TODO: figure out automated tick labels
        ##if ${ticks.multiplier} * ${tick_group.spacing}
    </tick>
    #end for
</ticks>
]]>
    </configfile>
  </xml>
  <xml name="configfile_ideogram_conf">
    <configfile name="ideogram_conf"><![CDATA[

<ideogram>

    <spacing>
        ## spacing between ideograms
        default = ${ideogram.spacing}r
    </spacing>

    # ideogram position, thickness and fill
    radius           = ${ideogram.radius}r
    thickness        = ${ideogram.thickness}p
    fill             = yes

    show_label       = ${ideogram.ideogram_labels.show_label}
    label_radius     = dims(ideogram,radius) + 0.075r
    label_size       = 24
    label_parallel   = ${ideogram.ideogram_labels.parallel}

    show_bands            = yes
    fill_bands            = yes
    band_transparency     = 4

</ideogram>
]]></configfile>
  </xml>
  <xml name="configfile_data_conf">
    <configfile name="data_conf"><![CDATA[
#for $hi, $data in enumerate($sec_tdd.data):
<plot>
    type = ${data.plot_format.plot_format_select}
    file = data/data-${hi}.txt

    r1   = ${data.r1}r
    r0   = ${data.r0}r

    fill_color = ${data.fill_color}
    thickness = ${data.outline}p
    extend_bin = ${data.extend_bins}

    <rules>
    #for $rule in $data.sec_rule.rules:
        <rule>
            #for $condition in $rule.conditions
                #if str($condition.application.application_select) == "1":
                    condition = 1
                #elif str($condition.application.application_select) == "on":
                    #set on_str = ' '.join([ "on(%s)" % $chr.strip() for $chr in $condition.application.on_genomes.split(',') ])
                    condition = $on_str
                #elif str($condition.application.application_select) == "pos":
                    #if $condition.application.pos_gt != 0:
                    condition = var(start) > $condition.application.pos_gt
                    #end if

                    #if $condition.application.pos_lt != 0:
                    condition = var(start) < $condition.application.pos_lt
                    #end if
                #elif str($condition.application.application_select) == "value":
                    #if $condition.application.pos_gt != 0:
                    condition = var(value) > $condition.application.pos_gt
                    #end if

                    #if $condition.application.pos_lt != 0:
                    condition = var(value) < $condition.application.pos_lt
                    #end if
                #elif str($condition.application.application_select) == "var":
                    condition = var(${condition.application.varname}) ${condition.application.cond_select} "${condition.application.varvalue}"
                #end if
            #end for

            #for $action in $rule.actions:
                #set x_fill_color = $action.action.action_value
                #set x_fill_color_count = int(str($x_fill_color).split('-')[1]) + 1
                #set x_fill_color_qw = ' '.join(["%s-%s" % ($action.action.action_value, $i) for i in range(1, $x_fill_color_count)])

                #if str($action.action.action_select) == "fill_color_value":
                    fill_color = eval(qw(${x_fill_color_qw})[remap_int(var(value), ${action.action.min_value}, ${action.action.max_value}, 0, ${x_fill_color_count - 1})])
                #else
                    $action.action.action_select = ${action.action.action_value}
                #end if
            #end for
            $rule.continue_flow
        </rule>
    #end for
    </rules>

</plot>
#end for
    ]]></configfile>
  </xml>
  <xml name="configfile_heatmap_conf">
    <configfile name="heatmap_conf"><![CDATA[
#for $hi, $heatmap in enumerate($sec_heat.heatmaps):
<plot>
    type = heatmap
    file = data/heatmap-${hi}.txt
    r1   = ${heatmap.r1}r
    r0   = ${heatmap.r0}r
    color = ${heatmap.fill_color}
</plot>
#end for
    ]]></configfile>
  </xml>
  <xml name="configfile_plot_highlight_conf">
    <configfile name="plot_highlight_conf"><![CDATA[
#for $hi, $highlight in enumerate($sec_heat.highlights):
    #if $highlight.type_select == "plot_highlights":
<plot>
    type = highlight
    file = data/highlight-${hi}.txt
    r1   = ${highlight.r1}r
    r0   = ${highlight.r0}r
    color = ${highlight.fill_color}
</plot>
    #end if
#end for
    ]]></configfile>
  </xml>
  <xml name="configfile_highlight_conf">
    <configfile name="highlight_conf"><![CDATA[
<highlights>
#for $hi, $highlight in enumerate($sec_heat.highlights):
    #if $highlight.type_select == "normal":
    <highlight>
        file = data/highlight-${hi}.txt
        r1   = ${highlight.r1}r
        r0   = ${highlight.r0}r
        color = ${highlight.fill_color}
    </highlight>
    #end if
#end for
</highlights>
    ]]></configfile>
  </xml>
  <xml name="test_case">
    <configfile name="test_case_conf"><![CDATA[
<!--
mkdir -p test-data/my-test-case/;
cp ${genome_fasta} test-data/my-test-case/input.fa;
#if $ideogram.bands:
cp ${ideogram.bands} test-data/my-test-case/bands.${ideogram.bands.ext};
#end if
<!-- these may not work -->
cp $output_png test-data/my-test-case/output.png;
cp $output_svg test-data/my-test-case/output.svg;
-->
<test>
    <param name="reference_genome_source" value="${reference_genome_source}"/>
    <param name="genome_fasta" value="my-test-case/input.fa" />
    <!-- ideograms -->
    <param name="ideogram|spacing" value="${ideogram.spacing}" />
    <param name="ideogram|radius" value="${ideogram.radius}" />
    <param name="ideogram|thickness" value="${ideogram.thickness}" />
    <param name="ideogram|ideogram_labels|show_label" value="${ideogram.ideogram_labels.show_label}" />
    <param name="ideogram|ideogram_labels|parallel" value="${ideogram.ideogram_labels.parallel}" />
    <param name="ideogram|bands" value="my-test-case/bands.${ideogram.bands.ext}" />
    <!-- Ticks -->

    <param name="ticks|show_ticks" value="${ticks.show_ticks}" />
    <param name="ticks|radius" value="${ticks.radius}" />
    <param name="ticks|color" value="${ticks.color}" />
    <param name="ticks|multiplier" value="${ticks.multiplier}" />

    #for $idx, $tick_group in enumerate($ticks.tick_group):
    <param name="ticks|tick_group_${idx}|tickspacing" value="${tick_group.spacing}" />
    <param name="ticks|tick_group_${idx}|size" value="${tick_group.size}" />
    <param name="ticks|tick_group_${idx}|show_tick_labels" value="${tick_group.show_tick_labels}" />
    <param name="ticks|tick_group_${idx}|label_size" value="${tick_group.label_size}" />
    <param name="ticks|tick_group_${idx}|label_offset" value="${tick_group.label_offset}" />
    <param name="ticks|tick_group_${idx}|label_format" value="${tick_group.format}" />
    #end for


    <output name="output_png" file="my-test-case/output.png" />
    <output name="output_svg" file="my-test-case/output.svg" />
</test>
    ]]></configfile>
  </xml>
</macros>
