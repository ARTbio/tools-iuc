<tool id="circgraph" name="circgraph" version="0.1.0">
<description>for making Circos graphics.</description>
    <requirements>
        <requirement type="package">circgraph</requirement>
        <requirement type="package">Bio</requirement>
        <requirement type="package">BCBio</requirement>
    </requirements>
    <configfiles>
          <configfile name="circtmpxml"><![CDATA[
<image>
    <bcolor>${imgback}</bcolor>
</image>

#for $seq in $base_sequences:
    <ideograms>
    #for $ideogram in $seq.ideograms:
	<ideogram>
        #for $element in $ideogram.items():
            #if $element[0] not in ('source_data','ideogramrules')
            <$element[0]>$element[1]</$element[0]>
            #end if
        #end for

	<plots>

        #for $track in $ideogram.source_data:
	    <plot>
            #for $key in $track.data_type.items():
            <$key[0]>$key[1]</$key[0]>
            #end for

            #for $key in $track.track_opt.items():
            <$key[0]>$key[1]</$key[0]>
            #end for
	    </plot>

	</plots>

	    <rules>	 
 	    #for $rule in $ideogram.ideogramrules:
		    <rule>
		    #for $spec in $rule.items():
			    <$spec[0]>$spec[1]</$spec[0]>
		    #end for
		    </rule>
	    #end for
	    </rules>

        #end for
	</ideogram>
    #end for
    </ideograms>

    <highlights>
    #for $highlight in $seq.highlights:
        <highlight>
        #for $element in $highlight.items():
		#if $element[0] != "highlightrules":
			<$element[0]>$element[1]</$element[0]>
		#end if
		#else:
			<rules>
			#for $rule in $highlight.highlightrules:
				<rule>
				#for $spec in $rule.items():
					<$spec[0]>$spec[1]</$spec[0]>
				#end for
				</rule>
			#end for
			</rules>
        #end for
	</highlight>
    #end for
    </highlights>

    <ticks>   
    #for $tick in $seq.ticks:
	<tick>
        #for $element in $tick.items():
		<$element[0]>$element[1]</$element[0]>
        #end for
	</tick>
    #end for
    </ticks>

    <links>
    #for $link in $seq.links:
	<link>
        #for $element in $link.items():
		#if $element[0] != "linkrules":
			<$element[0]>$element[1]</$element[0]>
		#end if
		#else:
			<rules>
			#for $rule in $link.linkrules:
				<rule>
				#for $spec in $rule.items():
					<$spec[0]>$spec[1]</$spec[0]>
				#end for
				</rule>
			#end for
			</rules>
			
        #end for
	</link>
	
    #end for 
    </links>
#end for
    ]]>
          </configfile>
      </configfiles>
    <command detect_errors="aggressive" ><![CDATA[cp $circtmpxml $Default]]></command>
    <inputs>
    <!-- Pretty sure this is how you set defaults -->
    <param name="imgback" title="Background Color" type="color" value="#ffffff"/>
    <repeat  name="base_sequences" title="Genome" min="1" max="10">
        <repeat name="highlights" title="Highlight">
	    <repeat name="highlightrules" title="Rule">
		<param name="condition" type="text" value="Not yet implemented!" help="Use attribute-specific ad hoc conditioning!">
		</param>
                <param type="data" format="txt" name="HighlightData" />
                <param type="color" value="#ffff00" label="Fill Color" name="hilite_fill" />
                <param type="color" value="#ffff00" label="Stroke Color" name="hilite_stroke" />
                <param type="float" value="0.5" label="Inner Radial Position" name="hilite_r0" />
                <param type="float" value="1" label="Outer Radial Position" name="hilite_r1" />
                <param type="float" value="1" label="Depth" name="hilite_z" />
                <param type="float" value="1" label="Stroke Thickness" name="hilite_stroke_thickness" />
	    </repeat>
            <param type="data" format="txt" name="HighlightData" />
            <param type="color" value="#ffff00" label="Fill Color" name="hilite_fill" />
            <param type="color" value="#ffff00" label="Stroke Color" name="hilite_stroke" />
            <param type="float" value="0.5" label="Inner Radial Position" name="hilite_r0" />
            <param type="float" value="1" label="Outer Radial Position" name="hilite_r1" />
            <param type="float" value="1" label="Depth" name="hilite_z" />
            <param type="float" value="1" label="Stroke Thickness" name="hilite_stroke_thickness" />
        </repeat>
        <repeat name="links" title="Link">
	    <repeat name="linkrules" title="Rule">
		<param name="condition" type="text" value="Not yet implemented!" help="Use attribute-specific ad hoc conditioning!">
	        <param name="link_z" type="float" label="Link Depth" value="1.0" />
	        <param name="link_radius" type="float" label="Link Radius" value="1.0" />
	        <param name="link_crest" type="float" label="Link Crest" value="1.0" />
	        <param name="link_thickness" type="float" label="Link Thickness" value="1.0" />
	        <param name="link_color" type="color" label="Link Color" value="#00ff00" />
		</param>
	    </repeat>
	    <param name="link_z" type="float" label="Link Depth" value="1.0" />
	    <param name="link_radius" type="float" label="Link Radius" value="1.0" />
	    <param name="link_crest" type="float" label="Link Crest" value="1.0" />
	    <param name="link_file" type="data" format="txt" />
	    <param name="link_thickness" type="float" label="Link Thickness" value="1.0" />
	    <param name="link_color" type="color" label="Link Color" value="#00ff00" />
	    <param name="link_record_limit" type="integer" label="Record Limit" value="1000000" />
        </repeat>
        <repeat name="ticks" title="Tick">
            <param type="text" value="Chr1;Chr2" label="Chromosomes" name="tick_chromosomes" />
            <param type="color"  value="#000000" label="Color" name="tick_color" />
            <param type="boolean" checked="true" label="Force Display?" name="tick_force_display" />
            <param type="text" value="%.2f" label="Format" name="tick_format" />
            <param type="boolean" checked="true" label="Grid?" name="tick_grid" />
            <param type="color"  value="#000000" label="Grid Color" name="tick_grid_color" />
            <param type="float" value="1" label="Grid Start" name="tick_grid_start" />
            <param type="float" value="2" label="Grid End" name="tick_grid_end" />
            <param type="float" value="1" label="Grid Thickness" name="tick_grid_thickness" />
            <param type="boolean" checked="true" label="Label?" name="tick_label" />
            <param type="color"  value="#000000" label="Label Color" name="tick_label_color" />
            <param type="float" value="1" label="Label Relative" name="tick_label_relative" />
            <param type="float" value="1" label="Label Separation" name="tick_label_separation" />
            <param type="float" value="1" label="Label Size" name="tick_label_size" />
            <param type="float" value="1" label="Minimum Distance to Edge" name="tick_min_distance_to_edge" />
            <param type="float" value="1" label="Minimum Label Distance to Edge" name="tick_min_label_distance_to_edge" />
            <param type="text" value="0p" label="Offset" name="tick_offset" />
            <param type="float" value="1" label="Position" name="tick_position" />
            <param type="text" value="Not Yet Implemented!" label="Prefix" name="tick_prefix" />
            <param type="float" value="1" label="Radius" name="tick_radius" />
            <param type="boolean" checked="true" label="Show Label?" name="tick_show_label" />
            <param type="float" value="1" label="Size" name="tick_size" />
            <param type="boolean" checked="false" label="Skip First Label?" name="tick_skip_first_label" />
            <param type="boolean" checked="false" label="Skip Last Label?" name="tick_skip_last_label" />
            <param type="float" value="1" label="Thickness" name="tick_thickness" />
            <param type="float" value="1" label="Thousands Separation" name="tick_thousands_sep" />
            <param type="float" value="1" label="Tick Separation" name="tick_separation" />
        </repeat>
        <repeat  name="ideograms" title="Ideogram" min="1" max="10">
	    <repeat name="ideogramrules" title="Rule">
		<param name="condition" type="text" value="Not yet implemented!" help="Use attribute-specific ad hoc conditioning!">
		</param>
                <param type="color"  value="#0000ff" label="Band Color" name="band_stroke_color"/>
                <param type="float" value="1" label="Band Thickness" name="band_stroke_thickness">
                </param>
                <param type="float" value="1" label="Band Transparency" name="band_stroke_transparency">
                </param>
                <param type="boolean" checked="true" label="Fill?" name="ideo_fill" />
                <param type="boolean" checked="false" label="Fill with bands?" name="ideo_fill_bands" />
                <param type="color"  value="#ff00ff" label="Fill Color" name="ideo_fill_color" />
                <param type="select" label="Label Case" name="ideo_label_case" >
                    <option value="Lower" selected="True">lower case</option>
                    <option value="Upper">Upper Case</option>
                </param>
                <param type="boolean" checked="true" label="Center Label?" name="ideo_label_center" />
                <param type="select" label="Label Font" name="ideo_label_font" >
                    <option value="Times New Roman" selected="True"> Red </option>
                </param>
                <param type="select" label="Label Format" name="ideo_label_format" >
                    <option value="TODO" selected="True"> Red </option>
                    </param>
                <param type="boolean" checked="true" label="Labels Parallel?" name="ideo_label_parallel" />
                <param type="float" value="1" label="Label Radius" name="ideo_label_radius" />
                <param type="float" value="1" label="Label Size" name="ideo_label_size" />
                <param type="boolean" checked="false" label="Label with tag?" name="ideo_tag_label_with_tag" />
                <param type="float" value="1" label="Radius" name="ideo_radius" />
                <param type="float" value="1" label="Stroke Thickness" name="ideo_stroke_thickness" />
                <param type="color"  value="#000000" label="Stroke Color" name="ideo_stroke_color" />
                <param type="float" value="1" label="Thickness" name="ideo_thickness" />
	    </repeat>
            <param name="idname" type="text" value="Ideogram1" help="Create a distinct Circos ideogram"/>
            <param type="color"  value="#0000ff" label="Band Color" name="band_stroke_color"/>
            <param type="float" value="1" label="Band Thickness" name="band_stroke_thickness">
            </param>
            <param type="float" value="1" label="Band Transparency" name="band_stroke_transparency">
            </param>
            <param type="boolean" checked="true" label="Fill?" name="ideo_fill" />
            <param type="boolean" checked="false" label="Fill with bands?" name="ideo_fill_bands" />
            <param type="color"  value="#ff00ff" label="Fill Color" name="ideo_fill_color" />
            <param type="select" label="Label Case" name="ideo_label_case" >
                <option value="Lower" selected="True">lower case</option>
                <option value="Upper">Upper Case</option>
            </param>
            <param type="boolean" checked="true" label="Center Label?" name="ideo_label_center" />
            <param type="select" label="Label Font" name="ideo_label_font" >
                <option value="Times New Roman" selected="True"> Red </option>
            </param>
            <param type="select" label="Label Format" name="ideo_label_format" >
                <option value="TODO" selected="True"> Red </option>
            </param>
            <param type="boolean" checked="true" label="Labels Parallel?" name="ideo_label_parallel" />
            <param type="float" value="1" label="Label Radius" name="ideo_label_radius" />
            <param type="float" value="1" label="Label Size" name="ideo_label_size" />
            <param type="boolean" checked="false" label="Label with tag?" name="ideo_tag_label_with_tag" />
            <param type="float" value="1" label="Radius" name="ideo_radius" />
            <param type="float" value="1" label="Stroke Thickness" name="ideo_stroke_thickness" />
            <param type="color"  value="#000000" label="Stroke Color" name="ideo_stroke_color" />
            <param type="float" value="1" label="Thickness" name="ideo_thickness" />
            <repeat name="source_data" title="Data Tracks">
                <conditional name="data_type" label="Data Type Selection">
                    <param type="select" label="Data Type" name="datatype">
                        <option value="gff3" selected="True"> gff3 </option>
                        <option value="wig"> wig </option>
                        <option value="fasta"> fasta </option>
                    </param>
                    <when value="gff3">
                        <param type="data" name="gff3" format="gff3"/>
                    </when>
                    <when value="wig">
                        <param type="data" name="wig" format="wig"/>
                    </when>
                    <when value="fasta">
                        <param type="data" name="fasta" format="fa"/>
                    </when>
                </conditional>
                <conditional name="track_opt" label="Track Selection">
                    <param type="select" label="Track Type" name="tracktype">
                        <option value="Scatterplot" selected="True">Scatterplot</option>
                        <option value="Heatmap">Heatmap</option>
                        <option value="Histogram">Histogram</option>
                    </param>
                    <when value="Heatmap">
                        <param label="Colorscheme" type="select" name="color">
                            <option value="Brewer1" selected="True">Brewer Palette 1</option>
                            <option value="Brewer2">Brewer Palette 2</option>
                            <option value="Brewer3">Brewer Palette 3</option>
                        </param>
                    </when>
                    <when value="Scatterplot"> </when>
                    <when value="Histogram">
                        <param label="Color"  value="#00ff00" type="color" name="color"/>
                    </when>
                </conditional>
            </repeat>
        </repeat>
    </repeat>
    </inputs>
    <outputs>
    <data format="txt" name="Default" label="PreCircos Datadump"/>
    </outputs>
    <help><![CDATA[
Circos Graphic
==============

Work in progress...
    ]]></help>
</tool>
