<?xml version="1.0"?>
<tool id="circgraph" name="Circos Builder" version="@WRAPPER_VERSION@">
  <description>for preparing circos configuration from standard datatypes.</description>
  <macros>
    <import>macros.xml</import>
    <import>macros_conffiles.xml</import>
  </macros>
  <expand macro="requirements"/>
  <expand macro="stdio"/>
  <configfiles>
    <expand macro="configfile_circos_conf" />
    <expand macro="configfile_ticks_conf" />
    <expand macro="configfile_ideogram_conf" />
    <configfile name="circos_xml"><![CDATA[
<root>
</root>
    ]]></configfile>
  </configfiles>
  <command detect_errors="aggressive"><![CDATA[
    ## Directory structure
    mkdir -p circos/conf/ circos/data/;

    #if $reference_genome.reference_genome_source == 'history':
        ln -s $reference_genome.genome_fasta genomeref.fa;
    #end if

    ## Process the karyotype.txt file
    python $__tool_directory__/fasta-to-karyotype.py

        #if str($reference_genome.reference_genome_source) == 'cached':
            "${reference_genome.fasta_indexes.fields.path}"
        #else if str($reference_genome.reference_genome_source) == 'history':
            genomeref.fa
        #end if

        #if ${ideogram.bands}:
            "${ideogram.bands}"
        #end if

    > circos/conf/karyotype.txt;

    mv $circos_conf circos/conf/circos.conf;
    mv $ticks_conf circos/conf/ticks.conf;
    mv $ideogram_conf circos/conf/ideogram.conf;

    cp $circos_xml circos/conf/galaxy.xml;
    ## Compile image
    docker run -it -v \$(pwd)/circos:/input circos;

    cp circos/circos.png $output_png;
    cp circos/circos.svg $output_svg;
]]></command>
  <inputs>
    <conditional name="reference_genome">
        <param name="reference_genome_source" type="select" label="Reference Genome">
            <option value="history" selected="True">From History</option>
            <option value="cached">Locally Cached</option>
        </param>
        <when value="cached">
            <param name="fasta_indexes" type="select" label="Source FASTA Sequence">
                <options from_data_table="all_fasta"/>
            </param>
        </when>
        <when value="history">
            <param name="genome_fasta" type="data" format="fasta" label="Source FASTA Sequence"/>
        </when>
    </conditional>
    <param name="karyotype" title="Genomes" type="data" format="fasta"/>

    <section name="ideogram" title="Ideogram Configuration (Genome/Chromosomes)">
        <param type="float" value="0.005" label="Spacing Between Ideograms" name="spacing"/>

        <param type="float" value="0.90" label="Radius" name="radius"/>
        <param type="float" value="10" label="Thickness" name="thickness"/>

        <section name="ideogram_labels" title="Labels">
            <param type="boolean" label="Show Label" name="show_label" truevalue="yes" falsevalue="no" />
            <!--<param type="float" value="0.95" label="Radius" name="radius"/>-->
            <!--<param type="float" value="10" label="Thickness" name="thickness"/>-->
            <param type="boolean" label="Parallel" name="parallel" truevalue="yes" falsevalue="no" />
        </section>
        <!-- TODO: multiple band files? -->
        <param type="data" title="Cytogenetic Bands" format="bed6,bed12,gff3" name="bands"
            help="If defined, will display cytogenetic bands as part of the karyotype configuration" optional="true"/>
    </section>

    <section name="ticks" title="Ticks">
        <param type="boolean" label="Show Ticks" name="show_ticks" truevalue="yes" falsevalue="no" />
        <!--<param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="true" falsevalue="false" />-->
        <param type="float" value="1.0" label="Radius" name="radius" />
        <param type="color" value="#000000" label="Color" name="color" />
        <param type="float" value="1e-6" label="Multiplier" name="multiplier" />

        <repeat name="tick_group" title="Tick Group">
            <param type="float" value="5000" label="Tick Spacing" name="spacing" help="Number of bases" />
            <param type="float" value="10" label="Tick Size" name="size" />

            <param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="yes" falsevalue="no" />
            <param type="float" value="20" label="Label Size" name="label_size" />
            <param type="float" value="10" label="Label Offset" name="label_offset" />
            <param type="select" label="Label Format" name="format">
                <option value="%d" selected="True">Integer</option>
                <option value="%f">Float</option>
                <option value="%.1f">Float (one decimal)</option>
                <option value="%.2f">Float (two decimals)</option>
            </param>
        </repeat>

    </section>

  </inputs>
  <outputs>
    <data format="png" name="output_png" label="Circos Plot (png)"/>
    <data format="svg" name="output_svg" label="Circos Plot (svg)"/>
  </outputs>
  <help><![CDATA[
Circos
======

]]></help>
</tool>
