<?xml version="1.0"?>
<tool id="circgraph" name="Circos Configurator" version="0.1.0">
  <description>for preparing circos configuration from standard datatypes.</description>
  <configfiles>
    <configfile name="ticks_conf"><![CDATA[
show_ticks          = ${ticks.show_ticks}
show_tick_labels    = yes

<ticks>
    radius           = ${ticks.radius}r
    color            = ${ticks.color}
    thickness        = 2p
    multiplier       = ${ticks.multiplier}

    #for $tick_group in $ticks.tick_group:
    <tick>
        spacing        = ${tick_group.spacing}
        size           = ${tick_group.size}p
        show_label     = ${tick_group.show_tick_labels}
        label_size     = ${tick_group.label_size}p
        label_offset   = ${tick_group.label_offset}p
        format         = ${tick_group.format} kb
        ## TODO: figure out automated tick labels
        ##if ${ticks.multiplier} * ${tick_group.spacing}
    </tick>
    #end for
</ticks>
]]>
    </configfile>
    <configfile name="circos_xml"><![CDATA[
<root>
</root>
    ]]></configfile>
  </configfiles>
  <command detect_errors="aggressive"><![CDATA[
    ## Directory structure
    mkdir -p circos/conf/ circos/data/;

    ## Process the karyotype.txt file
    python $__tool_directory__/fasta-to-karyotype.py $karyotype > circos/conf/karyotype.txt;

    cp $circos_xml circos/conf/galaxy.xml;
    mv $ticks_conf circos/conf/ticks.conf;

    ## Compile image
    docker run -it -v \$(pwd)/circos:/input circos;

    cp circos/circos.png $output_png;
    cp circos/circos.svg $output_svg;
]]></command>
  <inputs>
    <!-- Pretty sure this is how you set defaults -->
    <param name="karyotype" title="Genomes" type="data" format="fasta"/>

    <section name="ideogram_labels" title="Genome Labels (Ideogram Labels)">
        <param type="float" value="0.90" label="Radius" name="radius"/>
        <param type="float" value="20" label="Thickness" name="thickness"/>
        <param type="boolean" label="Fill" name="fill" truevalue="True" falsevalue="False" />
        <param type="boolean" label="Show Label" name="show_label" truevalue="True" falsevalue="False" />
    </section>

    <section name="ticks" title="Ticks">
        <param type="boolean" label="Show Ticks" name="show_ticks" truevalue="true" falsevalue="false" />
        <!--<param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="true" falsevalue="false" />-->
        <param type="float" value="1.0" label="Radius" name="radius" />
        <param type="color" value="#000000" label="Color" name="color" />
        <param type="float" value="1e-6" label="Multiplier" name="multiplier" />

        <repeat name="tick_group" title="Tick Group">
            <param type="float" value="5000" label="Tick Spacing" name="spacing" help="Number of bases" />
            <param type="float" value="10" label="Tick Size" name="size" />

            <param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="true" falsevalue="false" />
            <param type="float" value="20" label="Label Size" name="label_size" />
            <param type="float" value="10" label="Label Offset" name="label_offset" />
            <param type="select" label="Label Format" name="format">
                <option value="%d" selected="True">Integer</option>
                <option value="%f">Float</option>
                <option value="%.1f">Float (one decimal)</option>
                <option value="%.2f">Float (two decimals)</option>
            </param>
        </repeat>

    </section>

  </inputs>
  <outputs>
    <data format="png" name="output_png" label="Circos Plot (png)"/>
    <data format="svg" name="output_svg" label="Circos Plot (svg)"/>
  </outputs>
  <help><![CDATA[
Circos
======

]]></help>
</tool>
