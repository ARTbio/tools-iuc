<?xml version="1.0"?>
<tool id="circgraph" name="Circos Configurator" version="0.1.0">
  <description>for preparing circos configuration from standard datatypes.</description>
  <configfiles>
    <configfile name="ticks"><![CDATA[
show_ticks          = ${ticks.show_ticks}
show_tick_labels    = ${ticks.show_tick_labels}

<ticks>
    radius           = ${ticks.radius}r
    color            = ${ticks.color}
    thickness        = 2p

    # the tick label is derived by multiplying the tick position
    # by 'multiplier' and casting it in 'format':
    #
    # sprintf(format,position*multiplier)
    #

    multiplier       = ${ticks.multiplier}

    # %d   - integer
    # %f   - float
    # %.1f - float with one decimal
    # %.2f - float with two decimals
    #
    # for other formats, see http://perldoc.perl.org/functions/sprintf.html

    format           = ${ticks.format}

    #for $tick_group in $ticks.tick_group:
    <tick>
        spacing        = ${tick_group.spacing}
        size           = ${tick_group.size}p
        show_label     = ${tick_group.show_tick_labels}
        label_size     = ${tick_group.label_size}p
        label_offset   = ${tick_group.label_offset}p
        format         = %d
    </tick>
    #end for

    <tick>
    spacing        = 5u
    size           = 10p
    </tick>

    <tick>
    spacing        = 25u
    size           = 15p
    show_label     = yes
    label_size     = 20p
    label_offset   = 10p
    format         = %d
    </tick>
</ticks>
]]>
    </configfile>
    <configfile name="circos_xml"><![CDATA[
<root>
    <image>
        <bcolor>${imgback}</bcolor>
    </image>
    <karyotype>
        <file>${karyotype}</file>
    </karyotype>

#for $seq in $base_sequences:
    #for $ideogram in $seq.ideograms:
    <ideogram>
        #for $element in $ideogram.items():
            #if $element[0] not in ('source_data','ideogramrules')
            <$element[0]>$element[1]</$element[0]>
            #end if
        #end for


        #for $track in $ideogram.source_data:
        <plot>
        #for $element in $track.items():
            #if $element[0] not in ('source_data','ideogramrules','data_type','track_opt')
            <$element[0]>$element[1]</$element[0]>
            #end if
        #end for
            #for $key in $track.data_type.items():
            <$key[0]>$key[1]</$key[0]>
            #end for

            #for $key in $track.track_opt.items():
            <$key[0]>$key[1]</$key[0]>
            #end for
        </plot>


         #for $rule in $ideogram.ideogramrules:
            <rule>
            #for $spec in $rule.items():
                <$spec[0]>$spec[1]</$spec[0]>
            #end for
            </rule>
        #end for

        #end for
    </ideogram>
    #end for

    #for $highlight in $seq.highlights:
        <highlight>
        #for $element in $highlight.items():
        #if $element[0] != "highlightrules":
            <$element[0]>$element[1]</$element[0]>
        #end if
        #else:
            <rules>
            #for $rule in $highlight.highlightrules:
                <rule>
                #for $spec in $rule.items():
                    <$spec[0]>$spec[1]</$spec[0]>
                #end for
                </rule>
            #end for
            </rules>
        #end for
    </highlight>
    #end for

    #for $tick in $seq.ticks:
    <tick>
        #for $element in $tick.items():
        <$element[0]>$element[1]</$element[0]>
        #end for
    </tick>
    #end for

    #for $link in $seq.links:
    <link>
        #for $element in $link.items():
        #if $element[0] != "linkrules":
            <$element[0]>$element[1]</$element[0]>
        #end if
        #else:
            <rules>
            #for $rule in $link.linkrules:
                <rule>
                #for $spec in $rule.items():
                    <$spec[0]>$spec[1]</$spec[0]>
                #end for
                </rule>
            #end for
            </rules>

        #end for
    </link>

    #end for
#end for
</root>
    ]]></configfile>
  </configfiles>
  <command detect_errors="aggressive"><![CDATA[
    ## Directory structure
    mkdir -p circos/conf/ circos/data/;

    ## Process the karyotype.txt file
    python $__tool_directory__/fasta-to-karyotype.py $karyotype > circos/conf/karyotype.txt;


      cp $conf $Default
]]></command>
  <inputs>
    <!-- Pretty sure this is how you set defaults -->
    <param name="karyotype" title="Genomes" type="data" format="fasta"/>

    <section name="ideogram_labels" title="Genome Labels (Ideogram Labels)">
        <param type="float" value="0.90" label="Radius" name="radius"/>
        <param type="float" value="20" label="Thickness" name="thickness"/>
        <param type="boolean" label="Fill" name="fill" truevalue="True" falsevalue="False" />
        <param type="boolean" label="Show Label" name="show_label" truevalue="True" falsevalue="False" />
    </section>

    <section name="ticks" title="Ticks">
        <param type="boolean" label="Show Ticks" name="show_ticks" truevalue="true" falsevalue="false" />
        <!--<param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="true" falsevalue="false" />-->
        <param type="float" value="1.0" label="Radius" name="radius" />
        <param type="color" value="#000000" label="Color" name="color" />
        <param type="float" value="1e-6" label="Multiplier" name="multiplier" />

        <repeat name="tick_group" title="Tick Group">
            <param type="float" value="5000" label="Tick Spacing" name="spacing" help="Number of bases" />
            <param type="float" value="10" label="Tick Size" name="size" />

            <param type="boolean" label="Show Tick Labels" name="show_tick_labels" truevalue="true" falsevalue="false" />
            <param type="float" value="20" label="Label Size" name="label_size" />
            <param type="float" value="10" label="Label Offset" name="label_offset" />
            <param type="select" label="Label Format" name="format">
                <option value="%d" selected="True">Integer</option>
                <option value="%f">Float</option>
                <option value="%.1f">Float (one decimal)</option>
                <option value="%.2f">Float (two decimals)</option>
            </param>
        </repeat>

    </section>

  </inputs>
  <outputs>
    <data format="txt" name="Default" label="PreCircos Datadump"/>
  </outputs>
  <help><![CDATA[
Circos
======

]]></help>
</tool>
