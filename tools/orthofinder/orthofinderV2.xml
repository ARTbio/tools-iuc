<tool name="OrthoFinder" id="orthofinder" version="1.0">

	<!-- WORK IN PROGRESS : quite messy for now -->
	<!-- Many parameters are incompatible and cannot be used one-another. many conditional statemetns are required -->

	<description>
		OrthoFinder finds orthogroups in a set of proteomes, then infers orthologues and gene trees.
	</description>	

	<requirements>
		<requirement type="package" version="2.7">python</requirement>		
		<requirement type="package" version="1.1.4">orthofinder</requirement>
	</requirements>
	
  	<command>
	<![CDATA[		
		#set $infiles = ""
        #for $input in $inputs
            ln -s $input $input.element_identifier;
            #set $infiles = $infiles + $input.element_identifier + ","
        #end for
        #set $infiles = $infiles[:-1]        	
		
		orthofinder

        #if $init.start=="fasta": 
            -f . -I ${init.inflation}
        #elif $init.start=="blast":
            -f $infiles -I ${init.inflation}
        #elif  $init.start=="groups":
            -fg $infiles
        #elif $init.start=="trees":
            -ft $infiles
        #end if

        #if $end=="onlyblast":
            -b
        #elif $end=="onlygroups":
            -og  
        #end if      	

        -t \${GALAXY_SLOTS:-1} -a \${GALAXY_SLOTS:-1}

        >> ${outputlog}
        
        &&
		mv Results_* results
        >> ${outputlog}
        #if $end=="all":
		    mv results/Orthologues_* results/orthologues
        #end if
        >> ${outputlog};
	]]>	
  	</command>

 	<inputs>
		<!-- Control where Orthofinder starts - only one must be selected -->
        <conditional name="init" >
            <param name="start" type="select" label="Control where Orthofinder starts" help="OrthoFinder works in several steps ; if you have the corresponding files, you can choose to start the tool at a given point. WARNING : be sure the start and stop options are compatible." >
                <option value="fasta" selected="true">From fasta proteomes</option>
                <option value="blast" >From blast results</option>
                <option value="groups">From orthogroups</option>
                <option value="trees">From trees</option>
            </param>

            <when value="fasta">
                <param name="inflation" type="float" value="1.5" label="Inflation parameter" help="Modify inflation parameter for MCL. Not recommended. [Default : 1.5]" />
            </when>
        </conditional>

        <!-- input file choice -->        
        <param name="inputs" type="data" multiple="true" label="Choose input files (according to the step where Ortofinder starts)" help="See help section for further informations." /> 

        <!-- Control where OrthoFinder stops - Only one must be selected -->        
        <param name="end" type="select" label="Control where Orthofinder stops" help="OrthoFinder works in several steps ; you can choose to retrieve only the results of a given step. WARNING : be sure the start and stop options are compatible." >
            <option value="onlyblast">Only generates blast commands</option>
            <option value="onlygroups">Only infers orthogroups</option>
            <option value="all" selected="true">Run Orthofinder until the end for genes trees and orthologues infering</option>
        </param>		
		
		<!-- Parameter not yet implemented	 
		<param name="rootedSpeciesTree" type="select" label=" Use rootedSpeciesTree for gene-tree/species-tree reconciliation (i.e. orthologue inference)." >
			<option value="no">No</option>
			<option value="yes">Yes</option>			
		</param>
		-->
	</inputs>

	<outputs>
        <data format="txt" name="outputlog" label="log"/>
        <data format="txt" name="blastcmds" label="blast_commands" >
            <filter>end=="onlyblast" and init['start']=="fasta"</filter>            
        </data>

        <!-- Orthogroups outputs -->
		<data format="txt" name="orthogroups1" label="Orthogroups.txt" from_work_dir="results/Orthogroups.txt">
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>
		<data format="csv" name="orthogroups2" label="Orthogroups.csv" from_work_dir="results/Orthogroups.csv">
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>
		<data format="csv" name="specs_overlap" label="Orthogroups_SpeciesOverlaps.csv" from_work_dir="results/Orthogroups_SpeciesOverlaps.csv" >
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>			
		<data format="csv" name="unassigned_genes" label="Orthogroups_UnassignedGenes.csv" from_work_dir="results/Orthogroups_UnassignedGenes.csv" >
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>			
		<data format="csv" name="stat_overall" label="Statistics_Overall.csv" from_work_dir="results/Statistics_Overall.csv" >
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>			
		<data format="csv" name="stat_specs" label="Statistics_PerSpecies.csv" from_work_dir="results/Statistics_PerSpecies.csv" >
            <filter>end!="onlyblast" and (init['start']=="fasta" or init['start']=="blast")</filter>
        </data>

        <!-- outputs for genes trees and orthologous -->
        <!--		
        <collection name="results" type="list" label="trees_and_orthologues">
            <discover_datasets pattern="__name_and_ext__" directory="results/orthologues" />            
            <filter>end="all"</filter>
        </collection>
        -->
	</outputs>

	<tests>
		<test>
            <param name="start" value="fasta" />
			<param name="inputs" ftype="fasta" value="inputs/Mycoplasma_agalactiae.faa,inputs/Mycoplasma_gallisepticum.faa,inputs/Mycoplasma_genitalium.faa,inputs/Mycoplasma_genitalium.faa" />            
            <param name="end" value="onlygroups" />
			<output name="orthogroups1" value="Orthogroups.txt" />
            <output name="orthogroups2" value="Orthogroups.csv" />
            <output name="stat_overall" value="Statistics_Overall.csv" />
            <output name="stat_specs" value="Statistics_PerSpecies.csv" />	
		</test>
	</tests>	

	<help>
===========
OrthoFinder
===========

Full readme at https://github.com/davidemms/OrthoFinder/blob/master/README.md

| .. class:: warningmark

Be sure to choose compatible options ! 

if you have already ran OrthoFinder, the tool allows to re-run the analysis from one of the intermediate steps. In such a case, the input files must be adapted :

| .. class:: infomark

Input files choice:
    - when using "from fasta" option (default) : the input files are a set of proteomes in fasta format (on file per species). Choose this option if you have no OrthoFinder results yet.
    - when using "from blast results" option : the input files are all the files from the working directory of a previous OrthoFinder run.
    - when using "from groups" option : the input files are all the files from the directory containing the results of a previous OrthoFinder run, e.g "Results_MonthDay/".
    - when using "from trees" option : the input files are all the files from the Results_MonthDay/Orthologues_Month_Day/ directory.

| .. class:: infomark

Incompatible options:
    - Obviously, you cannot mix every start and end options : the starting step must be a step occuring before the stoping step.
    - A user's mistake will cause a crash of the tool.

	</help>

	<citations>
		<citation type="bibtex">https://github.com/davidemms/OrthoFinder</citation>
		<citation type="bibtex">Emms, D.M. and Kelly, S. (2015) OrthoFinder: solving fundamental biases in whole genome comparisons dramatically improves orthogroup inference accuracy, Genome Biology 16:157</citation>		
	</citations>

</tool>
