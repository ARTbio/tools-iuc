<tool name="OrthoFinder_Part1" id="orthofinderp1" version="1.0">

    <!-- WORK IN PROGRESS -->
    <!-- Many parameters are incompatible and cannot be used one-another -->

    <!-- According to the selected options, the "Results_MonthDay" directory is sometimes created, sometimes not.
    Same thing for the Orthologues_MonthDay directory : sometimes created as a subfile of Results_MonthDay, sometimes not,
    and other times not created at all. Thus, output files can have different paths. I had to write several if and elif 
    statements in the command to deal with that -->

    <description>
        OrthoFinder finds orthogroups in a set of proteomes, then infers orthologues and gene trees.
    </description>  

    <requirements>
        <requirement type="package" version="2.7">python</requirement>      
        <requirement type="package" version="1.1.4">orthofinder</requirement>
    </requirements>
    
    <command>
    <![CDATA[       
        #set $infiles = ""
        #for $input in $inputs
            ln -s $input $input.element_identifier;
            #set $infiles = $infiles + $input.element_identifier + ","
        #end for
        #set $infiles = $infiles[:-1]        

        orthofinder
        #if $start=="fasta": 
            -f . -I ${inflation}
        #elif $start=="blast":
            -b . -I ${inflation}
        #end if      

        #if $end=="onlyblast":
            -op
        #elif $end=="dogroups":
            -og  
        #end if        

        -t \${GALAXY_SLOTS:-1} -a \${GALAXY_SLOTS:-1}

        > ${outputlog}
        
        &&
        #if $start=="fasta":
            #if $end=="dogroups":
                mv Results_* results
                &&
                mkdir results/tabfiles
                &&
                cp results/*.csv results/tabfiles/
            #end if
        #elif $start=="blast":
            mkdir results
            mkdir results/tabfiles
            &&
            cp *.csv results/tabfiles/
            &&
            cp Orthogroups.txt results/
        #end if

        >> ${outputlog};
    ]]> 
    </command>

    <inputs>
        <!-- Control where Orthofinder starts -->        
        <param name="start" type="select" label="Control where Orthofinder starts" help="OrthoFinder works in several steps ; if you have the corresponding files, you can choose to start the tool at a given point. WARNING : be sure the start and stop options are compatible." >
            <option value="fasta" selected="true">From fasta proteomes</option>
            <option value="blast" >From blast results</option>                
        </param>            
        <param name="inflation" type="float" value="1.5" label="Inflation parameter" help="Modify inflation parameter for MCL. Not recommended. [Default : 1.5]" /> 

        <!-- input file choice -->        
        <param name="inputs" type="data" multiple="true" label="Choose input files (according to the step where Ortofinder starts)" help="See help section for further informations." />        

        <!-- Control where OrthoFinder stops - Only one must be selected -->        
        <param name="end" type="select" label="Control where Orthofinder_part1 stops" help="OrthoFinder works in several steps ; you can choose to retrieve only the results of a given step. WARNING : be sure the start and stop options are compatible." >
            <option value="onlyblast">Only generates blast commands (in the log output)</option>
            <option value="dogroups" selected="true">Infers orthogroups</option>            
        </param>    
        
    </inputs>

    <outputs>
        <!-- log and output for blast commands -->
        <data format="txt" name="outputlog" label="log_orthofinder_part1"/>        

        <!-- Orthogroups outputs -->        
        <data format="txt" name="orthogroups" label="Orthogroups.txt" from_work_dir="results/Orthogroups.txt">
            <filter>end=="dogroups"</filter>
        </data>
        <collection name="ogroups" type="list" label="Orthogroups_Stats">
            <discover_datasets pattern="__name_and_ext__" directory="results/tabfiles" />            
            <filter>end=="dogroups"</filter>
        </collection>
        
        <!-- Output to get the working directory -->        
        <collection name="wd" type="list" label="Working_directory">
            <discover_datasets pattern="__name_and_ext__" directory="results/WorkingDirectory" />
            <filter>start=="fasta" and end=="dogroups"</filter>
        </collection>
        
    </outputs>

    <tests>
        <test>
            <param name="start" value="fasta" />
            <param name="inputs" ftype="fasta" value="inputs/Mycoplasma_agalactiae.faa,inputs/Mycoplasma_gallisepticum.faa,inputs/Mycoplasma_genitalium.faa,inputs/Mycoplasma_genitalium.faa" />            
            <param name="end" value="dogroups" />
            <output name="orthogroups" value="results/Orthogroups.txt" />
            <output name="outputlog" value="log_test.txt" />
            <output name="stat_overall" value="Statistics_Overall.csv" />
            <output name="stat_specs" value="Statistics_PerSpecies.csv" />  
        </test>
    </tests>    

    <help>
===========
OrthoFinder
===========

Full readme at https://github.com/davidemms/OrthoFinder/blob/master/README.md
Summary sketch at https://github.com/davidemms/OrthoFinder/blob/master/OrthoFinder-options.pdf

.. class:: warningmark

Be sure to choose compatible options ! 

If you have already ran OrthoFinder, the tool allows to re-run the analysis from one of the intermediate steps. In such a case, the input files must be adapted :

.. class:: infomark

Input files choice:
    - when using "from fasta" option (default) : the input files are a set of proteomes in fasta format (on file per species). Choose this option if you have no OrthoFinder results yet.
    - when using "from blast results" option : the input files are all the files from the Results_MonthDay/WorkingDirectory/ directory of a previous OrthoFinder run.
    - when using "from groups" option : the input files are :
        1) The "Orthogroups*" and "Statistics*" .txt and .csv files from the directory containing the results of a previous OrthoFinder run, e.g "Results_MonthDay/" 
        2) The working directory.
    - when using "from trees" option : the input files are all the files from the Results_MonthDay/Orthologues_Month_Day/ directory.

.. class:: infomark

Incompatible options:
    - Obviously, you cannot mix every start and end options : the starting step must be a step occuring before the stoping step.
    - A user's mistake will cause a crash of the tool.

    </help>

    <citations>
        <citation type="bibtex">https://github.com/davidemms/OrthoFinder</citation>
        <citation type="bibtex">Emms, D.M. and Kelly, S. (2015) OrthoFinder: solving fundamental biases in whole genome comparisons dramatically improves orthogroup inference accuracy, Genome Biology 16:157</citation>   
        <citation type="bibtex">Galaxy integration : Victor Mataigne and ABiMS Team (Roscoff Marine Station) </citation>
    </citations>

</tool>
