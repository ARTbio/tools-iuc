<tool name="OrthoFinder_from_groups" id="orthofinder_fg" version="1.1.4">

	<!-- WORK IN PROGRESS -->
	
	<description>
		Infers orthologues and gene trees from orthogroups infered by Orthofinder_only_group.
	</description>	

	<requirements>		
		<requirement type="package" version="1.1.4">orthofinder</requirement>
	</requirements>
	
  	<command>
	<![CDATA[
        #if $init.start=="fromgroups":
    		#set $infiles_ortho = ""
            #for $input in $init.input_ortho
                ln -s $input $input.element_identifier;
                #set $infiles_ortho = $infiles_ortho + $input.element_identifier + ","
            #end for
            #set $infiles_ortho = $infiles_ortho[:-1]
        
        #elif $init.start=="fromtrees":
            #set $infiles_trees = ""
            #for $input in $init.input_trees
                ln -s $input $input.element_identifier;
                #set $infiles_trees = $infiles_trees + $input.element_identifier + ","
            #end for
            #set $infiles_trees = $infiles_trees[:-1]
        #end if

		orthofinder        
        #if  $init.start=="fromgroups":
            -fg .
        #elif $init.start=="fromtrees":
            -ft .
        #end if

        #if $end=="onlytrees":
            -ot        
        #end if

        #if $usetree.yestree=="yes":
            -s ${usertree}
        #end if

        -t \${GALAXY_SLOTS:-1} -a \${GALAXY_SLOTS:-1}       
        
        &&
        mv Results_* results;
        mv results/Orthologues_* results/orthologues;        
	]]>	
  	</command>

 	<inputs>
		<!-- Control where Orthofinder starts - only one must be selected -->
        <conditional name="init" >
            <param name="start" type="select" label="Orthofinder starting point" help="OrthoFinder_from_groups works 2 steps. Choose 'From orthogroups' if you only have results from Orthofinder only_groups and 'From trees' if you already ran Orthofinder_from_groups and kept the genes_trees collection" >                
                <option value="fromgroups" selected="true">From orthogroups</option>
                <option value="fromtrees">From trees</option>
            </param>
            <when value="groups">
                <param name="input_ortho" format="csv" multiple="true" label="Select orthogroups files" help="All the csv files from a Orthofinder_only_groups full run"/>
            </when>            
            <when value="trees">
                <param name="input_trees" type="data_collection" collection_type="list" format="txt" label="Select genes trees collection" help="All the genes trees files from a previous Orthofinder_from_groups full run"/>                
            </when>            
        </conditional>

        <param name="keeprecon" type="boolean" checked="false" label="Do you want to keep the reconciled genes_trees files ?" />
        <param name="keepids" type="boolean" checked="false" label="Do you want to keep the trees_ids files ?" />
        
        <conditional name="usetree" >
            <!--
            <param name="yestree" type="select" label="Use an already rooted-species-tree ?" help="Only for full runs." >
                <option value="yes">Yes</option>
                <option value="no" selected="true">No</option>
            </param>
            -->
            <param name="yestree" type="boolean" checked="false" label="Use an already rooted-species-tree ?" help="Only for full runs." />
            <when value="true">
                <param name="usertree" type="data" format="txt" label="Import your tree" help="The species-tree must be a rooted binary tree in Newick format. The species name must match the names of the input fasta or the SpeciesIds.txt file." />
            </when>
        </conditional>

        <!-- Control where OrthoFinder stops - Only one must be selected -->        
        <param name="end" type="select" label="Orthofinder ending point" help="OrthoFinder works in several steps ; you can choose to retrieve only the results of a given step. WARNING : be sure the start and stop options are compatible." >            
            <option value="onlytrees">Only trees</option>
            <option value="all" selected="true">Full run</option>
        </param>	
		
	</inputs>

	<outputs>        

        <!-- outputs for genes trees -->
        <collection name="gene_trees" type="list" label="Genes_trees">
            <discover_datasets pattern="__name_and_ext__" directory="results/orthologues/Genes_trees/" />            
            <filter>init['start']!="fromtrees"</filter>
        </collection>

        <!-- Species_tree_rooted -->
        <data format="txt" name="speciestree" label="SpeciesTree_rooted.txt" from_work_dir="results/orthologues/SpeciesTree_rooted.txt"/>

        <!-- outputs for reconciled genes trees -->
        <collection name="recon_gene_trees" type="list" label="Reconciled_genes_trees">
            <discover_datasets pattern="__name_and_ext__" directory="results/orthologues/WorkingDirectory/Recon_Gene_trees/" />            
            <filter>end!="onlytrees" and keeprecon</filter>
        </collection>

        <!-- outputs for reconciled trees ids -->
        <collection name="trees_ids" type="list" label="Trees_ids">
            <discover_datasets pattern="__name_and_ext__" directory="results/orthologues/WorkingDirectory/Trees_ids/" />            
            <filter>end!="onlytrees" and keepids</filter>
        </collection>

        <!-- Collections for orthologues. PROBLEM : sub-directories number and names vary according to species ! -->
        
	</outputs>

	<tests>
		<test>
            
		</test>
	</tests>	

	<help>
===========
OrthoFinder
===========

Full readme at https://github.com/davidemms/OrthoFinder/blob/master/README.md
Summary sketch at https://github.com/davidemms/OrthoFinder/blob/master/OrthoFinder-options.pdf

tarting step must be a step occuring before the stoping step.
    - A user's mistake will cause a crash of the tool.

	</help>

	<citations>
		<citation type="bibtex">https://github.com/davidemms/OrthoFinder</citation>
		<citation type="bibtex">Emms, D.M. and Kelly, S. (2015) OrthoFinder: solving fundamental biases in whole genome comparisons dramatically improves orthogroup inference accuracy, Genome Biology 16:157</citation>        
	</citations>

</tool>
