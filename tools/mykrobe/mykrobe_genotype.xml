<?xml version="1.0" encoding="utf-8"?>
<tool id="mykrobe_genotype" name="mkyrobe genotype" version="0.5.6" >
  <description>Antibiotic resistance predictions</description>
  <requirements>
    <requirement type="package" version="0.5.6">mykrobe</requirement>
  </requirements>
  <command detect_errors="exit_code">
<![CDATA[

         #set $name=str($data_type.fastq_input1.name)
         #set $type='fastq'
         ## Adding sample name, indicate specie and inputs fastq(s) files
          #if $data_type.type == "paired":

            ln -s '$data_type.fastq_input1' '$data_type.fastq_input1.name'_1.fastq &&
            ln -s '$data_type.fastq_input2' '$data_type.fastq_input2.name'_2.fastq &&


        #elif $data_type.type == "collection":

            ln -s '$data_type.fastq_input1.forward' '$data_type.fastq_input1.name'_1.fastq &&
            ln -s '$data_type.fastq_input1.reverse' '$data_type.fastq_input1.name'_2.fastq &&

        #elif $data_type.type == "single":

            #if $data_type.fastq_input1.is_of_type('fastqsanger') or $data_type.fastq_input1.is_of_type('fastq'):
              ln -s '$data_type.fastq_input1' '$data_type.fastq_input1.name'.fastq &&
            #end if

           #if $data_type.fastq_input1.is_of_type('bam'):
              #set $type='bam'
              ln -s '$data_type.fastq_input1' '$data_type.fastq_input1.name'.bam &&
           #end if
              
           #if $data_type.fastq_input1.is_of_type('fasta'):
              #set $type='fasta'
              ln -s '$data_type.fastq_input1' '$data_type.fastq_input1.name'.fasta &&
           #end if

        #end if



        mykrobe genotype 
        '$name'
        '$probe_set'

        #if $kmer:
          --kmer $kmer
        #end if

        #if $expected_depth:
          --expected_depth $expected_depth
        #end if


        -q
        -t "\${GALAXY_SLOTS:-1}"

        -1
        #if $type == 'fastq':
          *.fastq
        #elif $type == 'bam':
          *.bam
        #else
          *.fasta  
        #end if
         > $json
]]>
  </command>
  <inputs>
    <conditional name="data_type">
      <param name="type" type="select" label="Specify the read type.">
        <option value="single">Single-end Data</option>
        <option value="paired">Paired-end Data</option>
        <option value="collection">Collection Paired-end Data</option>
      </param>
      <when value="single">
        <param name="fastq_input1" type="data" format="fastqsanger, fastq,fasta,bam" label="Single end read file(s)"/>
      </when>
      <when value="paired">
        <param name="fastq_input1" type="data" format="fastqsanger, fastq" label="Forward paired-end read file"/>
        <param name="fastq_input2" type="data" format="fastqsanger, fastq" label="Reverse paired-end read file"/>
      </when>
      <when value="collection">
        <param name="fastq_input1" type="data_collection" label="Paired-end reads collection" optional="false" format="fastqsanger, fastq" collection_type="paired" />
      </when>
    </conditional>
    <param name="probe_set" type="data" format="fasta" label="Probe Set"/>
    <param name="kmer" argument="--kmer" optional="True" type="integer" min="0" label="Kmer length" value="21" help="default = 21"/>
    <param name="expected_depth" argument="--expected_depth" optional="True" type="integer" min="0" label="Expected Depth"  help=""/>
  </inputs>

  <outputs>
    <data name="json" format="json" label="JSON prediction"/>
  </outputs>
  <tests>
    <test>
      <param name="type" value="single"/>
      <param name="fastq_input1" value="reads.fastq"/>
      <param name="probe_set" value="tb-bradley-probe-set-feb-09-2017.fasta.gz"/>
      <output name="json">
        <assert_contents>
          <has_text_matching expression="ref-S315T"/>
        </assert_contents>
      </output>
    </test>
  </tests>
  <help>
<![CDATA[

**MyKrobe predict - Antibiotic resistance predictions**

Rapid antibiotic-resistance predictions from genome sequence data for Staphylococcus aureus and Mycobacterium tuberculosis
using Bruijn graph.

]]>      
  </help>
  <citations>
    <citation type="doi">10.1038/ncomms10063</citation>
  </citations>
</tool>
