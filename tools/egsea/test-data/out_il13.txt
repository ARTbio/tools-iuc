
options( show.error.messages=F, error = function () { cat( geterrmessage(), file=stderr() ); q( "no", 1, F ) } )

# we need that to not crash galaxy with an UTF8 error on German LC settings.
loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

suppressPackageStartupMessages(library(EGSEA))

species <- "human"

base_methods <- "camera,globaltest,ora"
base_methods <- unlist(strsplit(base_methods, ","))

if ("h" != "None") {
    msigdb_gsets <- "h"
    msigdb_gsets <- unlist(strsplit(msigdb_gsets, ","))
} else {
    msigdb_gsets <- "none"
}

if ("None" != "None") {
    keggdb_gsets <- "None"
    keggdb_gsets <- unlist(strsplit(keggdb_gsets, ","))
    kegg_all <- c("Metabolism"="keggmet", "Signaling"="keggsig", "Disease"="keggdis")
    kegg_exclude <- names(kegg_all[!(kegg_all %in% keggdb_gsets)])
} else {
    kegg_exclude <- "all"
}

if ("None" != "None") {
    gsdb_gsets <- "None"
    gsdb_gsets <- unlist(strsplit(gsdb_gsets, ","))
} else {
    gsdb_gsets <- "none"
}

display_top <- "5"
min_size <- "2"
fdr_cutoff <- "0.05"
combine_method <- "wilkinson"
sort_method <- "med.rank"

counts <- read.table('/tmp/tmpNvCyTg/files/000/dataset_1.dat', sep='\t', row.names=1, header=TRUE)
counts <- as.matrix(counts)
group <- read.table('/tmp/tmpNvCyTg/files/000/dataset_2.dat', sep='\t')
group <- factor(group[,1])
genes <- read.table('/tmp/tmpNvCyTg/files/000/dataset_3.dat', sep='\t', header=TRUE)


gs.annots <- buildIdx(entrezIDs=rownames(counts), species=species, msigdb.gsets=msigdb_gsets, gsdb.gsets=gsdb_gsets, kegg.exclude=kegg_exclude)


gsa <- egsea.cnt(counts=counts, group=group, gs.annots=gs.annots, symbolsMap=genes, baseGSEAs=base_methods, minSize=min_size, display.top=display_top, combineMethod=combine_method, sort.by=sort_method, report.dir='./report_dir', fdr.cutoff=fdr_cutoff, num.threads=2, report=TRUE)

# Output RData file

if (FALSE) {
    save.image(file = "EGSEA_analysis.RData")
}
        