<tool id="pick_closed_reference_otus" name="Perform closed-reference OTU picking" version="@WRAPPER_VERSION@.0">
    <description></description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>

    <version_command>pick_closed_reference_otus.py --version</version_command>

    <command detect_errors="aggressive"><![CDATA[
        pick_close_reference_otus.py
            --input_fp '$input_fp'
            --output_dir otus
            #if str( $reference_sequences.reference_sequences_selector ) == 'history'
                #set $ref = $reference_sequences.history_database
            #else:
                #set $data_table = dict([(_[0], _[2]) for _ in $reference_sequences.cached_database.input.options.tool_data_table.data])
                #set $db = $reference_sequences.cached_database.value
                #set $ref = $data_table[$db]
            #end if
            --reference_fp '$ref'
            #if str( $prefilter.prefilter_refseqs_fp ) == 'yes'
                #if str( $prefilter.prefilter_reference_sequences.reference_sequences_selector ) == 'history'
                    #set $ref = $prefilter.prefilter_reference_sequences.history_database
                #else:
                    #set $data_table = dict([(_[0], _[2]) for _ in $prefilter.prefilter_reference_sequences.cached_database.input.options.tool_data_table.data])
                    #set $db = $prefilter.prefilter_reference_sequences.cached_database.value
                    #set $ref = $data_table[$db]
                #end if
                --prefilter_refseqs_fp '$ref'
            #end if
            --taxonomy_fp '$taxonomy'
            --parallel
            -O "\${GALAXY_SLOTS:-4}"
            --suppress_taxonomy_assignment

    ]]></command>

    <inputs>
        <param argument="--input_fps" type="data" format="fasta,fastq" multiple="True" label="Input sequence files"/>
        <conditional name="reference_sequences">
            <param name="reference_sequences_selector" type="select"  label="Reference sequences to query">
                <option value="cached" selected="True">Public databases</option>
                <option value="history">Databases from your history</option>
            </param>
            <when value="cached">
                <param name="cached_database" label="QIIME databases of reference sequences" type="select">
                    <options from_data_table="qiime_reference_db"/>
                </param>
            </when>
            <when value="history">
                <param name="history_database" type="data" format="fasta" label="Reference databases"/>
            </when>
        </conditional>
        <param argument="--parallel" type="boolean" truevalue="--parallel" falsevalue="" checked="False" label="Run in parallel where available?"/>
        <param argument="--suppress_taxonomy_assignment" type="boolean" truevalue="--suppress_taxonomy_assignment" falsevalue="" checked="False" label="Skip the taxonomy assignment step?" help="It results in an OTU table without taxonomy"/>
    </inputs>

    <outputs>
        <data name="final_otu_map" format="txt" from_work_dir="otus/final_otu_map.txt" label="${tool.name} on ${on_string}: Final OTU map"/>
        <data name="final_otu_map_mc" format="txt" from_work_dir="otus/final_otu_map_mc*.txt" label="${tool.name} on ${on_string}: Final OTU map without the OTUs failing the minimum specified OTU size"/>
        <data name="rep_set" format="fasta" from_work_dir="otus/rep_set.fna" label="${tool.name} on ${on_string}: OTU representative sequences"/>
        <data name="otu_table_mc" format="biom" from_work_dir="otus/otu_table_mc*.biom" label="${tool.name} on ${on_string}: OTU table"/>
        <data name="otu_table_mc_w_tax" format="biom" from_work_dir="otus/otu_table_w_tax.biom" label="${tool.name} on ${on_string}: OTU table with taxonomic assignment">
            <filter>suppress_taxonomy_assignment is False</filter>
        </data>
        <data name="otu_table_mc_w_tax_no_pynast_failures" format="biom" from_work_dir="otus/otu_table_w_tax_no_pynast_failures.biom"  label="${tool.name} on ${on_string}: OTU table with taxonomic assignment and without sequences failing the alignment to the OTU representative sequences">
            <filter>suppress_taxonomy_assignment is False and suppress_align_and_tree is False</filter>
        </data>
        <data name="otu_table_mc_no_pynast_failures" format="biom" from_work_dir="otus/otu_table_no_pynast_failures.biom"  label="${tool.name} on ${on_string}: OTU table without sequences failing the alignment to the OTU representative sequences">
            <filter>suppress_taxonomy_assignment is True and suppress_align_and_tree is False</filter>
        </data>
        <data name="rep_set_tree" format="txt" from_work_dir="otus/rep_set.tre" label="${tool.name} on ${on_string}: Representative set tree">
            <filter>suppress_align_and_tree is False</filter>
        </data>
        <data name="new_refseqs" format="fasta" from_work_dir="otus/new_refseqs.fna" label="${tool.name} on ${on_string}: New reference sequences (OTU + input reference sequences)"/>  
    </outputs>

    <tests>
        <test>
            <param name="input_fp" value="pick_closed_reference_otus/sequences.fasta"/>
            <param name="otu_picking_method" value="uclust"/>
            <param name="reference_sequences_selector" value="history"/>
            <param name="history_database" value="pick_closed_reference_otus/gg_13_8_79_otus.fasta"/>
            <param name="difference_test" value="false"/>
            <param name="new_ref_set_id" value="New"/>
            <param name="parallel" value="--parallel"/>
            <param name="percent_subsample" value="0.001"/>
            <param name="prefilter_percent_id" value="0.0"/>
            <param name="minimum_failure_threshold" value="100000"/>
            <param name="suppress_step4" value=""/>
            <param name="min_otu_size" value="2"/>
            <param name="suppress_taxonomy_assignment" value=""/>
            <param name="suppress_align_and_tree" value=""/>
            <output name="final_otu_map" value="pick_closed_reference_otus/1_final_otu_map.txt"/>
            <output name="final_otu_map_mc" value="pick_closed_reference_otus/1_final_otu_map_mc.txt"/>
            <output name="rep_set">
                <assert_contents>
                    <has_line line=">4374484 L1S8_76"></has_line>
                    <has_text text=">New.CleanUp.ReferenceOTU6 L1S208_7"></has_text>
                </assert_contents>
            </output>
            <output name="rep_set_tree" value="pick_closed_reference_otus/1_rep_set_tree.tre"/>
            <output name="new_refseqs">
                <assert_contents>
                    <has_line line=">1109493"></has_line>
                    <has_text text=">945028"></has_text>
                    <has_text text=">4437874"></has_text>
                    <has_text text=">New.CleanUp.ReferenceOTU6 L1S208_7"></has_text>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_fps" value="pick_closed_reference_otus/sequences.fasta"/>
            <param name="otu_picking_method" value="uclust"/>
            <param name="reference_sequences_selector" value="history"/>
            <param name="history_database" value="pick_closed_reference_otus/gg_13_8_79_otus.fasta"/>
            <param name="difference_test" value="false"/>
            <param name="new_ref_set_id" value="New"/>
            <param name="parallel" value="--parallel"/>
            <param name="percent_subsample" value="0.001"/>
            <param name="prefilter_percent_id" value="0.0"/>
            <param name="minimum_failure_threshold" value="100000"/>
            <param name="suppress_step4" value=""/>
            <param name="min_otu_size" value="3"/>
            <param name="suppress_taxonomy_assignment" value="--suppress_taxonomy_assignment"/>
            <param name="suppress_align_and_tree" value="--suppress_align_and_tree"/>
            <output name="final_otu_map" value="pick_closed_reference_otus/2_final_otu_map.txt"/>
            <output name="final_otu_map_mc" value="pick_closed_reference_otus/2_final_otu_map_mc.txt"/>
            <output name="rep_set">
                <assert_contents>
                    <has_line line=">4374484 L1S8_76"></has_line>
                    <has_text text=">New.CleanUp.ReferenceOTU6 L1S208_7"></has_text>
                </assert_contents>
            </output>
            <output name="new_refseqs">
                <assert_contents>
                    <has_line line=">1109493"></has_line>
                    <has_text text=">945028"></has_text>
                    <has_text text=">4437874"></has_text>
                    <has_text text=">New.CleanUp.ReferenceOTU6 L1S208_7"></has_text>
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="input_fps" value="pick_closed_reference_otus/sequences.fasta"/>
            <param name="otu_picking_method" value="uclust"/>
            <param name="reference_sequences_selector" value="history"/>
            <param name="history_database" value="pick_closed_reference_otus/gg_13_8_79_otus.fasta"/>
            <param name="difference_test" value="false"/>
            <param name="new_ref_set_id" value="New"/>
            <param name="parallel" value="--parallel"/>
            <param name="percent_subsample" value="0.001"/>
            <param name="prefilter_percent_id" value="0.0"/>
            <param name="minimum_failure_threshold" value="100000"/>
            <param name="suppress_step4" value=""/>
            <param name="min_otu_size" value="10"/>
            <param name="suppress_taxonomy_assignment" value="--suppress_taxonomy_assignment"/>
            <param name="suppress_align_and_tree" value=""/>
            <output name="final_otu_map" value="pick_closed_reference_otus/3_final_otu_map.txt"/>
            <output name="final_otu_map_mc" value="pick_closed_reference_otus/3_final_otu_map_mc.txt"/>
            <output name="rep_set">
                <assert_contents>
                    <has_line line=">New.CleanUp.ReferenceOTU20 L1S8_4"></has_line>
                    <has_text text=">New.CleanUp.ReferenceOTU21 L1S140_45"></has_text>
                    <has_text text=">New.CleanUp.ReferenceOTU22 L1S208_15"></has_text>
                </assert_contents>
            </output>
            <output name="rep_set_tree" value="pick_closed_reference_otus/3_rep_set_tree.tre"/>
            <output name="new_refseqs">
                <assert_contents>
                    <has_line line=">1109493"></has_line>
                    <has_text text=">945028"></has_text>
                    <has_text text=">4431138"></has_text>
                    <has_text text=">New.CleanUp.ReferenceOTU22 L1S208_15"></has_text>
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**What it does**

This tool performs closed-reference OTU picking from sequences.

This script is broken down into 4 possible OTU picking steps, and 2 steps
involving the creation of OTU tables and trees.

More information about this tool is available on
`QIIME documentation <http://qiime.org/scripts/pick_closed_reference_otus.html>`_.
    ]]></help>

    <citations>
        <expand macro="citations"/>
    </citations>
</tool>
