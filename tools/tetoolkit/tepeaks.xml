<?xml version="1.0"?>
<tool id="tepeaks" name="TEpeaks" version="@TOOL_VERSION@+@WRAPPER_VERSION@">
    <description>performs peak-calling of ChIP-seq datasets</description>
    <macros>
        <token name="@TOOL_VERSION@">0.1</token>
        <token name="@WRAPPER_VERSION@">galaxy0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">tepeaks</requirement>
    </requirements>
    <stdio></stdio>
    <version_command>TEpeaks version</version_command>
    <command detect_errors="exit_code"><![CDATA[
        TEpeaks
            ## required
            narrow ## more options will be available in future versions of TEpeaks
            --treatment '$treatment'
            --control '$control'
            ## optional
            --species=$ap.species
            $ap.auto
            #if $ap.fraglen
                --fraglen=$ap.fraglen
            #end if
            #if $ap.ratio
                --ratio=$ap.ratio
            #end if
            #if $ap.gsize
                --gsize=$ap.gsize
            #end if
            --pileup=$ap.pileup
            --fe=$ap.fe
            -i $ap.numItr ## --numItr does not work
            --threads=\${GALAXY_SLOTS:-1}
            --keepDup=$ap.keepDup
            --shift=$ap.shift
            --lmfold=$ap.lmfold
            --hmfold=$ap.hmfold
            --pval=$ap.pval
            --fdr=$ap.fdr
            $ap.toLarge
            -o result
            #if $oo.log
                |& tee log.txt
            #end if
        ]]></command>
    <inputs>
        <param argument="--treatment" type="data" format="bam" label="Select IP sample file"/>
        <param argument="--control" type="data" format="bam,bed" label="Select control IP sample file"/>
        <section name="ap" title="Advanced parameters">
            <param argument="--species" type="select" label="Select genome">
                <option value="hs">Human</option>
                <option value="mm">Mouse</option>
                <option value="ce">C. elegans</option> <!-- appears in error message if an invalid value is used -->
                <option value="dm">D. melanogaster</option>
            </param>
            <param argument="--auto" type="boolean" truevalue="--auto" falsevalue="" label="Detect shiftsize for single-end reads automatically?"/>
            <param argument="--fraglen" type="integer" value="200" optional="true" label="Set fragment size"/>
            <param argument="--ratio" type="float" value="" optional="true" label="Set ratio between IP sample and input sample" help="By default, it's calculated from the data."/>
            <param argument="--keepDup" type="select" label="Select mode for dealing with duplicate reads">
                <option value="all">all</option>
                <option value="1">1</option>
            </param>
            <param argument="--shift" type="integer" value="0" label="Shift reads by" help="Towards 3' end, if positive, or 5' end if negative."/>
            <param argument="--lmfold" type="integer" value="10" min="0" label="Set lower limit of fold ratio against background to build model"/>
            <param argument="--hmfold" type="integer" value="30" min="0" label="Set higher limit of fold ratio against background to build model"/>
            <param argument="--pval" type="float" value="1e-5" min="0.0" max="1.0" label="Set p-value cutoff"/>
            <param argument="--fdr" type="float" value="0.05" min="0.0" max="1.0" label="Set false discovery rate cutoff"/>
            <param argument="--toLarge" type="boolean" truevalue="--toLarge" falsevalue="" label="Scale library size to large sample?"/>
            <param argument="--gsize" type="integer" value="" min="0" optional="true" label="Set effective genome size" help="By default value is estimated from the input data."/>
            <param argument="--pileup" type="integer" value="20" min="0" label="Set  minimum pileup required for peaks with multi-reads"/>
            <param argument="--fe" type="float" value="3.0" min="0.0" label="Set  minimum fold enrichment required for peaks with multi-reads"/>
            <param argument="--numItr" type="integer" value="0" min="0" label="Set number of iterations"/>
        </section>
        <section name="oo" title="Output options">
            <param name="log" type="boolean" label="Create log file?"/>
        </section>
    </inputs>
    <outputs>
        <collection name="out_collection" type="list" label="${tool.name} on ${on_string}">
            <!-- pattern="__name_and_ext__" does not work: same filename with different file formats -->
            <discover_datasets pattern="(?P&lt;designation&gt;.+)" directory="result"/>
        </collection>
        <data name="out_log" format="txt" from_work_dir="log.txt" label="${tool.name} on ${on_string}: log">
            <filter>oo['log']</filter>
        </data>
    </outputs>
    <tests>
        <!-- #1 default-->
        <test expect_num_outputs="2">
            <param name="treatment" value="treatment1.bam"/>
            <param name="control" value="control1.bam"/>
            <section name="oo">
                <param name="log" value="true"/>
            </section>
            <output_collection name="out_collection" type="list" count="10">
                <element name="NONAME_candidatePeaks.txt">
                    <assert_contents>
                        <has_n_lines n="245"/>
                        <has_line line="chrom&#009;star&#009;end&#009;peakID&#009;pileup&#009;pscore"/>
                        <has_text_matching expression="chrX&#009;22391323&#009;22391523&#009;244&#009;1&#009;0"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="390"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1213233&#009;1213233&#009;0.99494"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="398"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13360&#009;13364&#009;14.128"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="5023"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22310925&#009;22391523&#009;0.00072785"/>
                    </assert_contents>
                </element>
                <element name="NONAME_multiRead_peaks.txt">
                    <assert_contents>
                        <has_n_lines n="1"/>
                        <has_text_matching expression="chrom&#009;start&#009;.+"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="44"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1086707&#009;1087107&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="140"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13364&#009;13364&#009;17"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="1239"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391523&#009;22391523&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.txt">
                    <assert_contents>
                        <has_n_lines n="255"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391323&#009;22391523&#009;NONAME_peak254&#009;30&#009;1.99855&#009;6.5746&#009;3.04979&#009;100"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.xls">
                    <assert_contents>
                        <has_n_lines n="255"/>
                        <has_text_matching expression="chr&#009;start&#009;.+"/>
                        <has_text_matching expression="chrX&#009;22391324&#009;22391523&#009;201&#009;22391424&#009;1&#009;6.5746&#009;1.99855&#009;3.04979&#009;NONAME_peak254"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_log">
                <assert_contents>
                    <has_line line="Done."/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 -->
        <test expect_num_outputs="2">
            <param name="treatment" value="treatment1.bam"/>
            <param name="control" value="control1.bam"/>
            <section name="ap">
                <param name="species" value="mm"/>
                <param name="auto" value="true"/>
                <param name="fraglen" value="190"/>
                <param name="ratio" value="2"/>
                <param name="keepDup" value="1"/>
                <param name="shift" value="-1"/>
                <param name="lmfold" value="11"/>
                <param name="hmfold" value="31"/>
                <param name="pval" value="2e-5"/>
                <param name="fdr" value="0.06"/>
                <param name="toLarge" value="true"/>
                <param name="gsize" value="2600000000"/>
                <param name="pileup" value="21"/>
                <param name="fe" value="3.1"/>
                <param name="numItr" value="1"/>
            </section>
            <section name="oo">
                <param name="log" value="true"/>
            </section>
            <output_collection name="out_collection" type="list" count="11">
                <element name="NONAME_candidatePeaks.txt">
                    <assert_contents>
                        <has_n_lines n="255"/>
                        <has_line line="chrom&#009;star&#009;end&#009;peakID&#009;pileup&#009;pscore"/>
                        <has_line line="chrX&#009;22391374&#009;22391524&#009;254&#009;1&#009;0"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="394"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1213208&#009;1213208&#009;1.0397"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="416"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13332&#009;13335&#009;6.0824"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="5074"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22310924&#009;22391524&#009;0.00051029"/>
                    </assert_contents>
                </element>
                <element name="NONAME_model.r">
                    <assert_contents>
                        <has_n_lines n="24"/>
                        <has_line line="dev.off()"/>
                    </assert_contents>
                </element>
                <element name="NONAME_multiRead_peaks.txt">
                    <assert_contents>
                        <has_n_lines n="1"/>
                        <has_text_matching expression="chrom&#009;start&#009;.+"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="44"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1086707&#009;1087132&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="144"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13335&#009;13335&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="1190"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391524&#009;22391524&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.txt">
                    <assert_contents>
                        <has_n_lines n="257"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391374&#009;22391524&#009;NONAME_peak256&#009;31&#009;1.99898&#009;6.88604&#009;3.12948&#009;75"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.xls">
                    <assert_contents>
                        <has_n_lines n="257"/>
                        <has_text_matching expression="chr&#009;start&#009;.+"/>
                        <has_text_matching expression="chrX&#009;22391375&#009;22391524&#009;151&#009;22391450&#009;1&#009;6.88604&#009;1.99898&#009;3.12948&#009;NONAME_peak256"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_log">
                <assert_contents>
                    <has_line line="Done."/>
                </assert_contents>
            </output>
        </test>
        <!-- #3 -->
        <test expect_num_outputs="2">
            <param name="treatment" value="treatment1.bam"/>
            <param name="control" value="control1.bam"/>
            <section name="ap">
                <param name="shift" value="1"/>
            </section>
            <section name="oo">
                <param name="log" value="true"/>
            </section>
            <output_collection name="out_collection" type="list" count="10">
                <element name="NONAME_candidatePeaks.txt">
                    <assert_contents>
                        <has_n_lines n="245"/>
                        <has_line line="chrom&#009;star&#009;end&#009;peakID&#009;pileup&#009;pscore"/>
                        <has_text_matching expression="chrX&#009;22391322&#009;22391522&#009;244&#009;1&#009;0"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="390"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1213233&#009;1213233&#009;0.99494"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="398"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13361&#009;13364&#009;14.128"/>
                    </assert_contents>
                </element>
                <element name="NONAME_ctrl_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="5023"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22310926&#009;22391522&#009;0.00072785"/>
                    </assert_contents>
                </element>
                <element name="NONAME_multiRead_peaks.txt">
                    <assert_contents>
                        <has_n_lines n="1"/>
                        <has_text_matching expression="chrom&#009;start&#009;.+"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chr4.bdg">
                    <assert_contents>
                        <has_n_lines n="44"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chr4&#009;1086707&#009;1087107&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrM.bdg">
                    <assert_contents>
                        <has_n_lines n="141"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrM&#009;13364&#009;13364&#009;17"/>
                    </assert_contents>
                </element>
                <element name="NONAME_treat_uniq_chrX.bdg">
                    <assert_contents>
                        <has_n_lines n="1239"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391522&#009;22391522&#009;1"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.txt">
                    <assert_contents>
                        <has_n_lines n="254"/>
                        <has_text_matching expression="track.+"/>
                        <has_line line="chrX&#009;22391322&#009;22391522&#009;NONAME_peak253&#009;30&#009;1.99855&#009;6.5746&#009;3.04991&#009;100"/>
                    </assert_contents>
                </element>
                <element name="NONAME_uniqpeaks.xls">
                    <assert_contents>
                        <has_n_lines n="254"/>
                        <has_text_matching expression="chr&#009;start&#009;.+"/>
                        <has_text_matching expression="chrX&#009;22391323&#009;22391522&#009;201&#009;22391423&#009;1&#009;6.5746&#009;1.99855&#009;3.04991&#009;NONAME_peak253"/>
                    </assert_contents>
                </element>
            </output_collection>
            <output name="out_log">
                <assert_contents>
                    <has_line line="Done."/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

TEpeaks performs peak-calling of ChIP-seq datasets using both uniquely mapped and multi-mapped (ambiguous) reads.

**Input**

ChIP-seq data in BAM file format.

**Output**

Results in tabular format are created for candidate, multi read and unique peaks.

.. class:: infomark

**References**

More information are available on the `project website <http://hammelllab.labsites.cshl.edu/software/#TEpeaks>`_ and `github <https://github.com/mhammell-laboratory/TEpeaks>`_.
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btv422</citation>
        <citation type="doi">10.1007/978-1-4939-7710-9_11</citation>
    </citations>
</tool>