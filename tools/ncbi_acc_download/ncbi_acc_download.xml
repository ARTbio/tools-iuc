<tool id="ncbi_acc_download" name="NCBI Accession Download" version="@TOOL_VERSION@_galaxy0">
    <description>Download sequences from GenBank/RefSeq by accession through the NCBI ENTREZ API</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
      <requirement type="package" version="@TOOL_VERSION@">ncbi-acc-download</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #if $query_source.select == "accession_file":
            cp $query_source.accession_file accessions &&
        #else if $query_source.select == "accession_list":
            echo '$query_source.accession_list' | sed 's/\,/\n/g' > accessions &&
        #end if
        mkdir outdir &&
        cd outdir &&
        while read accession; do
        ncbi-acc-download
            --molecule '${molecule}'
            --format '${format}'
            --extended-validation all
            \${accession} && sleep 5;
        done < ../accessions
    ]]></command>
    <inputs>
      <conditional name="query_source">
          <param name="select" type="select" label="Select source for IDs">
            <option value="accession_file">File containing Accessions (one per line)</option>
            <option value="accession_list">Direct Entry</option>
          </param>
          <when value="accession_file">
              <param label="Accession File" name="accession_file" type="data" format="text,tabular"/>
          </when>
          <when value="accession_list">
              <param label="ID List" name="accession_list" type="text" area="true" help="Newline/Comma separated list of IDs"/>
          </when>
        </conditional>
        <param name="molecule" type="select" label="Molecule Type">
            <option value="nucleotide" selected="true">Nucleotide</option>
            <option value="protein">Protein</option>
        </param>
        <param name="format" type="select" label="File Format">
            <option value="fasta" selected="true">FASTA</option>
            <option value="genbank">GenBank</option>
            <option value="featuretable">Feature Table</option>
            <option value="gff3">GFF3</option>
        </param>
    </inputs>
    <outputs>
        <collection name="output" type="list" label="Output">
            <filter>options['fasta']</filter>
            <discover_datasets pattern="__designation_and_ext__" directory="outdir" />
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="molecule" value="nucleotide"/>
            <param name="format" value="fasta"/>
            <param name="accession_file" value="accessions_1.tsv"/>
            <output_collection name="output" type="list">
                <element name="CP011064">
                    <assert_contents>
                        <has_line line=">CP011064.1 Escherichia coli str. Sanji plasmid pSJ_94, complete sequence" />
                    </assert_contents>
                </element>
                <element name="CP021680">
                    <assert_contents>
                        <has_line line=">CP021680.1 Escherichia coli strain AR_0162 plasmid tig00002623, complete sequence" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <param name="molecule" value="nucleotide"/>
            <param name="format" value="genbank"/>
            <param name="accession_file" value="accessions_1.tsv"/>
            <output_collection name="output" type="list">
                <element name="CP011064" >
                    <assert_contents>
                        <has_line line="DEFINITION  Escherichia coli str. Sanji plasmid pSJ_94, complete sequence." />
                    </assert_contents>
                </element>
                <element name="CP021680">
                    <assert_contents>
                        <has_line line="DEFINITION  Escherichia coli strain AR_0162 plasmid tig00002623, complete" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <param name="molecule" value="nucleotide"/>
            <param name="format" value="fasta"/>
            <param name="select" value="accession_list"/>
            <param name="accession_list" value="CP011064,CP021680"/>
            <output_collection name="output" type="list">
                <element name="CP011064">
                    <assert_contents>
                        <has_line line=">CP011064.1 Escherichia coli str. Sanji plasmid pSJ_94, complete sequence" />
                    </assert_contents>
                </element>
                <element name="CP021680">
                    <assert_contents>
                        <has_line line=">CP021680.1 Escherichia coli strain AR_0162 plasmid tig00002623, complete sequence" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <param name="molecule" value="protein"/>
            <param name="format" value="fasta"/>
            <param name="select" value="accession_list"/>
            <param name="accession_list" value="NP_003192"/>
            <output_collection name="output" type="list">
                <element name="NP_003192">
                    <assert_contents>
                        <has_line line=">NP_003192.1 transcription factor A, mitochondrial isoform 1 precursor [Homo sapiens]" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <param name="molecule" value="protein"/>
            <param name="format" value="genbank"/>
            <param name="select" value="accession_list"/>
            <param name="accession_list" value="NP_003192"/>
            <output_collection name="output" type="list">
                <element name="NP_003192">
                    <assert_contents>
                        <has_line line="DEFINITION  transcription factor A, mitochondrial isoform 1 precursor [Homo" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
    ]]></help>
    <citations>
    </citations>
</tool>
