<tool id="ncbi_acc_download" name="NCBI Accession Download" version="@TOOL_VERSION@+galaxy0">
    <description>Download sequences from GenBank/RefSeq by accession through the NCBI ENTREZ API</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ncbi-acc-download</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #if $query_source.select == "accession_file":
            cp $query_source.accession_file accessions &&
        #else if $query_source.select == "accession_list":
            echo '$query_source.accession_list' | sed -r 's/(\,|__cn__)/\n/g' > accessions &&
        #end if
        mkdir outdir &&
        cd outdir &&
        while read accession; do
        ncbi-acc-download
            --molecule '${molecule.select}'
            --format '${molecule.format}'
            --extended-validation all
            \${accession} && sleep 5;
        done < ../accessions 2>> ../error.log
    ]]></command>
    <inputs>
        <conditional name="query_source">
            <param name="select" type="select" label="Select source for IDs">
                <option value="accession_file">File containing Accessions (one per line)</option>
                <option value="accession_list">Direct Entry</option>
            </param>
            <when value="accession_file">
                <param label="Accession File" name="accession_file" type="data" format="text,tabular"/>
            </when>
            <when value="accession_list">
                <param label="ID List" name="accession_list" type="text" area="true" help="Newline/Comma separated list of IDs"/>
            </when>
        </conditional>
        <conditional name="molecule">
            <param name="select" type="select" label="Molecule Type">
                <option value="nucleotide" selected="true">Nucleotide</option>
                <option value="protein">Protein</option>
            </param>
            <when value="nucleotide">
                <param name="format" type="select" label="File Format">
                    <option value="fasta" selected="true">FASTA</option>
                    <option value="genbank">GenBank</option>
                    <option value="featuretable">Feature Table</option>
                    <option value="gff3">GFF3</option>
                </param>
            </when>
            <when value="protein">
                <param name="format" type="select" label="File Format">
                    <option value="fasta" selected="true">FASTA</option>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <collection name="output" type="list" label="${tool.name} on ${on_string}: Downloaded Files">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.fa$" directory="outdir" format="fasta"/>
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.gbk$" directory="outdir" format="genbank"/>
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.gff$" directory="outdir" format="gff"/>
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.ft$" directory="outdir" format="text"/>
        </collection>
        <data name="error_log" from_workdir="error.log" label="${tool.name} on ${on_string}: Error Log" format="text"/>
    </outputs>
    <tests>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="fasta"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_file" />
                <param name="accession_file" value="accessions_1.tsv"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP011064.1 Escherichia coli str. Sanji plasmid pSJ_94, complete sequence" />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP021680.1 Escherichia coli strain AR_0162 plasmid tig00002623, complete sequence" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="genbank"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_file" />
                <param name="accession_file" value="accessions_1.tsv"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="genbank">
                    <assert_contents>
                        <has_line line="DEFINITION  Escherichia coli str. Sanji plasmid pSJ_94, complete sequence." />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="genbank">
                    <assert_contents>
                        <has_line line="DEFINITION  Escherichia coli strain AR_0162 plasmid tig00002623, complete" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="gff3"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_file" />
                <param name="accession_file" value="accessions_1.tsv"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="gff">
                    <assert_contents>
                        <has_line line="##sequence-region CP011064.1 1 94712" />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="gff">
                    <assert_contents>
                        <has_line line="##sequence-region CP021680.1 1 23332" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="featuretable"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_file" />
                <param name="accession_file" value="accessions_1.tsv"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="text">
                    <assert_contents>
                        <has_line line=">Feature gb|CP011064.1|" />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="text">
                    <assert_contents>
                        <has_line line=">Feature gb|CP021680.1|" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="fasta"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_list" />
                <param name="accession_list" value="CP011064,CP021680"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP011064.1 Escherichia coli str. Sanji plasmid pSJ_94, complete sequence" />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP021680.1 Escherichia coli strain AR_0162 plasmid tig00002623, complete sequence" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="nucleotide"/>
                <param name="format" value="fasta"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_list" />
                <param name="accession_list" value="CP011064&#10;CP021680"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="CP011064" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP011064.1 Escherichia coli str. Sanji plasmid pSJ_94, complete sequence" />
                    </assert_contents>
                </element>
                <element name="CP021680" ftype="fasta">
                    <assert_contents>
                        <has_line line=">CP021680.1 Escherichia coli strain AR_0162 plasmid tig00002623, complete sequence" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <test>
            <conditional name="molecule">
                <param name="select" value="protein"/>
                <param name="format" value="fasta"/>
            </conditional>
            <conditional name="query_source">
                <param name="select" value="accession_list" />
                <param name="accession_list" value="NP_003192"/>
            </conditional>
            <output_collection name="output" type="list">
                <element name="NP_003192" ftype="fasta">
                    <assert_contents>
                        <has_line line=">NP_003192.1 transcription factor A, mitochondrial isoform 1 precursor [Homo sapiens]" />
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
**What it does**
Given a file containing a list of NCBI accession numbers or a direct entry of accession numbers in the tool text input box, this tool will download the corresponding sequence records via the NCBI API. 

**Limitations**
- For protein sequence downloads, only fasta format is supported
- To avoid rate-limits imposed by the NCBI API, records are downloaded sequentially with a delay between requests. This may make it impractical to use this tool to download many (>100) records.

**Output**
A collection of sequence records in the desired format.
    ]]></help>
    <citations>
    </citations>
</tool>
