<tool id="hicexplorer_hicdifferentialtad" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>searches for differential TADs</description>
    <macros>
        <token name="@BINARY@">hicDifferentialTAD</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        ln -s '$matrix_h5_cooler_target' 'matrix_target.$matrix_h5_cooler_target.ext' &&
        ln -s '$matrix_h5_cooler_control' 'matrix_control.$matrix_h5_cooler_control.ext' &&

        @BINARY@

            --targetMatrix  'matrix_target.$matrix_h5_cooler_target.ext'
            --controlMatrix  'matrix_control.$matrix_h5_cooler_control.ext'


            #if $tadDomains:
                --tadDomains $tadDomains
            #end if

            #if $pValue:
                --pValue $pValue
            #end if
       
            --mode $mode_selector
            --modeReject $modeReject

            --threads @THREADS@

            && mv *_accepted.diff_tad accepted.diff_tad
            && mv *_rejected.diff_tad rejected.diff_tad

]]>
    </command>
    <inputs>
        <param name='matrix_h5_cooler_target' type="data" format="h5,cool" label="Target matrix to compute on"/>
        <param name='matrix_h5_cooler_control' type="data" format="h5,cool"  label="Control matrix to compute on"/>

        <param argument="--tadDomains" type="text" format='bed' optional='false' label="TAD domains file" help= "The TADs domain file computed by hicFindTADs." />
        <param argument="--pValue" type="float" label="P-value" help= "H0 is considered as \'two regions are identical.\' i.e. all regions with a test result of smaller p-value are rejected and considered as differential." value='0.05'/>
        <param name="mode_selector" type="select" label="Method to compute the differentail TAD expression">
            <option value="intra-TAD">intra-TAD</option>
            <option value="left-inter-TAD">left-inter-TAD</option>
            <option value="right-inter-TAD">right-inter-TAD</option>
            <option value="all"  selected="True">all</option>
        </param>

        <param name="modeReject" type="select" label="Method to compute the differentail TAD expression">
            <option value="one" selected="True">one</option>
            <option value="all">all</option>
        </param>


    </inputs>
    <outputs>
        <data name='acceptedTADs' from_work_dir='accepted.diff_tad' format='txt' label='Accepted TADs'/>
        <data name='rejectedTADs' from_work_dir='rejected.diff_tad' format='txt' label='Rejected TADs'/>

    </outputs>
    <tests>
        <test>
            <param name="matrix_h5_cooler_target" value="small_test_matrix.cool"/>
            <param name="matrix_h5_cooler_control" value="small_test_matrix.cool"/>

            <param name="tadDomains" value="find_TADs/multiFDR_domains.bed"/>
            <param name="pValue" value="5"/>
            <param name="mode_selector" value="all"/>
            <param name="modeReject" value="one"/>
            <output name="acceptedTADs" file="hicDifferentialTAD/accepted.txt" ftype="txt" compare="sim_size"/>
            <output name="rejectedTADs" file="hicDifferentialTAD/rejected.txt" ftype="txt" compare="sim_size"/>

        </test>
    </tests>
    <help><![CDATA[

Differential TAD detection
==========================

Computes enriched regions (peaks) or long range contacts on the given contact matrix.

hicDetectLoops can detect enriched interaction regions (peaks / loops) based on a strict candidate selection, negative binomial distributions and Wilcoxon rank-sum tests.

The algorithm was mainly develop on GM12878 cells from Rao 2014 on 10kb and 5kb fixed bin size resolution.

_________________

Usage
-----

A command line example is available below (easily matchable in Galaxy using each field information):

̀`$ hicDetectLoops -m matrix.cool -o loops.bedgraph --maxLoopDistance 2000000 --windowSize 10 --peakWidth 6 --pValuePreselection 0.05 --pValue 0.05 --peakInteractionsThreshold 20`

The candidate selection is based on the restriction of the maximum genomic distance, here 2MB. This distance is given by Rao 2014. For each genomic distance a negative binomial distribution is computed and only interaction pairs with a threshold less than ``--pValuePreselection`` are accepted. Detected candidates need to have at least an interaction count of ``--maximumInteractionPercentageThreshold`` times the maximum value for their genomic distance. Please note that ``--maximumInteractionPercentageThreshold`` was introduced with HiCExplorer release 3.2. Earlier versions did not have this parameter yet and therefore their outputs may differ. In a second step, each candidate is considered compared to its neighborhood. This neighborhood is defined by the ``--windowSize`` parameter in the x and y dimension. Per neighborhood only one candidate is considered, therefore only the candidate with the highest peak values is accepted. As a last step, the neighborhood is split into a peak and background region (parameter ``--peakWidth``). The peakWidth can never be larger than the windowSize. However, we recommend for 10kb matrices a windowSize of 10 and a peakWidth of 6.

The output file (´´-o loops.bedgraph``) contains the x and y position of each loop and its corresponding p-value of the Anderson-Darling test.

`1   120000000       122500000       1       145000000       147500000       0.001`

The results can visualized via hicPlotMatrix:

`$ hicPlotMatrix -m matrix.cool -o plot.png --log1p --region 1:18000000-22000000 --loops loops.bedgraph`

.. image:: $PATH_TO_IMAGES/hicDetectLoops.png
   :width: 50%


For more information about HiCExplorer please consider our documentation on readthedocs.io_.

.. _readthedocs.io: http://hicexplorer.readthedocs.io/en/latest/index.html

]]></help>
    <expand macro="citations" />
</tool>
