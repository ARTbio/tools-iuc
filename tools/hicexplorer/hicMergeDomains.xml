<tool id="hicexplorer_hicmergedomains" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>Merges </description>
    <macros>
        <token name="@BINARY@">hicMergeDomains</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        @BINARY@

            #if $domainFiles:
                --domainFiles #echo "' '".join([ "'%s'" % $domain.domainFile for $domain in $domainFiles ])#
            #end if

            #if $proteinFile:
                --proteinFile $proteinFile
            #end if

            #if $minimumNumberOfPeaks:
                --minimumNumberOfPeaks $minimumNumberOfPeaks
            #end if

            #if $value:
                --value $value
            #end if

            #if $percent:
                --percent $percent
            #end if


            --outputMergedList mergedDomains.bed
            --outputRelationList relationList.txt
            --outputTreePlotFormat pdf
            --outputTreePlotPrefix relationship_tree_

            --threads @THREADS@

            && mkdir relationship_plots
            && cp relationship_tree_*.pdf relationship_plots
]]>
    </command>
    <inputs>
        <!-- <expand macro="matrix_h5_cooler_macro" /> -->

         <repeat name="domainFiles" title="Domain files from hicFindTADs of different resolutions to include.n" min="1">
            <param name="domainFile" type="bed" label='Domain files to include'>
                <validator type="empty_field" />
            </param>
        </repeat>
     
        <param argument="--proteinFile" type="bed" optional='false' label="Protein peak file in bed format" help= "In order to be able to better assess the relationship between TADs, the associated protein file (e.g. CTCF for mammals) can be included. The protein file is required in broadpeak forma" />
       
       
        <param argument="--minimumNumberOfPeaks" type="integer" optional='false' label="Minimum number of peaks" help="Optional parameter to adjust the number of protein peaks when adapting the resolution to the domain files. At least minimumNumberOfPeaks of unique peaks must be in a bin to considered. Otherwise the bin is treated like it has no peaks" value='1'/>
       
       
        <param argument="--value" type="int" label="TAD seperation value" help="Determine a value by how much the boundaries of two TADs must at least differ to consider them as two separate TADs" value='5000'/>
        <param argument="--percent" type="float" label="Percentage overlap" help="For the relationship determination, a percentage is required from which area coverage the TADs are related to each other. For example, a relationship should be entered from 5 percent area coverage -p 0.05 value=0.5" />
        
    </inputs>
    <outputs>
        <data name='outputMergedList' from_work_dir='mergedDomains.bed' format='bed' label='Computed parameters for hicDetectLoops'/>
        <data name='outputRelationList' from_work_dir='relationList.txt' format='txt' label='Computed parameters for hicDetectLoops'/>
        <collection name="plotCollection" type="list" label="Relationship tree plots">
            <discover_datasets pattern="__name__" format='pdf' directory="relationship_plots" />
        </collection>

        <!-- <data name='outputTreePlotFormat' from_work_dir='tree_plot.' format='txt' label='Computed parameters for hicDetectLoops'/> -->

    </outputs>
    <tests>
        <test>
            <param name="matrix_h5_cooler" value="small_test_matrix.cool"/>
            <param name="proteinFile" value=""/>
            <param name="maximumNumberOfLoops" value="5"/>
            <param name="resolution" value="2"/>
            <param name="runs" value="5"/>
            <output name="hyperopt_result" file="hicDetectLoops/loops.bedgraph" ftype="txt" compare="sim_size"/>

            <output_collection name="aggregatedFilesCollection" type="list" count="2">
                <element name="FL-E13-5_chr1_chr1_14300280_14300280_Eya1_aggregated.txt" file="cHi-C/chicAggregateStatistic/batch_mode/FL-E13-5_chr1_chr1_14300280_14300280_Eya1_aggregated.txt" ftype="interval" lines_diff="4"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[

Hyperopt parameter optimization loop detection
==============================================

Compute with a protein peak data file (bed format) optimal parameters for the loop calling. Useful proteins are e.g. CTCF or cohesin.

_________________

Usage
-----

A command line example is available below (easily matchable in Galaxy using each field information):

̀`$ hicHyperoptDetectLoops -m matrix.cool -o parameters.txt --maxLoopDistance 2000000 --windowSize 10 --peakWidth 6 --pValuePreselection 0.05 --pValue 0.05 --peakInteractionsThreshold 20`

The candidate selection is based on the restriction of the maximum genomic distance, here 2MB. This distance is given by Rao 2014. For each genomic distance a negative binomial distribution is computed and only interaction pairs with a threshold less than ``--pValuePreselection`` are accepted. Detected candidates need to have at least an interaction count of ``--maximumInteractionPercentageThreshold`` times the maximum value for their genomic distance. Please note that ``--maximumInteractionPercentageThreshold`` was introduced with HiCExplorer release 3.2. Earlier versions did not have this parameter yet and therefore their outputs may differ. In a second step, each candidate is considered compared to its neighborhood. This neighborhood is defined by the ``--windowSize`` parameter in the x and y dimension. Per neighborhood only one candidate is considered, therefore only the candidate with the highest peak values is accepted. As a last step, the neighborhood is split into a peak and background region (parameter ``--peakWidth``). The peakWidth can never be larger than the windowSize. However, we recommend for 10kb matrices a windowSize of 10 and a peakWidth of 6.

The output file (´´-o loops.bedgraph``) contains the x and y position of each loop and its corresponding p-value of the Anderson-Darling test.

`1   120000000       122500000       1       145000000       147500000       0.001`

The results can visualized via hicPlotMatrix:

`$ hicPlotMatrix -m matrix.cool -o plot.png --log1p --region 1:18000000-22000000 --loops loops.bedgraph`

.. image:: $PATH_TO_IMAGES/hicDetectLoops.png
   :width: 50%


For more information about HiCExplorer please consider our documentation on readthedocs.io_.

.. _readthedocs.io: http://hicexplorer.readthedocs.io/en/latest/index.html

]]></help>
    <expand macro="citations" />
</tool>
