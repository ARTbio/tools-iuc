<tool id="kma_map" name="Map with KMA" version="@TOOL_VERSION@_galaxy0">
    <description></description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kma</requirement>
    </requirements>
    <version_command>kma -v</version_command>
    <command detect_errors="exit_code">
        <![CDATA[
        kma
            -t \${GALAXY_SLOTS:-1}
	    -t_db '${kma_index.fields.path}'
            #if $single_paired.single_paired_selector == 'yes'
                -ipe '${single_paired.forward_input}' '${single_paired.reverse_input}'
            #elif $single_paired.single_paired_selector == "collection":
                -ipe '${single_paired.input_pair.forward}' '${single_paired.input_pair.reverse}'
            #else:
                -i '${single_paired.input_sequences}'
            #end if
            -k '${kmer_size}'
            -p '${p_value}'
            ${decontaminate}
            ${dense}
            ${ref_fsa}
            ${matrix}
            ${all_best_mappings}
            -mp '${minimum_phred_score}'
            -o output &&
	 gunzip output.frag.gz
	]]>
    </command>
    <inputs>
        <conditional name="single_paired">
            <param name="single_paired_selector" type="select" label="Single or paired reads" help="--paired">
                <option value="collection">Collection</option>
                <option value="yes">Paired</option>
                <option selected="True" value="no">Single</option>
            </param>
            <when value="collection">
                <param format="fastq" name="input_pair" type="data_collection" collection_type="paired" label="Collection of paired reads" help="FASTQ datasets" />
            </when>
            <when value="yes">
                <param format="fastq" name="forward_input" type="data" label="Forward strand" help="FASTQ dataset"/>
                <param format="fastq" name="reverse_input" type="data" label="Reverse strand" help="FASTQ dataset"/>
            </when>
            <when value="no">
                <param format="fastq" label="Input sequences" name="input_sequences" type="data" help="FASTQ datasets"/>
            </when>
        </conditional>

	<param name="kma_index" type="select">
	    <options from_data_table="kma_index">
	        <validator type="no_options" message="No KMA index available" />
            </options>
        </param>
        <param name="kmer_size" type="integer" min="4" value="16" max="32" label="Kmer Size" />
        <param name="p_value" type="float" min="0.0" value="0.05" max="1.0" label="p-value"/>
        <param name="exhaustive_mode" type="boolean" truevalue="-ex_mode" falsevalue="" label="Exhaustive Mode" />
        <param name="decontaminate" type="boolean" truevalue="-deCon" falsevalue="" label="Decontaminate" />
        <param name="dense" type="boolean" truevalue="-dense" falsevalue="" label="Do not allow insertions in assembly" />
        <param name="ref_fsa" type="boolean" truevalue="-ref_fsa" falsevalue="" label="Consensus sequence has 'n' instead of gaps" />
        <param name="matrix" type="boolean" truevalue="-matrix" falsevalue="" label="Print assembly matrix" />
        <param name="all_best_mappings" type="boolean" truevalue="-a" falsevalue="" label="Print all best mappings" />
        <param name="minimum_phred_score" type="integer" min="0" value="20" max="60" label="Minimum phred score" />
    </inputs>
    <outputs>
      <data name="result_overview" label="Result overview" format="tabular" from_work_dir="output.res" />
      <data name="consensus_alignment" label="Consensus alignment" format="fasta" from_work_dir="output.aln" />
      <data name="consensus_sequences" label="Consensus sequences" format="fasta" from_work_dir="output.fsa" />
      <data name="read_mapping" label="Read mapping info" format="tabular" from_work_dir="output.frag" />
    </outputs>
    <tests>
        <test>
            <param name="single_paired_selector" value="no"/>
            <param name="input_sequences" value="ERR884056_ecoli_b0842.mapped_R1.fastq" ftype="fastq"/>
            <param name="kmer_size" value="8"/>
            <param name="kma_index" value="test_index"/>
            <output name="result_overview" file="ERR884056.res" ftype="tabular"/>
            <output name="consensus_alignment" file="ERR884056.aln" ftype="fasta"/>
            <output name="consensus_sequences" file="ERR884056.fsa" ftype="fasta"/>
            <output name="read_mapping" file="ERR884056.frag" ftype="tabular"/>
        </test>
    </tests>
    <help>
      <![CDATA[
      ]]>
    </help>
    <expand macro="citations" />
</tool>
