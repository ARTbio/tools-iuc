<?xml version='1.0' encoding='utf-8'?>
<tool name="bcftools @EXECUTABLE@" id="bcftools_@EXECUTABLE@" version="@VERSION@.0">
  <description>Create consensus sequence by applying VCF variants to a reference fasta file.</description>
  <macros>
    <token name="@EXECUTABLE@">consensus</token>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="stdio" />
  <expand macro="version_command" />
  <command><![CDATA[cat $reference_fasta | bcftools @EXECUTABLE@

## Default section
#if str($sec_default.select_haplotype) != "__none__":
  --haplotype "${sec_default.select_haplotype}"
#end if
${sec_default.iupac_codes}
#if $sec_default.mask:
  --mask "${sec_default.mask}"
#end if

#if str($sec_default.chain) == "chain":
  --chain $chain_file
#end if

#if $sec_default.sample:
  --sample "${sec_default.sample}"
#end if

## Primary Input/Outputs

$input_file
>
$output_file]]></command>
  <inputs>
    <param name="reference_fasta" label="Reference Sequence" type="data" format="fasta" />
    <!-- MUST BE BGZIP compressed, whcih presents issues for us -->
    <param name="input_file" label="VCF/BCF Data" type="data" format="vcf_bgz,bcf_bgz" />
    <section name="sec_default" expanded="true" title="Default Options">
      <param name="select_haplotype" type="select" label="Apply variants for the given haplotype">
        <option value="__none__" selected="True">No selection</option>
        <option value="1">1</option>
        <option value="2">2</option>
      </param>
      <param name="iupac_codes" label="Iupac Codes" type="boolean" truevalue="--iupac-codes" falsevalue="" help="output variants in the form of IUPAC ambiguity codes" />
      <param name="mask" label="Mask regions with Ns" type="data" format="tabular" optional="True" help="Three column file used, a sequence ID, start, and end." />
      <param name="chain" label="Write a chain file for liftover" type="boolean" truevalue="chain" falsevalue="" optional="True" />
      <param name="sample" label="Apply variants of the given sample" type="text" optional="True" />
    </section>
  </inputs>
  <outputs>
    <data name="output_file" format="fasta" />
    <data name="chain_file" format="data">
      <filter>sec_default.chain == "chain"</filter>
    </data>
  </outputs>
  <tests>
    <test>
      <param name="reference_fasta" value="consensus.fa" />
      <param name="input_file" value="consensus.vcf.gz" />
      <param name="mask" value="consensus.tab" />
      <param name="chain" value="chain" />
      <output name="output_file" file="consensus.1.out" lines_diff="6"/>
      <output name="output_file" file="consensus.1.chain" />
    </test>
    <test>
      <param name="reference_fasta" value="consensus.fa" />
      <param name="input_file" value="consensus.vcf.gz" />
      <param name="select_haplotype" value="1" />
      <param name="mask" value="consensus.tab" />
      <param name="chain" value="chain" />
      <output name="output_file" file="consensus.2.out" lines_diff="6"/>
      <output name="output_file" file="consensus.2.chain" />
    </test>
    <test>
      <param name="reference_fasta" value="consensus.fa" />
      <param name="input_file" value="consensus.vcf.gz" />
      <param name="iupac_codes" value="--iupac-codes" />
      <param name="mask" value="consensus.tab" />
      <param name="chain" value="chain" />
      <output name="output_file" file="consensus.3.out" lines_diff="6"/>
      <output name="output_file" file="consensus.3.chain" />
    </test>
    <test>
      <param name="reference_fasta" value="consensus.fa" />
      <param name="input_file" value="consensus.vcf.gz" />
      <param name="select_haplotype" value="1" />
      <param name="chain" value="chain" />
      <output name="output_file" file="consensus.4.out" lines_diff="6"/>
      <output name="output_file" file="consensus.4.chain" />
    </test>
  </tests>
  <help><![CDATA[
bcftool consensus
=================

Create consensus sequence by applying VCF variants to a reference fasta
file.
]]></help>
  <expand macro="citations" />
</tool>
