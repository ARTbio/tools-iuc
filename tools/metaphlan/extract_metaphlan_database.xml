<tool id="extract_metaphlan_database" name="Extract the marker sequences and metadata" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>from the MetaPhlAn database</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="2.4.2">bowtie2</requirement>
    </expand>
    <version_command>metaphlan -v</version_command>
    <command detect_errors="aggressive"><![CDATA[
bowtie2-inspect
    '${cached_db.fields.path}/${cached_db.fields.dbkey}'
    > '$sequences'

&&

python '$__tool_directory__/customizemetadata.py'
    transform_pkl_to_json
    --pkl '${cached_db.fields.path}/${cached_db.fields.dbkey}.pkl'
    --json '$metadata'
    ]]></command>
    <inputs>
        <param name="cached_db" label="Cached database with clade-specific marker genes" type="select">
            <options from_data_table="metaphlan_database"/>
        </param>
    </inputs>
    <outputs>
        <data name="sequences" format="fasta" label="${tool.name} on ${on_string}: Marker seqeunces from MetaPhlAn database" />
        <data name="metadata" format="json" label="${tool.name} on ${on_string}: Marker metadata from MetaPhlAn database" />
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="cached_db" value="test-db-20210311"/>
            <output name="sequences" file="test-db.fasta" ftype="fasta" compare="sim_size">
                <assert_contents>
                    <has_line line=">1017__C2M2S1__CGC50_11255 UniRef90_C2M2S1;k__Bacteria|p__Bacteroidetes|c__Flavobacteriia|o__Flavobacteriales|f__Flavobacteriaceae|g__Capnocytophaga|s__Capnocytophaga_gingivalis;GCA_002302415"/>
                </assert_contents>
            </output>
            <output name="metadata" file="test-db.json" ftype="json" compare="sim_size">
                <assert_contents>
                    <has_text text="1017__C2M2S1__CGC50_11255"/>
                    <has_text text="k__Bacteria|p__Bacteroidetes|c__Flavobacteriia|o__Flavobacteriales|f__Flavobacteriaceae|g__Capnocytophaga|s__Capnocytophaga_gingivalis"/>
                    <has_text text="GCA_002302415"/>
                    <has_text text="clade"/>
                    <has_text text="ext"/>
                    <has_text text="len"/>
                    <has_text text="taxon"/>
                    <has_text text="markers"/>
                    <has_text text="taxonomy"/>
                    <has_text text="merged_taxon"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

Reconstruct the marker sequences (in fasta format) and metadata (in JSON) from the MetaPhlAn BowTie2 database

**Outputs**

- Fasta file with marker sequences.

    This file can be used to add new marker sequences and then customizing the database.

- JSON file with marker metadata
    ]]></help>
    <expand macro="citations"/>
</tool>
