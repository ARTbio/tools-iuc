<tool id="slamdunk" name="Slamdunk" version="0.3.3">
	<requirements>
		<requirement type="package" version="0.3.3">slamdunk</requirement>
	</requirements>
	<command detect_errors="exit_code"><![CDATA[
        slamdunk all -r '$Genome' -b '$Reference' -o ./out
        #if $multimapper.advanced == "advanced"
        	-n $multimapper.multimappers
        	$multimapper.multimap
        #end if
        #if $quantseq.advanced == "advanced"
        	-5 $quantseq.trim5
        	-a $quantseq.maxpolyA
        #end if
        #if $advanced.advanced == "advanced"
        	$advanced.endtoend
        	-mq $advanced.minMQ
        	-mi $advanced.minID
        	-nm $advanced.maxNM
        	-mc $advanced.minCov
        	-mv $advanced.minVar
        	-mbq $advanced.minBaseQual
        #end if
        -rl $readLength
        -c $covThresh
        '$Reads'
    ]]></command>
	<inputs>
		<param type="data" name="Genome" format="fasta" />
		<param type="data" name="Reference" format="bed" />
		<param type="data" name="Reads" format="fastqsanger" />
		<conditional name="multimapper">
			<param name="advanced" type="select" label="Multimapper recovery">
				<option value="simple" selected="true">Discard multimappers.
				</option>
				<option value="advanced">Recover multimappers.</option>
			</param>
			<when value="simple">
			</when>
			<when value="advanced">
				<param name="multimappers" type="integer"
					label="Maximum number of alignments to report per read" value="1"
					min="1"
					help="The maximum number of alignments is used to track multimapping read alignments. The more are allowed, the more sensitive the multimapper filtering will be, but also the longer the runtime will be. 100 was used in previous publications." />
				<param name="multimap" type="boolean"
					label="Use reference bed file to resolve multimappers." truevalue="--multimap"
					falsevalue=""
					help="Enable multimapper recovery, requires -n to be set to a value > 1 to have impact." />
			</when>
		</conditional>
		<conditional name="quantseq">
			<param name="advanced" type="select" label="Quantseq">
				<option value="simple" selected="true">I am using a QuantSeq kit.
				</option>
				<option value="advanced">I need custom trimming.</option>
			</param>
			<when value="simple">
			</when>
			<when value="advanced">
				<param name="trim5" type="integer"
					label="Number of bp to remove from the 5' end of all reads" value="12"
					min="0"
					help="For Lexogen's Quantseq kit and previous SLAMSeq papers a clipping of 12 bp from the 5' end is recommended." />
				<param name="maxpolyA" type="integer"
					label="Maximum number of As at the 3' end of a read" value="4" min="0"
					help="The maximum number of allowed As at the 3' end of a read. All A-stretches that exceed this threshold are clipped because they are likely part of the poly-A tail." />
			</when>
		</conditional>
		<conditional name="advanced">
			<param name="advanced" type="select" label="Advanced settings.">
				<option value="simple" selected="true">I will run with default
					recommended settings.
				</option>
				<option value="advanced">I need custom settings.</option>
			</param>
			<when value="simple">
			</when>
			<when value="advanced">
				<param name="endtoend" type="boolean"
					label="Enable end-to-end alignments for mapping." truevalue="--endtoend"
					falsevalue=""
					help="Enable end-to-end alignments for mapping in slamdunk with --endtoend" />
				<param name="minMQ" type="integer" label="Minimum mapping quality"
					value="2" min="0"
					help="Minimum mapping quality to consider alignments (default: 2)." />
				<param name="minMQ" type="integer" label="Minimum mapping quality"
					value="2" min="0"
					help="Minimum mapping quality to consider alignments (default: 2)." />
				<param name="minID" type="float" label="Minimum alignment identity"
					value="0.95" min="0"
					help="Minimum alignment-identity to consider alignments (default: 0.95)." />
				<param name="maxNM" type="integer" label="Maximum number of mismatches"
					value="-1"
					help="Maximum number of mismatches to consider alignments. Negative numbers deactivate filter (default: -1)." />
				<param name="minCov" type="integer" label="Minimum coverage to call variant"
					value="10" min="0" help="Minimum coverage to call variant (default: 10)." />
				<param name="minVar" type="float"
					label="Minimum variant fraction to call variant" value="0.8" min="0"
					help="Minimum variant fraction to call variant (default: 0.8)." />
				<param name="minBaseQual" type="integer" label="Minimum base quality"
					value="27" min="0"
					help="Minimum base quality for T>C conversions (default: 27)." />
			</when>
		</conditional>
		<param name="covThresh" type="integer" label="T>C conversion threshold"
			value="1" min="1"
			help="Number of T>C conversions required to count a read as a T>C read (default: 1)." />
		<param name="readLength" type="integer" label="Read length"
			value="50" min="50" help="Maximum read length (before trimming)." />
	</inputs>
	<outputs>
		<data name="output1" format="bam" from_work_dir="./out/filter/*.bam" />
		<data name="output2" format="tabular" from_work_dir="./out/count/*_tcount.tsv" />
	</outputs>
	<tests>
		<test>
			<param name="input1" value="ref.fa" />
			<param name="input2" value="actb.bed" />
			<param name="input3" value="reads.fq" />
			<output name="output1" file="output" />
		</test>
	</tests>
	<help><![CDATA[
        usage: slamdunk all [-h] -r REFERENCEFILE -b BED [-fb FILTERBED] -o OUTPUTDIR
                    [-5 TRIM5] [-a MAXPOLYA] [-n TOPN] [-t THREADS] [-q] [-e]
                    [-m] [-mq MQ] [-mi IDENTITY] [-nm NM] [-mc COV] [-mv VAR]
                    [-c CONVERSIONTHRESHOLD] [-rl MAXLENGTH] [-mbq MINQUAL]
                    [-i SAMPLEINDEX] [-ss]
                    files [files ...]

positional arguments:
  files                 Single csv/tsv file (recommended) containing all
                        sample files and sample info or a list of all sample
                        BAM/FASTA(gz)/FASTQ(gz) files

optional arguments:
  -h, --help            show this help message and exit
  -r REFERENCEFILE, --reference REFERENCEFILE
                        Reference fasta file
  -b BED, --bed BED     BED file with 3'UTR coordinates
  -fb FILTERBED, --filterbed FILTERBED
                        BED file with 3'UTR coordinates to filter multimappers
                        (activates -m)
  -o OUTPUTDIR, --outputDir OUTPUTDIR
                        Output directory for slamdunk run.
  -5 TRIM5, --trim-5p TRIM5
                        Number of bp removed from 5' end of all reads
                        (default: 12)
  -a MAXPOLYA, --max-polya MAXPOLYA
                        Max number of As at the 3' end of a read (default: 4)
  -n TOPN, --topn TOPN  Max. number of alignments to report per read (default:
                        1)
  -t THREADS, --threads THREADS
                        Thread number (default: 1)
  -q, --quantseq        Run plain Quantseq alignment without SLAM-seq scoring
  -e, --endtoend        Use a end to end alignment algorithm for mapping.
  -m, --multimap        Use reference to resolve multimappers (requires -n >
                        1).
  -mq MQ, --min-mq MQ   Minimum mapping quality (default: 2)
  -mi IDENTITY, --min-identity IDENTITY
                        Minimum alignment identity (default: 0.95)
  -nm NM, --max-nm NM   Maximum NM for alignments (default: -1)
  -mc COV, --min-coverage COV
                        Minimimum coverage to call variant (default: 10)
  -mv VAR, --var-fraction VAR
                        Minimimum variant fraction to call variant (default:
                        0.8)
  -c CONVERSIONTHRESHOLD, --conversion-threshold CONVERSIONTHRESHOLD
                        Number of T>C conversions required to count read as
                        T>C read (default: 1)
  -rl MAXLENGTH, --max-read-length MAXLENGTH
                        Max read length in BAM file
  -mbq MINQUAL, --min-base-qual MINQUAL
                        Min base quality for T -> C conversions (default: 27)
  -i SAMPLEINDEX, --sample-index SAMPLEINDEX
                        Run analysis only for sample <i>. Use for distributing
                        slamdunk analysis on a cluster (index is 1-based).
  -ss, --skip-sam       Output BAM while mapping. Slower but, uses less hard
                        disk.

    ]]></help>
	<citations>
		<citation type="bibtex">
			@misc{renameTODO,
			author = {LastTODO,
			FirstTODO},
			year = {TODO},
			title = {TODO},
			url =
			{http://t-neumann.github.io/slamdunk},
			}
		</citation>
	</citations>
</tool>