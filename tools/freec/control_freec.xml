<tool id="control_freec" name="control-freec" version="11.6">
    <description>a tool for assessing copy number and allelic content using next-generation sequencing data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="5.0.1">gawk</requirement>
        <requirement type="package" version="11.6">control-freec</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #set $genome_fasta_fn = 'genome.fa'
        #set $chr_dn = 'chromosomes'
        #set $out_dn = 'output'
        #set $input_control_file_fn = 'control.bam'
        #set $input_sample_file_fn = 'sample.bam'

        ln -s '$reference_source.ref' $genome_fasta_fn &&

        #if str($reference_source.ref_selector) == 'history':
            #set $chrLenFile = $genome_fasta_fn + '.fai'
            samtools faidx $genome_fasta_fn 2>&1 || echo "Error running samtools faidx for indexing fasta reference for control-freec" >&2 &&
        #else
            #set $chrLenFile = str($reference_source.ref.index.fields.path)
        #end if

        mkdir '$chr_dn' &&
        mkdir '$out_dn' &&

        awk -F " " '/^>/ {close(F); F="$chr_dn/chr"substr($1,2)".fa"} {print >> F}' $genome_fasta_fn &&

        ln -s '$input_sample_file' $input_sample_file_fn &&
        ln -s '$input_control_file' $input_control_file_fn &&

        freec
            -conf $script_file
            -sample $input_sample_file_fn
            -control $input_control_file_fn
    ]]></command>
    <configfiles>
    	<configfile name="script_file">
#import os
#set galaxy_slots = os.getenv("GALAXY_SLOTS", 4)
[general]
chrFiles = chromosomes
outputDir = output
chrLenFile = genome.fa.fai
maxThreads = $galaxy_slots

#if $advanced_general.advanced_general_button == True
    BedGraphOutput = $advanced_general.BedGraphOutput
    breakPointThreshold = $advanced_general.breakPointThreshold
    breakPointType = $advanced_general.breakPointType
    #if $advanced_general.contaminationAdjustment_selector.contaminationAdjustment == "TRUE"
        contaminationAdjustment = $advanced_general.contaminationAdjustment_selector.contaminationAdjustment
        contamination = $advanced_general.contaminationAdjustment_selector.contamination
    #end if
    degree = $advanced_general.degree
    forceGCcontentNormalization = $advanced_general.forceGCcontentNormalization
    intercept = $advanced_general.intercept
    minCNAlength = $advanced_general.minCNAlength
    minMappabilityPerWindow = $advanced_general.minMappabilityPerWindow
    minExpectedGC = $advanced_general.minExpectedGC
    maxExpectedGC = $advanced_general.maxExpectedGC
    minimalSubclonePresence = $advanced_general.minimalSubclonePresence
    noisyData = $advanced_general.noisyData
    ploidy = $advanced_general.ploidy
    printNA = $advanced_general.printNA
    readCountThreshold = $advanced_general.readCountThreshold
    sex = $advanced_general.sex
    #if $advanced_general.window_selector.window_bool == "50000"
        window = $advanced_general.window_selector.window
        step = $advanced_general.window_selector.step
    #else
        coefficientOfVariation = $advanced_general.coefficientOfVariation
    #end if
    telocentromeric = $advanced_general.telocentromeric
#end if

[sample]
mateFile = sample.bam
inputFormat = BAM
mateOrientation = $mateOrientation_selector

[control]
mateFile = control.bam
inputFormat = BAM
mateOrientation = $mateOrientation_selector
    	</configfile>
    </configfiles>
    <inputs>
		<param name="input_sample_file" type="data" format="bam" multiple="false" label="Sample File" help="Sample file in .BAM format."/>
		<param name="input_control_file" type="data" format="bam" multiple="false" label="Control File" help="Control file in .BAM format."/>
        <param name="mateOrientation_selector" type="select" label="Format of reads" help="If you specify orientation of your reads then only reads mapping in the corresponding orientation will be used for calculation of copy number profiles.">
            <option value="0" selected="True">single-end</option>
            <option value="RF">Illumina mate-pair</option>
            <option value="FR">Illumina paired-end</option>
            <option value="FF">SOLiD mate-pair</option>
        </param>
        <expand macro="reference_interface"/>
        <conditional name="advanced_general">
            <param name="advanced_general_button" type="boolean" checked="false" label="Advanced tool settings"/>
            <when value="false"/>
            <when value="true">
                <!-- general parameters -->
                    <param name="BedGraphOutput" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="BedGraph Output for UCSC genome browser" help="Set &quot;Yes&quot; if you want an additional output in BedGraph format for the UCSC genome browser."/>
                    <param name="breakPointThreshold" type="float" label="Segmentation of normalized profiles (break point)" value="0.8" help="Positive value of threshold for segmentation of normalized profiles. Use something like 0.6 to get more segments (and thus more predicted CNVs)."/>
                    <param name="breakPointType" type="select" label="Desired behavior in the ambiguous regions">
                        <option value="0" selected="true">(0) the "unknown" region is attached to the "known" region on the right</option>
                        <option value="1">(1) make a separate fragment of this "unknown" region and then attaches it to the left or to the right region choosing the longer one</option>
                        <option value="2">(2) make a separate fragment of this "unknown" region and then attaches it to the left or to the right region but the "ploidy" copy number has a priority</option>
                        <option value="3">(3) make a separate fragment of this "unknown" region and then attaches it to the left or to the right region choosing the longer one but this "known" region should make at least half-size of the "unknown" region</option>
                        <option value="4">(4) make a separate fragment of this "unknown" region and do not assign any copy number to this region at all</option>
                    </param>
                    <param name="coefficientOfVariation" type="float" label="Coefficient of variation to evaluate necessary window size" value="0.05"/>
                    <conditional name="contaminationAdjustment_selector">
                        <param name="contaminationAdjustment" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Adjust sample contamination?" help="a priori known value of tumor sample contamination by normal cells. Set &quot;Yes&quot; to correct for contamination by normal cells. If &quot;contamination&quot; is not provided, it will automatically evaluate the level of contamination."/>
                        <when value="FALSE"/>
                        <when value="TRUE">
                            <param name="contamination" type="float" label="Sample contamination by normal cells" value="0" help="Ex: contamination=0.25"/>
                        </when>
                    </conditional>
                    <param name="degree" type="select" label="Degree of polynomial" help="">
                        <option value="3&#38;4" selected="True">(3&amp;4) GC-content based normalization, WGS</option>
                        <option value="1">(1) control-read-count-based normalization, WES</option>
                    </param>
                    <param name="forceGCcontentNormalization" type="select" label="Read Count (RC) correction for GC-content bias and low mappability" help="Set to 1 or 2 to correct the Read Count (RC) for GC-content bias and low mappability even when you have a control sample. - Default (WGS): 0
                         - Default (WES): 1 (&gt;= v9.5) and 0 (&lt; v9.5)">
                        <option value="0" selected="True">(0) simply model "sample RC ~ Control RC"</option>
                        <option value="1">(1) normalize the sample and the control RC using GC-content and then calculate the ratio "Sample RC/contol RC"</option>
                        <option value="2">(2) model "sample RC ~ Control RC" bias, and then normalize for GC-content</option>
                    </param>
                    <!-- GCcontentProfile -->
                    <!-- gemMappabilityFile -->
                    <param name="intercept" type="select" label="Intercept of polynomial" help="">
                        <option value="0">(0) with a control dataset</option>
                        <option value="1" selected="True">(1) with GC-content</option>
                    </param>
                    <param name="minCNAlength" type="select" label="Minimal number of consecutive windows to call a CNA" help="">
                        <option value="1" selected="True">(0) WGS</option>
                        <option value="3">(3) WES</option>
                    </param>
                    <param name="minMappabilityPerWindow" type="float" label="Minimal mappability per window" value="0.85" help="Only windows with fraction of mappable positions higher than or equal to this threshold will be considered (if &quot;gemMappabilityFile&quot; is not provided, one uses the percentage of non-N letters per window)"/>
                    <param name="minExpectedGC" type="float" label="Minimal expected value of the GC-content" value="0.35" help="Minimal expected value of the GC-content for the prior evaluation of &quot;Read Count ~ GC-content&quot; dependency. Change only if you run Control-FREEC on a bacterial genome."/>
                    <param name="maxExpectedGC" type="float" label="Maximal expected value of the GC-content" value="0.55" help="Maximal expected value of the GC-content for the prior evaluation of &quot;Read Count ~ GC-content&quot; dependency. Change only if you run Control-FREEC on a bacterial genome."/>
                    <param name="minimalSubclonePresence" type="integer" label="Detects subclones present in x% of cell population" value="100" help="Default: 100 (meaning &quot;do not look for subclones&quot;) Suggested: 20 for WGS and 30 for WES."/>
                    <param name="noisyData" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Noisy Data" help="Set &quot;Yes&quot; for target resequencing data (e.g., exome-seq) to avoid false positive predictions due to non-uniform capture"/>
                    <!-- ploidy data type possibly wrong -->
                    <param name="ploidy" type="text" value="2" label="Genome ploidy" help="In case of doubt, you can set different values and Control-FREEC will select the one that explains most observed CNAs. Ex: 2 or 2,3,4"/>
                    <param name="printNA" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Print NA to avoid &quot;-1&quot;" help="Set &quot;No&quot; to avoid printing &quot;-1&quot; to the _ratio.txt files. Useful for exome-seq or targeted sequencing data."/>
                    <param name="readCountThreshold" type="integer" label="Threshold on the minimal number of reads per window" value="10" help="Threshold on the minimal number of reads per window in the control sample. Useful for exome-seq or targeted sequencing data. Default: 10 recommended value >=50 for for exome data."/>
                    <param name="sex" type="text" value="" label="Sample sex" help="&quot;XX&quot; will exclude chr Y from the analysis. &quot;XY&quot; will not annotate one copy of chr X and Y as a loss."/>
                    <conditional name="window_selector">
                        <param name="window_bool" type="boolean" checked="false" truevalue="50000" falsevalue="0" label="Window size" help="Set &quot;Yes&quot; to change window size. Higher priority than coefficientOfVariation. Ex: for whole genome sequencing: &quot;50000&quot; for whole exome sequencing: &quot;0&quot;"/>
                        <when value="50000">
                            <param name="window" type="integer" value="50000" label="Explicit window size" help=""/>
                            <param name="step" type="integer" value="10000" label="Step" help="Used only when &quot;window&quot; is specified. Do not use for exome sequencing (instead set &quot;0&quot;). Ex: 10000"/>
                        </when>
                    </conditional>
                    <param name="telocentromeric" type="integer" value="50000" label="Length of pre-telomeric and pre-centromeric regions" help="Control-FREEC will not output small CNAs and LOH found within these regions (they are likely to be false because of mappability/genome assembly issues). 50000 is OK for human/mouse genomes. Use smaller values for yeasts and flies."/>
                    <!-- uniqueMatch if true -> gemMappabilityFile is needed-->
                <!-- BAF parameters -->
                    <!-- makePileup: path to a BED or VCF file with SNP positions -->
                    <!-- fastaFile -->
                    <!-- minimalCoveragePerPosition -->
                    <!-- minimalQualityPerPosition -->
                    <!-- shiftInQuality -->
                    <!-- SNPfile -->
                <!-- target parameters -->
                    <!-- captureRegions: file with capture regions in .BED format -->
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="sample.bam_sample" format="tabular" label="Raw copy number profiles (sample) on ${tool.name} on ${on_string}" from_work_dir="output/sample.bam_sample.cpn"/>
        <data name="control.bam_control" format="tabular" label="Raw copy number profiles (control) on ${tool.name} on ${on_string}" from_work_dir="output/control.bam_control.cpn"/>
        <data name="sample" format="tabular" label="Coordinates of predicted CN alterations on ${tool.name} on ${on_string}" from_work_dir="output/sample.bam_CNVs"/>
        <data name="sample.bam_info" format="txt" label="Information about FREEC run on ${tool.name} on ${on_string}" from_work_dir="output/sample.bam_info.txt"/>
        <data name="sample.bam_ratio" format="tabular" label="Ratios and predicted CN alterations for each window on ${tool.name} on ${on_string}" from_work_dir="output/sample.bam_ratio.txt"/>
        <data name="sample.bam_ratio.BedGraph" format="bed" label="Ratios in BedGraph format on ${tool.name} on ${on_string}" from_work_dir="output/sample.bam_ratio.BedGraph">
            <filter>advanced_general['BedGraphOutput'] == True</filter>
        </data>
    </outputs>
    <!--
    <tests>
        <test>
            <param name="main" value="Example XY Plot"/>
            <param name="xlab" value="Column 1"/>
            <param name="ylab" value="Column 2"/>
            <param name="outftype" value="pdf"/>
            <param name="input" value="2.tabular" ftype="tabular"/>
            <param name="xcol" value="1"/>
            <param name="ycol" value="2"/>
            <param name="type" value="line"/>
            <param name="lty" value="2"/>
            <param name="col" value="2"/>
            <param name="lwd" value="1.0"/>
            <output name="out_file_pdf" file="XY_Plot_1_out.pdf" ftype="pdf" compare="sim_size" />
        </test>
        <test> <!- test with file with header line, NA values, multiple ycols and PNG output ->
            <param name="main" value="Example XY Plot PNG"/>
            <param name="xlab" value="xlab"/>
            <param name="ylab" value="ylab"/>
            <param name="outftype" value="png"/>
            <param name="series_0|input" value="testinput2.tsv" ftype="tabular"/>
            <param name="series_0|header" value="TRUE"/>
            <param name="series_0|xcol" value="1"/>
            <param name="series_0|ycol" value="2,3"/>
            <param name="series_0|type" value="points"/>
            <param name="series_0|pch" value="1"/>
            <param name="series_0|col" value="2"/>
            <param name="series_0|cex" value="1.0"/>
            <output name="out_file_png" ftype="png" file="testoutput.png" compare="sim_size" />
        </test>
    </tests>
    -->
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
     <citations>
         <citation type="doi">10.1093/bioinformatics/btr670</citation>
         <citation type="doi">10.1093/bioinformatics/btq635</citation>
    </citations>
</tool>
