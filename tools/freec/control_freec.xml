<tool id="control_freec" name="Control-FREEC" version="@WRAPPER_VERSION@">
    <description>detects copy-number changes and allelic imbalances</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="4.0.2">R</requirement>
        <requirement type="package" version="5.0.1">gawk</requirement>
        <requirement type="package" version="11.6">control-freec</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #set $genome_fasta_fn = 'genome.fa'
        #set $chr_dn = 'chromosomes'
        #set $out_dn = 'output'
        #set $input_control_file_fn = 'control.bam'
        #set $input_sample_file_fn = 'sample.bam'

        ln -s '$reference_source.ref' $genome_fasta_fn &&

        #if str($reference_source.ref_selector) == 'history':
            #set $chrLenFile = $genome_fasta_fn + '.fai'
            samtools faidx $genome_fasta_fn 2>&1 || echo "Error running samtools faidx for indexing fasta reference for control-freec" >&2 &&
        #else
            #set $chrLenFile = str($reference_source.ref.index.fields.path)
        #end if

        mkdir '$chr_dn' &&
        mkdir '$out_dn' &&

        awk -F " " '/^>/ {close(F); F="$chr_dn/chr"substr($1,2)".fa"} {print >> F}' $genome_fasta_fn &&

        ln -s '$input_sample_file' $input_sample_file_fn &&
        #if $input_control_file
            ln -s '$input_control_file' $input_control_file_fn &&
        #end if

        freec
            -conf $script_file
            -sample $input_sample_file_fn
            #if $input_control_file
                -control $input_control_file_fn
            #end if

        #if $WGS_WES.advanced_settings.makeGraph
            && cat `which makeGraph.R` | R --slave --args $WGS_WES.advanced_settings.ploidy output/sample.bam_ratio.txt
        #end if
    ]]></command>
    <configfiles>
    	<configfile name="script_file">
#import os
#set galaxy_slots = os.getenv("GALAXY_SLOTS", 4)
[general]
chrFiles = chromosomes
outputDir = output
chrLenFile = genome.fa.fai
maxThreads = $galaxy_slots

#if $WGS_WES.advanced_settings.degree == "34"
    #set $degree_val = "3&amp;4"
    degree = $degree_val
#else
    degree = $WGS_WES.advanced_settings.degree
#end if
forceGCcontentNormalization = $WGS_WES.advanced_settings.forceGCcontentNormalization
minCNAlength = $WGS_WES.advanced_settings.minCNAlength
minimalSubclonePresence = $WGS_WES.advanced_settings.minimalSubclonePresence
readCountThreshold = $WGS_WES.advanced_settings.readCountThreshold
window = $WGS_WES.advanced_settings.window_section.window
step = $WGS_WES.advanced_settings.window_section.step
coefficientOfVariation = $WGS_WES.advanced_settings.coefficientOfVariation
BedGraphOutput = $WGS_WES.advanced_settings.BedGraphOutput
breakPointThreshold = $WGS_WES.advanced_settings.breakPointThreshold
breakPointType = $WGS_WES.advanced_settings.breakPointType
contaminationAdjustment = $WGS_WES.advanced_settings.contaminationAdjustment
contamination = $WGS_WES.advanced_settings.contamination
intercept = $WGS_WES.advanced_settings.intercept
minMappabilityPerWindow = $WGS_WES.advanced_settings.minMappabilityPerWindow
minExpectedGC = $WGS_WES.advanced_settings.minExpectedGC
maxExpectedGC = $WGS_WES.advanced_settings.maxExpectedGC
noisyData = $WGS_WES.advanced_settings.noisyData
ploidy = $WGS_WES.advanced_settings.ploidy
printNA = $WGS_WES.advanced_settings.printNA
sex = $WGS_WES.advanced_settings.sex
telocentromeric = $WGS_WES.advanced_settings.telocentromeric

[sample]
mateFile = sample.bam
inputFormat = BAM
mateOrientation = $mateOrientation_selector

[control]
mateFile = control.bam
inputFormat = BAM
mateOrientation = $mateOrientation_selector
    	</configfile>
    </configfiles>
    <inputs>
        <expand macro="reference_interface" />
		<param name="input_sample_file" type="data" format="bam" multiple="false" label="Sample file" help="Sample file in .BAM format." />
        <param name="input_control_file" type="data" optional="true" format="bam" multiple="false" label="Control file" help="Control file in .BAM format. Mandatory for WES, optional for WGS." />
        <param name="mateOrientation_selector" type="select" display="radio" label="Format of reads" help="If you specify orientation of your reads then only reads mapping in the corresponding orientation will be used for calculation of copy number profiles.">
            <option value="0" selected="True">single-end (0)</option>
            <option value="RF">Illumina mate-pair (RF)</option>
            <option value="FR">Illumina paired-end (FR)</option>
            <option value="FF">SOLiD mate-pair (FF)</option>
        </param>
        <conditional name="WGS_WES">
            <param name="WGS_WES_selector" type="select" label="Set default parameters" help="">
                <option value="WGS" selected="True">whole-genome sequencing (WGS)</option>
                <option value="WES">whole-exome sequencing (WES)</option>
                <option value="other">other</option>
            </param>
            <when value="WGS">
                <section name="advanced_settings" title="Advanced WGS settings" expanded="false">
                    <expand macro="WGS" />
                    <expand macro="shared" />
                </section>
            </when>
            <when value="WES">
                <section name="advanced_settings" title="Advanced WES settings" expanded="false">
                    <expand macro="WES" />
                    <expand macro="shared" />
                </section>
            </when>
            <when value="other">
                <section name="advanced_settings" title="Advanced settings" expanded="true">
                    <expand macro="other" />
                </section>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="sample.bam_sample" format="tabular" label="${tool.name} on ${on_string}: Raw copy number profiles (sample)" from_work_dir="output/sample.bam_sample.cpn" />
        <data name="control.bam_control" format="tabular" label="${tool.name} on ${on_string}: Raw copy number profiles (control)" from_work_dir="output/control.bam_control.cpn" />
        <data name="sample" format="tabular" label="${tool.name} on ${on_string}: Coordinates of predicted CN alterations" from_work_dir="output/sample.bam_CNVs" />
        <data name="sample.bam_info" format="txt" label="${tool.name} on ${on_string}: Information about FREEC run" from_work_dir="output/sample.bam_info.txt" />
        <data name="sample.bam_ratio" format="tabular" label="${tool.name} on ${on_string}: Ratios and predicted CN alterations for each window" from_work_dir="output/sample.bam_ratio.txt" />
        <data name="sample.bam_subclones.txt" format="txt" label="${tool.name} on ${on_string}: Subclones" from_work_dir="output/sample.bam_subclones.txt" >
            <filter>int(WGS_WES['advanced_settings']['minimalSubclonePresence']) != 100</filter>
        </data>
        <data name="sample.bam_ratio.BedGraph" format="bed" label="${tool.name} on ${on_string}: Ratios in BedGraph format" from_work_dir="output/sample.bam_ratio.BedGraph">
            <filter>WGS_WES['advanced_settings']['BedGraphOutput']</filter>
        </data>
        <data name="sample.bam_ratio.txt.png" format="png" label="${tool.name} on ${on_string}: Normalized CN profile" from_work_dir="output/sample.bam_ratio.txt.png">
            <filter>WGS_WES['advanced_settings']['makeGraph']</filter>
        </data>
        <data name="sample.bam_ratio.txt.log2.png" format="png" label="${tool.name} on ${on_string}: Normalized CN profile (log2)" from_work_dir="output/sample.bam_ratio.txt.log2.png">
            <filter>WGS_WES['advanced_settings']['makeGraph']</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input_sample_file" ftype="bam" value="P0667T_GATKrealigned_duplicates_marked.bam" />
		    <param name="input_control_file" ftype="bam" value="P0667N_GATKrealigned_duplicates_marked.bam" />
            <param name="mateOrientation_selector" value="0" />
            <param name="ref_selector" value="history" />
            <param name="ref" ftype="fasta" value="human_g1k_v37.fasta" />
            <param name="WGS_WES_selector" value="other" />
            <output name="sample.bam_sample" file="output/sample.bam_sample.cpn" />
            <output name="control.bam_control" file="output/control.bam_control.cpn" />
            <output name="sample" file="output/sample.bam_CNVs" />
            <output name="sample.bam_info" file="output/sample.bam_info.txt" />
            <output name="sample.bam_ratio" file="output/sample.bam_ratio.txt" />
        </test>
    </tests>
    <help><![CDATA[
        **What it does**
    ]]></help>
     <citations>
         <citation type="doi">10.1093/bioinformatics/btr670</citation>
         <citation type="doi">10.1093/bioinformatics/btq635</citation>
    </citations>
</tool>
