<tool id="control_freec" name="control-freec" version="11.6">
    <description>a tool for assessing copy number and allelic content using next-generation sequencing data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="3.7">python</requirement>
        <requirement type="package" version="11.6">control-freec</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #set $genome_fasta_fn = 'genome.fa'
        #set $chr_path = 'chromosomes'
        #set $input_control_file_fn = 'control.bam'
        #set $input_sample_file_fn = 'sample.bam'

        ln -s '$reference_source.ref' $genome_fasta_fn &&

        #if str($reference_source.ref_selector) == 'history':
            #set $chrLenFile = $genome_fasta_fn + '.fai'
            samtools faidx $genome_fasta_fn 2>&1 || echo "Error running samtools faidx for indexing fasta reference for control-freec" >&2 &&
        #else
            #set $chrLenFile = str($reference_source.ref.index.fields.path)
        #end if

        mkdir outputDir
        mkdir '$chr_path' &&
        awk -F "|" '/^>/ {close(F) ; F = "$chr_path/"$1".fasta"} {print >> F}' $genome_fasta_fn &&
        python '$__tool_directory__/rn_chr_files.py' -g '$genome_fasta_fn' -f $chr_path -s '.fa' -p 'chr' &&

        ln -s '$input_control_file' $input_control_file_fn &&
        ln -s '$input_sample_file' $input_sample_file_fn &&

        freec
        	-conf $script_file &&
    ]]></command>
    <configfiles>
    	<configfile name="script_file">
			[general]
            chrFiles = "chromosomes/"
			chrLenFile = genome.fa.fai
            outputDir = "outputDir/"
            maxThreads = 6

            #if $advanced_general.advanced_general_button.value == True
                #if $advanced_general.window_selector.window_bool.value == "50000"
                    window = $window
                #else
                    window = 0
                #end if

                ploidy = $advanced_general.ploidy.value
                breakPointType = $advanced_general.breakPointType.value
                breakPointThreshold = $advanced_general.breakPointThreshold.value
                noisyData = $advanced_general.noisyData.value
                printNA = $advanced_general.printNA.value
                readCountThreshold = $advanced_general.readCountThreshold.value
            #end if

			[sample]
			mateFile = $input_sample_file
			inputFormat = bam
			mateOrientation = $mateOrientation_selector.value

			[control]
			mateFile = $input_control_file
			inputFormat = bam
			mateOrientation = $mateOrientation_selector.value
    	</configfile>
    </configfiles>
    <inputs>
		<param name="input_sample_file" type="data" format="bam" multiple="false" label="Sample File" help="Sample file in .BAM format."/>
		<param name="input_control_file" type="data" format="bam" multiple="false" label="Control File" help="Control file in .BAM format."/>
        <param name="mateOrientation_selector" type="select" label="Format of reads" help="If you specify orientation of your reads then only reads mapping in the corresponding orientation will be used for calculation of copy number profiles.">
            <option value="0" selected="True">single-end</option>
            <option value="RF">Illumina mate-pair</option>
            <option value="FR">Illumina paired-end</option>
            <option value="FF">SOLiD mate-pair</option>
        </param>
        <expand macro="reference_interface"/>
        <conditional name="advanced_general">
            <param name="advanced_general_button" type="boolean" checked="false" label="Advanced tool settings"/>
            <when value="false"/>
            <when value="true">
                <!-- general parameters -->
                    <param name="BedGraphOutput" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="BedGraph Output for UCSC genome browser" help="Set &quot;Yes&quot; if you want an additional output in BedGraph format for the UCSC genome browser."/>
                    <!-- bedtools -->
                    <param name="breakPointThreshold" type="float" label="Segmentation of normalized profiles (break point)" value="0.8" help="Positive value of threshold for segmentation of normalized profiles. Use something like 0.6 to get more segments (and thus more predicted CNVs)."/>
                    <param name="breakPointType" type="integer" label="Desired behavior in the ambiguous regions" value="2" help="
                        Desired behavior in the ambiguous regions (poly-N or low mappability regions between two different copy number values).
                         - 0: the &quot;unknown&quot; region is attached to the &quot;known&quot; region on the right
                         - 1: make a separate fragment of this &quot;unknown&quot; region and then attaches it to the left or to the right region choosing the longer one
                         - 2: make a separate fragment of this &quot;unknown&quot; region and then attaches it to the left or to the right region but the &quot;ploidy&quot; copy number has a priority
                         - 3: make a separate fragment of this &quot;unknown&quot; region and then attaches it to the left or to the right region choosing the longer one but this &quot;known&quot; region should make at least half-size of the &quot;unknown&quot; region
                         - 4: make a separate fragment of this &quot;unknown&quot; region and do not assign any copy number to this region at all"/>
                    <!-- chrFiles -->
                    <!-- chrLenFile -->
                    <param name="coefficientOfVariation" type="float" label="Coefficient of variation to evaluate necessary window size" value="0.05"/>
                    <conditional name="contaminationAdjustment_selector">
                        <param name="contaminationAdjustment" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Adjust sample contamination?" help="a priori known value of tumor sample contamination by normal cells. Set &quot;Yes&quot; to correct for contamination by normal cells. If &quot;contamination&quot; is not provided, it will automatically evaluate the level of contamination."/>
                        <when value="FALSE"/>
                        <when value="TRUE">
                            <param name="contamination" type="float" label="Sample contamination by normal cells" value="0" help="Ex: contamination=0.25"/>
                        </when>
                    </conditional>
                    <param name="degree_selector" type="select" label="Degree of polynomial" help="">
                        <option value="3&amp;4" selected="True">GC-content based normalization, WGS</option>
                        <option value="1">control-read-count-based normalization, WES</option>
                    </param>
                    <param name="forceGCcontentNormalization" type="integer" label="Read Count (RC) correction for GC-content bias and low mappability" value="0" help="
                        Set to 1 or 2 to correct the Read Count (RC) for GC-content bias and low mappability even when you have a control sample.
                         - 0: simply model &quot;sample RC ~ Control RC&quot;
                         - 1: normalize the sample and the control RC using GC-content and then calculate the ratio &quot;Sample RC/contol RC&quot;
                         - 2: model &quot;sample RC ~ Control RC&quot; bias, and then normalize for GC-content
                         - Default (WGS): 0
                         - Default (WES): 1 (&gt;= v9.5) and 0 (&lt; v9.5)"/>
                    <!-- GCcontentProfile -->
                    <!-- gemMappabilityFile -->
                    <param name="intercept" type="select" label="Intercept of polynomial" help="">
                        <option value="1" selected="True">with GC-content</option>
                        <option value="0">with a control dataset</option>
                    </param>
                    <param name="minCNAlength" type="select" label="Minimal number of consecutive windows to call a CNA" help="">
                        <option value="1" selected="True">0 (WGS)</option>
                        <option value="3">3 (WES)</option>
                    </param>
                    <param name="minMappabilityPerWindow" type="float" label="Minimal mappability per window" value="0.85" help="Only windows with fraction of mappable positions higher than or equal to this threshold will be considered (if &quot;gemMappabilityFile&quot; is not provided, one uses the percentage of non-N letters per window)"/>
                    <param name="minExpectedGC" type="float" label="Minimal expected value of the GC-content" value="0.35" help="Minimal expected value of the GC-content for the prior evaluation of &quot;Read Count ~ GC-content&quot; dependency. Change only if you run Control-FREEC on a bacterial genome."/>
                    <param name="maxExpectedGC" type="float" label="Maximal expected value of the GC-content" value="0.55" help="Maximal expected value of the GC-content for the prior evaluation of &quot;Read Count ~ GC-content&quot; dependency. Change only if you run Control-FREEC on a bacterial genome."/>
                    <param name="minimalSubclonePresence" type="integer" label="Detects subclones present in x% of cell population" value="100" help="Default: 100 (meaning &quot;do not look for subclones&quot;) Suggested: 20 for WGS and 30 for WES."/>
                    <!-- maxThreads -->
                    <param name="noisyData" type="boolean" checked="false" truevalue="TRUE" falsevalue="FALSE" label="Noisy Data" help="Set &quot;Yes&quot; for target resequencing data (e.g., exome-seq) to avoid false positive predictions due to non-uniform capture"/>
                    <!-- outputDir -->
                    <!-- ploidy data type possibly wrong -->
                    <param name="ploidy" type="text" value="2" label="Genome ploidy" help="In case of doubt, you can set different values and Control-FREEC will select the one that explains most observed CNAs. Ex: 2 or 2,3,4"/>
                    <param name="printNA" type="boolean" checked="true" truevalue="TRUE" falsevalue="FALSE" label="Print NA to avoid &quot;-1&quot;" help="Set &quot;No&quot; to avoid printing &quot;-1&quot; to the _ratio.txt files. Useful for exome-seq or targeted sequencing data."/>
                    <param name="readCountThreshold" type="integer" label="Threshold on the minimal number of reads per window" value="10" help="Threshold on the minimal number of reads per window in the control sample. Useful for exome-seq or targeted sequencing data. Default: 10 recommended value >=50 for for exome data."/>
                    <!-- sambamba -->
                    <!-- SambambaThreads -->
                    <!-- samtools -->
                    <param name="sex" type="text" value="" label="Sample sex" help="&quot;XX&quot; will exclude chr Y from the analysis. &quot;XY&quot; will not annotate one copy of chr X and Y as a loss."/>
                    <conditional name="window_selector">
                        <param name="window_bool" type="boolean" checked="false" truevalue="50000" falsevalue="0" label="Window size" help="Set &quot;Yes&quot; to change window size. Higher priority than coefficientOfVariation. Ex: for whole genome sequencing: &quot;50000&quot; for whole exome sequencing: &quot;0&quot;"/>
                        <when value="50000">
                            <param name="window" type="integer" value="50000" label="Explicit window size" help=""/>
                            <param name="step" type="integer" value="10000" label="Step" help="Used only when &quot;window&quot; is specified. Do not use for exome sequencing (instead set &quot;0&quot;). Ex: 10000"/>
                        </when>
                    </conditional>
                    <param name="telocentromeric" type="integer" value="50000" label="Length of pre-telomeric and pre-centromeric regions" help="Control-FREEC will not output small CNAs and LOH found within these regions (they are likely to be false because of mappability/genome assembly issues). 50000 is OK for human/mouse genomes. Use smaller values for yeasts and flies."/>
                    <!-- uniqueMatch if true -> gemMappabilityFile is needed-->
                <!-- BAF parameters -->
                    <!-- makePileup: path to a BED or VCF file with SNP positions -->
                    <!-- fastaFile -->
                    <!-- minimalCoveragePerPosition -->
                    <!-- minimalQualityPerPosition -->
                    <!-- shiftInQuality -->
                    <!-- SNPfile -->
                <!-- target parameters -->
                    <!-- captureRegions: file with capture regions in .BED format -->
            </when>
        </conditional>
    </inputs>
    <outputs>
    </outputs>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
     <citations>
         <citation type="doi">10.1093/bioinformatics/btr670</citation>
         <citation type="doi">10.1093/bioinformatics/btq635</citation>
    </citations>
</tool>
