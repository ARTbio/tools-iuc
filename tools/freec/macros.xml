<macros>
    <!--<token name="@WRAPPER_VERSION@">@TOOL_VERSION@+galaxy</token>
    <token name="@TOOL_VERSION@">2.1.3.1</token>-->
    <token name="@PREPARE_REF@"><![CDATA[
        #set $genome_fasta_fn = 'genome.fa'
        #set $input_control_file_fn = 'control.bam'
        #set $input_sample_file_fn = 'sample.bam'

        ln -s '$reference_source.ref' $genome_fasta_fn &&

        #if str($reference_source.ref_selector) == 'history':
            #set $chrLenFile = $genome_fasta_fn.fai
            samtools faidx $genome_fasta_fn 2>&1 || echo "Error running samtools faidx for indexing fasta reference for control-freec" >&2 &&
        #else
            #set $chrLenFile = str($reference_source.ref.index.fields.path)
        #end if

        python '$__tool_directory__/split_to_chr.py' -g '$genome_fasta_fn' -f 'chromosomes' -s '.fa' -p 'chr'
    ]]></token>
    <xml name="reference_interface">
        <conditional name="reference_source">
            <param name="ref_selector" type="select" label="Choose the source for the reference genome">
                <option value="cached">Locally cached</option>
                <option value="history">History</option>
            </param>
            <when value="cached">
                <param argument="--ref" type="select" label="Reference genome">
                    <options from_data_table="fasta_indexes">
                        <filter type="data_meta" column="dbkey" key="dbkey" ref="input_sample_file" />
                        <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file" />
                    </options>
                </param>
            </when>
            <when value="history">
                <param argument="--ref" type="data" format="fasta" label="Reference" help="Reference sequence" />
            </when>
        </conditional>
    </xml>
</macros>
