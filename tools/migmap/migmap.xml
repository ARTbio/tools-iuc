<tool id="migmap" name="MiGMAP: mapper for full-length T- and B-cell repertoire sequencing" version="1.0.2.1">
    <description>This software is a smart wrapper for IgBlast V-(D)-J mapping tool designed to facilitate analysis immune receptor libraries profiled using high-throughput sequencing</description>
    <requirements>
	 <requirement type="package" version="1.0.2">migmap</requirement>	
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command detect_errors='exit_code'><![CDATA[
       export IGBLAST_PATH=\$(dirname \$(which igblastn)) &&
       migmap 
	 $allow_incomplete
         $allow_no_cdr3
         $allow_noncanonical
         $allow_noncoding
         $all_alleles 
         #if str($qual_threshold) :
         -q $qual_threshold
         #end if
         -p "\${GALAXY_SLOTS:-4}"
         --data-dir "\${IGBLAST_PATH}/../share/igblast"
         -S $species 
         -R $receptor_list
         --report "$report" 
         "$input" 
         "$output"
    ]]></command>
    <inputs>
        <param type="data" name="input" format="fasta,fastqsanger" />
        <param type="select" name="species" label="Species" value='human' >
		<option value='human' selected='true'>Human</option>
		<option value='mouse'>Mouse</option>
                <option value='rat'>Rat</option>
                <option value='rabbit'>Rabbit</option>
	        <option value='rhesus_monkey'>Rhesus monkey</option>
 	</param>
        <param type="select" name="receptor_list" label="Receptor and Chain" multiple='true' value='IGH'>
                <option value='IGH' selected='true'>IGH</option>
                <option value='IGL'>IGL</option>
                <option value='IGK'>IGK</option>
                <option value='TRA'>TRA</option>
                <option value='TRB'>TRB</option>
                <option value='TRG'>TRG</option>
                <option value='TRD'>TRD</option>
        </param>
        <param name="qual_threshold" type="integer" label="Quality Theshold" optional="true" 
                help="Threshold for average quality of mutations and N-regions of CDR3 (only relevant for fastq input)" />
        <param name="allow_incomplete" type="boolean" label="Report clonotypes with partial CDR3 mapping" checked="false"
                truevalue="--allow-incomplete" falsevalue="" />
        <param name="all_alleles" type="boolean" label="use all alleles during alignemt (default = only major (*01) alleles)" checked='false' 
                truevalue="--all-alleles" falsevalue="" />
        <param name="allow_no_cdr3" type="boolean" label="Report clonotypes with no CDR3" checked='false' 
                truevalue="--allow-no-cdr3" falsevalue="" />
        <param name="allow_noncanonical" type="boolean" label="Report clonotypes that have non-canonical CDR3" checked='false' 
                truevalue="--allow-noncanonical" falsevalue="" />
        <param name="allow_noncoding" type="boolean" label="Report non-coding clonotypes (stop codon or frameshift)" checked='false' 
                truevalue="--allow-noncoding" falsevalue="" />
        <param name="by_read" type="boolean" label="Report mapping details for each read" checked='false' 
                truevalue="--by-read" falsevalue=""/>
    </inputs>
    <outputs>
        <data name="output" format="tabular" />
        <data name="report" format="txt" />
    </outputs>
    <tests>
        <test>
            <param name="input" value="test_stop_codon.fa"/>
            <param name="advanced" value="advanced"/>
            <param name="allow-non-coding" value="--allow-non-coding"/>
            <output name="report" file="test_stop_codon.report"/> 
            <output name="output" file="test_stop_codon.out"/>
        </test>
        <test>
            <param name="input" value="test_out_of_frame.fa"/>
            <output name="report" file="test_out_of_frame.report"/> 
            <output name="output" file="test_out_of_frame.out"/>
        </test>
    </tests>
    <help><![CDATA[
    --all-alleles                       Will use all alleles during
                                        alignment (this is going to be
                                        slower). [default = use only major
                                        (\*01) alleles]
    --allow-incomplete                  Report clonotypes with partial
                                        CDR3 mapping.
    --allow-no-cdr3                     Report clonotypes with no CDR3
                                        mapping.
    --allow-noncanonical                Report clonotypes that have
                                        non-canonical CDR3 (do not start
                                        with C or end with F/W residues).
    --allow-noncoding                   Report clonotypes that have either
                                        stop codon or frameshift in their
                                        receptor sequence.
    --blast-dir <path>                  Path to folder that contains
                                        'igblastn' and 'makeblastdb'
                                        binaries. [default = assume they
                                        are added to $PATH and execute
                                        them directly]
    --by-read                           Will output mapping details for
                                        each read. [default = assemble
                                        clonotypes and output clonotype
                                        abundance table]
    --custom-database <path>            Path to a custom segments
                                        database. [default = use built-in
                                        database]
    --data-dir <path>                   Path to folder that contains data
                                        bundle (internal_data/ and
                                        optional_file/ directories).
                                        [default = $install_dir/data/]
    --details <field1,field2,.../all>   Additional fields to provide for
                                        output, allowed values:
                                        fr1nt,cdr1nt,fr2nt,cdr2nt,fr3nt,fr
                                        4nt,contignt,fr1aa,cdr1aa,fr2aa,cd
                                        r2aa,fr3aa,fr4aa,contigaa.
    -h                                  Display this help message
    -n <int>                            Number of reads to take. [default
                                        = all]
    -p <int>                            Number of cores to use. [default =
                                        all available processors]
    -q <2..40>                          Threshold for average quality of
                                        mutations and N-regions of CDR3
                                        [default = 25]
    -R <chain1,...>                     Receptor gene and chain. Several
                                        chains can be specified, separated
                                        with commas. Allowed values: [TRA,
                                        TRB, TRG, TRD, IGH, IGL, IGK].
                                        [required]
    --report <file>                     File to store MIGMAP report. Will
                                        append report line if file exists.
    -S <name>                           Species. Allowed values: [human,
                                        mouse, rat, rabbit,
                                        rhesus_monkey]. [required]
    --unmapped <fastq[.gz]>             Output unmapped reads in specified
                                        file.
    --use-kabat                         Will use KABAT nomenclature for
                                        CDR/FW partitioning. [default =
                                        use IMGT nomenclature]

    ]]></help>
    <citations>
        <citation type="bibtex">
@misc{githubmigmap,
  author = {Shugay, Mikhail},
  year = {2015},
  title = {migmap},
  publisher = {GitHub},
  journal = {GitHub repository},
  url = {https://github.com/mikessh/migmap},
}</citation>
    </citations>
</tool>
