<tool id="ococo" name="ococo" version="0.1.2.6" >
    <description>consensus caller on SAM/BAM</description>
    <requirements>
      <requirement type="package" version="0.1.2.6">ococo</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:"   level="fatal"   description="Unknown error" />
    </stdio>
    <command>
      <![CDATA[

    ococo -i '$input_alignment'


    #if $fasta_reference:
      --fasta-ref '$fasta_reference'        
    #end if



    --counters $counters


    --strategy $strategy

    --min-MQ $min_mq
   
    --min-BQ $min_bq

    --ref-weight $ref_weight

    --min-cov $min_cov

    --maj-thres $maj_thres

    #if $save_vcf:
      --vcf-cons '$vcf_cons'
    #end if

    #if $save_fasta:
      --fasta-cons '$fasta_cons'
    #end if

    #if $save_pileup:
      --pileup '$pileup'
    #end if

      ]]>
    </command>


    <inputs>
      <param name="input_alignment" type="data" format="bam,sam" label="BAM dataset"/>
      <param name="fasta_reference" type="data" format="fasta" label="Select fasta reference" optional="True"/>
      <param name="counters" type="select" label="Counter configuration: [ococo16]">
        <option value="ococo16">ococo16 (3b/counter, 16b/position)</option>
        <option value="ococo32">ococo32 (7b/counter, 32b/position)</option>
        <option value="ococo64">ococo64 (15b/counter, 64b/position)</option>
      </param>
      <param name="strategy" type="select" label="Strategy for updates: [majority]">
        <option value="majority">Majority (update to majority base)</option>
        <option value="stochastic">stochastic (update to stochastically drawn base)</option>
      </param>


      <param name="save_vcf" type="boolean" truevalue="" falsevalue="" checked="false" label="Save consensus VCF" />
      <param name="save_fasta" type="boolean" truevalue="" falsevalue="" checked="false" label="Save consensus fasta" />
      <param name="save_pileup" type="boolean" truevalue="" falsevalue="" checked="false" label="Save pileup fasta" />
      
      
      <param name="min_mq" type="integer" label="Minimum mapping quality score" help="skip alignments with mapping quality smaller than INT [1]" value="1"/>
      <param name="min_bq" type="integer" label="Minimum base quality score" help="skip bases with base quality smaller than INT [13]" value="13"/>
      <param name="ref_weight" type="integer" label="Initial nucleotides counter" help="initial counter value for nucleotides from ref [0]" value="0"/>
      <param name="min_cov" type="integer" label="Minimum coverage required" help="minimum coverage required for update [2]" value="2"/>
      <param name="maj_thres" type="float" label="Majority consensus threshold [0.51]"  value="0.51"/>
    </inputs>

    <outputs>
      <data name="vcf_cons" format="vcf" label="VCF Consensus on ${input_alignment.name}">
        <filter>save_vcf</filter>
      </data>
      <data name="fasta_cons" format="fasta" label="Fasta Consensus on ${input_alignment.name}">
        <filter>save_fasta</filter>
      </data>
      <data name="pileup" format="pileup" label="Pileup on ${input_alignment.name}">
        <filter>save_pileup</filter>
      </data>
    </outputs>
    <tests>
      <test>
        <param name="input_alignment" value="alignment_A_2.sam"/>
        <param name="fasta_reference" value="reference.fa"/>
        <param name="save_vcf" value="true"/>
        <param name="save_fasta" value="true"/>
        <param name="save_pileup" value="true"/>
        <output name="fasta_cons" value="answer.fa"/>
        <output name="pileup" value="answer.pileup"/>
        <output name="vcf_cons">
          <assert_contents>
            <has_text text="AF=1.00;CS=2,0,0,0;COV=2"/>
          </assert_contents>
        </output>
      </test>
    </tests>
    <help>
      <![CDATA[

Documentation available @ https://github.com/karel-brinda/ococo

      ]]>      
    </help>
    <citations>
      <citation type="bibtex">
        @misc{1207.3907,
        Author = {Karel Brinda},
        Title = {Ococo: an online consensus caller},
        Year = {2017},
        Eprint = {arXiv:1712.01146},
        url = {https://arxiv.org/abs/1712.01146}
        }
      </citation>
    </citations>
</tool>
