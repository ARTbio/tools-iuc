<?xml version="1.0"?>
<tool id="mageck_count" name="MAGeCK count" version="@VERSION@" >
    <description>- collect sgRNA read counts from read mapping files</description>
    <macros>
        <import>mageck_macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="9.22">ghostscript</requirement>
    </expand>
    <expand macro="version" />
    <command detect_errors="exit_code"><![CDATA[

mageck count

-l '$sgrna_library_file'

#if $reads.format_select == "files":
    --fastq ${ ' '.join( ['%s' % $x.sample for x in $reads.rep_sample] ) }
#elif $reads.format_select == "table":
    -k '$reads.counts'
#end if

-n output

#if $adv.day0_label:
    --day0-label '$adv.day0_label'
#end if

#if $sample_labels:
    --sample-label '$sample_labels'
#end if

$out.pdfreportOpt
$out.unmappedOpt

#if $adv.trim5:
   --trim-5 $adv.trim5
#end if
--norm-method $adv.norm_method
#if $adv.control_sgrna:
    --control-sgrna $adv.control_sgrna
#end if
--sgrna-len $adv.sgrna_len
$adv.count_n
$adv.reverse_complement
$adv.test_run

#if $adv.gmt_file:
    --gmt-file '$adv.gmt_file'
#end if

#if $out.pdfreportOpt:
  &&
  gs -dBATCH -dNOPAUSE -q -dPDFSETTINGS=/prepress -sDEVICE=pdfwrite -sOutputFile=merged.pdf *.pdf
#end if
    ]]></command>
    <inputs>
        <param name="sgrna_library_file" type="data" argument="--list-seq" format="txt,tabular,tsv,csv" optional="true" label="sgRNA library file" help="A tabular file with three columns containing the sgRNA ID, sequence, and gene it is targeting, see Help below for more information. If this file is not provided, MAGeCK will count all possible sgRNAs in the fastq" />
        <conditional name="reads">
            <param name="format_select" type="select" label="Reads Files or Count Table?" help="You can choose to input either separate files of reads (one per sample) or a single count table">
                <option value="files">Separate Reads files</option>
                <option value="table">Single Count table</option>
            </param>
            <when value="files">
                <repeat name="rep_sample" title="Read files" min="1" >
                    <param name="sample" argument="--fastq" type="data" format="fastq,fastq.gz,bam" multiple="true" label="Sample reads" help="The reads must be in FASTQ, FASTQ.GZ or BAM format. Only select more than one file above if they are technical replicates of the same sample, each sample should be added using the Insert Read files button below. See Help below for more information" />
                </repeat>
            </when>
            <when value="table">
                <param name="counts" argument="-k"  type="data" format="tabular" optional="true" label="Counts Table" help="Alternatively, a tab-separated file of read counts can be used as input. See Help below for format" />
            </when>
        </conditional>
        <param name="sample_labels" argument="--sample-label" type="text" optional="true" value="" label="Sample labels" help="Optionally, you can specify sample labels. They must be separated by comma (,) and must be equal to the number of samples provided (in --fastq option). Default: sample1,sample2,..." />

        <section name="out" title="Output Options">
            <param name="countsummaryOpt" type="boolean" truevalue="True" falsevalue="" checked="false" optional="true" label="Output summary statistics of the fastq files" />
            <param name="pdfreportOpt" argument="--pdf-report" type="boolean" truevalue="--pdf-report" falsevalue="" checked="false" optional="true" label="Generate pdf report of the fastq files" />
            <param name="unmappedOpt" argument="--unmapped-to-file" type="boolean" truevalue="--unmapped-to-file" falsevalue="" checked="false" optional="true" label="Save unmapped reads to file" />
            <param name="logOpt" type="boolean" truevalue="True" falsevalue="" checked="false" label="Output logfile" help="This file includes the logging information during the execution. For count command, it will list some basic statistics of the dataset at the end, including the number of reads, the number of reads mapped to the library, the number of zero-count sgRNAs, etc." />
            <param name="rscriptOpt" type="boolean" truevalue="True" falsevalue="" checked="false" optional="true" label="Output the R script used to generate the plots in the pdf report. Default: No" />
        </section>

        <section name="adv" title="Advanced Options">
            <param name="day0_label" argument="--day0-label" type="text" optional="true" value="" label="Turn on negative selection QC" help="Turn on the negative selection QC and specify the label for control sample (usually day 0 or plasmid). For every other sample label, the negative selection QC will compare it with day0 sample, and estimate the degree of negative selections in essential genes." />
            <param name="gmt_file" argument="--gmt-file" type="data" format="tabular" optional="true" value="" label="Pathway file for QC" help="TThe pathway file used for QC, in GMT format. By default it will use the GMT file provided by MAGeCK" />
            <param name="trim5" argument="--trim-5" type="integer" min="0" optional="true" label="Trim length" help="Length of trimming the 5' of the reads. Default 0" />
            <param name="norm_method" argument="--norm-method" type="select" label="Method for normalization" help="Methods include: None (no normalization), Median (median normalization), Total (normalization by total read counts), Control (normalization by control sgRNAs specified by the --control-sgrna option). Default: Median" >
                <option value="none">None</option>
                <option value="median" selected="True">Median</option>
                <option value="total">Total</option>
                <option value="control">Control</option>
            </param>
            <param name="control_sgrna" argument="--control-sgrna" type="data" format="tabular" optional="true" label="Control sgRNAs for normalization" help="A list of control sgRNAs for normalization and for generating the null distribution of RRA" />
            <param name="sgrna_len" argument="--sgrna-len" type="integer" min="0" value="20" optional="true" label="Length of the sgRNA" help="The program will automatically determine the sgRNA length from the library file, so only use this if you turn on the --unmapped-to-file option. Default: 20" />
            <param name="count_n" argument="--count-n" type="boolean" truevalue="--count-n" falsevalue="" checked="false" optional="true" label="Count sgRNAs with Ns" help="By default, sgRNAs containing Ns will be discarded" />
            <param name="reverse_complement" argument="--reverse-complement" type="boolean" truevalue="--reverse-complement" falsevalue="" checked="false" optional="true" label="Reverse complement the sequences in library for read mapping" />
            <param name="test_run" argument="--test-run" type="boolean" truevalue="--test-run" falsevalue="" checked="false" optional="true" label="Test running" help="If this option is on, MAGeCK will only process the first 1M records for each file" />
        </section>
    </inputs>

    <outputs>
        <data name="counts" format="tabular" from_work_dir="*.count.txt" label="${tool.name} on ${on_string}: sgRNA Counts" />
        <data name="countsummary" format="tabular" from_work_dir="*.countsummary.txt" label="${tool.name} on ${on_string}: sgRNA Count Summary" >
            <filter>out['countsummaryOpt'] is True</filter>
        </data>
        <data name="pdfreport" format="pdf" from_work_dir="merged.pdf" label="${tool.name} on ${on_string}: PDF Report"  >
            <filter>out['pdfreportOpt'] is True</filter>
        </data>
        <data name="unmapped" format="tabular" from_work_dir="*.unmapped.txt" label="${tool.name} on ${on_string}: Unmapped" >
            <filter>out['unmappedOpt'] is True</filter>
        </data>
        <data name="log" format="txt" from_work_dir="*.log" label="${tool.name} on ${on_string}: Log" >
            <filter>out['logOpt'] is True</filter>
        </data>
    </outputs>

    <tests>
        <!-- Ensure default counts output works -->
        <test expect_num_outputs="1">
            <param name="sgrna_library_file" value="demo/demo2/library.txt" ftype="tabular" />
            <param name="format_select" value="files" />
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test1.fastq" ftype="fastq"/>
            </repeat>
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test2.fastq" ftype="fastq"/>
            </repeat>
            <param name="sample_labels" value="L1,CTRL" />
            <output name="counts" file="out.count.txt"/>
        </test>
        <!-- Ensure optional outputs work -->
        <test expect_num_outputs="5">
            <param name="sgrna_library_file" value="demo/demo2/library.txt" ftype="tabular" />
            <param name="format_select" value="files" />
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test1.fastq" ftype="fastq"/>
            </repeat>
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test2.fastq" ftype="fastq"/>
            </repeat>
            <param name="sample_labels" value="L1,CTRL" />
            <param name="countsummaryOpt" value="True" />
            <param name="unmappedOpt" value="True" />
            <param name="pdfreportOpt" value="True" />
            <param name="rscriptOpt" value="True" />
            <param name="logOpt" value="True" />
            <output name="counts" file="out.count.txt"/>
            <output name="countsummary" file="out.countsummary.txt" compare="sim_size"/>
            <output name="log" file="out.count.log.txt" compare="sim_size"/>
            <output name="unmapped" file="out.count.unmapped.txt" />
            <output name="pdfreport" file="out.countsummary.pdf" compare="sim_size" />
        </test>
    </tests>

    <help><![CDATA[
.. class:: infomark

**What it does**

`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout` (MAGeCK) is a computational tool to identify important genes
from the recent genome-scale CRISPR-Cas9 knockout screens (or GeCKO) technology.
MAGeCK can be used for prioritizing single-guide RNAs, genes and pathways in genome-scale CRISPR/Cas9 knockout screens.
MAGeCK identifies both positively and negatively selected genes simultaneously and reports robust results across different experimental conditions.

Features:

  * Simple, easy to use pipeline to screen genes in Genome-wide CRISPR-Cas9 Knockout experiments
  * High sensitivity and low false discovery rate
  * Fully utilize the screening data by performing both positive and negative screening in one dataset
  * Provide statistical evaluation in genes, sgRNAs and pathways
  * Require as few as 2 samples
  * Identify cell-type specific targets
  * A set of visualization features that generate publication standard figures

.. _`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout`: https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0554-4
.. _`100% validation rate`: https://sourceforge.net/p/mageck/wiki/Home/

http://liulab.dfci.harvard.edu/Mageck/

-----

**Inputs**

By default, MAGeCK count command will automatically determine the trimming length of the fastq file.

**sgRNA library file**

When starting from fastq files, MAGeCK needs to know the sgRNA sequence and its targeting gene. Such information is provided in the sgRNA library file, and can be specified by the ``-l/--list-seq`` option in the count subcommand.
The sgRNA library file can be provided either in .txt format or in .csv format. There are three columns in the library file: the sgRNA ID, the sequence, and the gene it is targeting. An example of a library file is as follows:

    ============ ==================== ========
    **sgRNA ID** **Sequence**         **Gene**
    ------------ -------------------- --------
    s_10007      TGTTCACAGTATAGTTTGCC CCNA1
    s_10008      TTCTCCCTAATTGCTTGCTG CCNA1
    s_10027      ACATGTTGCTTCCCCTTGCA CCNC
    ============ ==================== ========

**Control sgRNA file**

The --control-sgrna CONTROL_SGRNA is used to generate null distribution when calculating the p values. If this option is not specified, MAGeCK generates the null distribution of RRA scores by assuming all of the genes in the library are non-essential. This approach is sometimes over-conservative, and you can improve this if you know some genes are not essential. By providing the corresponding sgRNA IDs in the --control-sgrna option, MAGeCK will have a better estimation of p values. To use this option, you need to prepare a text file specifying the IDs of control sgRNAs, one line for one sgRNA ID.

-----

**Outputs**

**sgRNA Count file**

The sgRNA read count file will be used in ``-k`` parameter in the test sub-command. The read count file should list the names of the sgRNA, the gene it is targeting, followed by the read counts in each sample. Each item should be separated by the tab ('\t'). A header line is optional. For example in the studies of T. Wang et al. Science 2014, there are 4 CRISPR screening samples, and they are labeled as: HL60.initial, KBM7.initial, HL60.final, KBM7.final. Here are a few lines of the read count file:

    ==============  ========    ================    ================   ==============   ==============
    **sgRNA**       **Gene**    **HL60.initial**    **KBM7.initial**   **HL60.final**   **KBM7.final**
    --------------  --------    ----------------    ----------------   --------------   --------------
    A1CF_m52595977  A1CF        213                 274                883              175
    A1CF_m52596017  A1CF        294                 412                1554             1891
    A1CF_m52596056  A1CF        421                 368                566              759
    A1CF_m52603842  A1CF        274                 243                314              855
    A1CF_m52603847  A1CF        0                   50                 145              266
    ==============  ========    ================    ================   ==============   ==============


**Count Summary**

MAGeCK produces a **Count Summary** file containing all the statistics of the fastq files. If you use``--pdf-report`` option, the statistics of fastq files are also in the PDF file from the test.

    ==========  =====  =====   ======  ==========  =========== ========== ========= ======== ============ ======================= ========================== ============
    File        Label  Reads   Mapped  Percentage  TotalsgRNAs Zerocounts GiniIndex NegSelQC NegSelQCPval NegSelQCPvalPermutation NegSelQCPvalPermutationFDR NegSelQCGene
    ==========  =====  =====   ======  ==========  =========== ========== ========= ======== ============ ======================= ========================== ============
    InputFile1  L1     2500    1453    0.5812      2550        1276       0.5267    0        1            1                       1                          0.0
    InputFile2  CTRL   2500    1471    0.5884      2550        1199       0.4931    0        1            1                       1                          0.0
    ==========  =====  =====   ======  ==========  =========== ========== ========= ======== ============ ======================= ========================== ============

-----

**More Information**

**How to deal with biological replicates and technical replicates?**

Usually you can pool the read counts for technical replicates of the same sample. To do this, select the files together under **Sample reads** above. For biological replicates, treat them as separate samples and use them together when doing the comparison, so MAGeCK can analyze the variance of these samples. For example in the test command, ``-t sample1_bio_replicate1,sample1_bio_replicate2 -c sample2_bio_replicate1,sample2_bio_replicate2`` compares 2 samples (with 2 biological replicates in each sample).

**The ``--trim-5`` option can only trim a fixed length of nucleotides before sgRNA, but what if the trimming length is different in different reads?**

MAGeCK enables automatically determining trimming length, even the length may be different within the same fastq files.
Alternatively, you can use **cutadapt** to trim the adaptor sequences of variable length before running MAGeCK.

**How do I get the simple statistics of the fastq files?**

Since version 0.5, MAGeCK produces a **Count Summary** file containing all the statistics of the fastq files. If you use ``--pdf-report`` option, the statistics of fastq files are also in the PDF file from the test. The statistics can also be found in the log file (for run and count command). Above has an example of the log file generated from count command.

**How do I know the quality of my samples?**

For simple QC terms, you can just take a look at the sample statistics. Generally in a good negative selection sample:

#. the mapped reads should be over 60 percent of the total number reads
#. the number of zero-count sgRNAs should be few (<5%, and prefered <1%). One exception is in positive selection experiments, where the number of zero-count sgRNAs may be much higher, but the percentage of mapped reads should be reasonably high.

For more information on using MAGeCK, see the `MAGeCK website here`_.

.. _`MAGeCK-VISPR`: https://new-genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0843-6
.. _`MAGeCK website here`: https://sourceforge.net/p/mageck/wiki/QA/#using-mageck

    ]]></help>
      <expand macro="citations" />
</tool>
