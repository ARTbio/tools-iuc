<?xml version="1.0"?>
<tool id="mageck_count" name="mageck count" version="@VERSION@" >
    <description>- collect sgRNA read counts from read mapping files</description>
    <macros>
        <import>mageck_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version" />
    <command detect_errors="exit_code"><![CDATA[

mageck count

-l '$sgrna_library_file'

#if $reads.format_select == "files":
    --fastq ${ ' '.join( ['%s' % $x.sample for x in $reads.rep_sample] ) }
#elif $reads.format_select == "table":
    -k '$reads.counts'
#end if

-n output 

#if $adv.day0_label:
    --day0-label '$adv.day0_label'
#end if

#if $sample_labels:
    --sample-label '$sample_labels'
#end if

$out.pdfreportOpt
$out.unmappedOpt
$out.keep_tmp

#if $adv.trim5:
   --trim-5 $adv.trim5
#end if
--norm-method $adv.norm_method
#if $adv.control_sgrna:
    --control-sgrna $adv.control_sgrna
#end if
--sgrna-len $adv.sgrna_len
$adv.count_n
$adv.reverse_complement
$adv.test_run

#if $adv.gmt_file:
    --gmt-file '$adv.gmt_file'
#end if

    ]]></command>
    <inputs> 
        <param name="sgrna_library_file" type="data" argument="--list-seq" format="txt,tabular,tsv,csv" optional="true" label="sgRNA library file" help="A tabular file with three columns containing the sgRNA ID, sequence, and gene it is targeting, see Help below for more information. If this file is not provided, MAGeCK will count all possible sgRNAs in the fastq" />
        <conditional name="reads">
            <param name="format_select" type="select" label="Reads Files or Count Table?" help="You can choose to input either separate files of reads (one per sample) or a single count table">
                <option value="files">Separate Reads files</option>
                <option value="table">Single Count table</option>
            </param>
            <when value="files">
                <repeat name="rep_sample" title="Read files" min="1" >
                    <param name="sample" argument="--fastq" type="data" format="fastq,fastq.gz,bam" min="1" multiple="true" label="Sample reads" help="The reads must be in FASTQ, FASTQ.GZ or BAM format. Only select more than one file above if they are technical replicates of the same sample, each sample should be added using the Insert Read files button below. See Help below for more information" />
                </repeat>
            </when>
            <when value="table">
                <param name="counts" type="data" argument="-k" format="tabular" optional="true" label="Counts Table" help="Alternatively, a tab-separated file of read counts can be used as input. See Help below for format" />
            </when>
        </conditional>
        <param name="sample_labels" argument="--sample-label" type="text" optional="true" value="" label="Sample labels" help="Optionally, you can specify sample labels. They must be separated by comma (,) and must be equal to the number of samples provided (in --fastq option). Default: sample1,sample2,..." />

        <section name="out" title="Output Options">
            <param name="countsummaryOpt" type="boolean" truevalue="True" falsevalue="" checked="false" optional="true" label="Output summary statistics of the fastq files" />
            <param name="pdfreportOpt" argument="--pdf-report" type="boolean" truevalue="--pdf-report" falsevalue="" checked="false" optional="true" label="Generate pdf report of the fastq files" />        
            <param name="unmappedOpt" argument="--unmapped-to-file" type="boolean" truevalue="--unmapped-to-file" falsevalue="" checked="false" optional="true" label="Save unmapped reads to file" />
            <param name="logOpt" type="boolean" truevalue="True" falsevalue="" checked="false" label="Output logfile" help="This file includes the logging information during the execution. For count command, it will list some basic statistics of the dataset at the end, including the number of reads, the number of reads mapped to the library, the number of zero-count sgRNAs, etc." />
            <param name="keep_tmp" argument="--keep-tmp" type="boolean" truevalue="--keep-tmp" falsevalue="" checked="false" optional="true" label="Keep intermediate files" help="See Help section beow for more information"/>
            <param name="rscriptOpt" type="boolean" truevalue="True" falsevalue="" checked="false" optional="true" label="Output the R script used to generate the plots in the pdf report. Default: No" />
        </section>

        <section name="adv" title="Advanced Options">
            <param name="day0_label" argument="--day0-label" type="text" optional="true" value="" label="Turn on negative selection QC" help="Turn on the negative selection QC and specify the label for control sample (usually day 0 or plasmid). For every other sample label, the negative selection QC will compare it with day0 sample, and estimate the degree of negative selections in essential genes." />
            <param name="gmt_file" argument="--gmt-file" type="data" format="tabular" optional="true" value="" label="Pathway file for QC" help="TThe pathway file used for QC, in GMT format. By default it will use the GMT file provided by MAGeCK" />
            <param name="trim5" argument="--trim-5" type="integer" min="0" optional="true" label="Trim length" help="Length of trimming the 5' of the reads. Default 0" />     
            <param name="norm_method" argument="--norm-method" type="select" label="Method for normalization" help="Methods include: None (no normalization), Median (median normalization), Total (normalization by total read counts), Control (normalization by control sgRNAs specified by the --control-sgrna option). Default: Median" >
                <option value="none">None</option>
                <option value="median" selected="True">Median</option>
                <option value="total">Total</option>
                <option value="control">Control</option>
            </param>
            <param name="control_sgrna" argument="--control-sgrna" type="data" format="tabular" optional="true" label="Control sgRNAs for normalization" help="A list of control sgRNAs for normalization and for generating the null distribution of RRA" />
            <param name="sgrna_len" argument="--sgrna-len" type="integer" min="0" value="20" optional="true" label="Length of the sgRNA" help="The program will automatically determine the sgRNA length from the library file, so only use this if you turn on the --unmapped-to-file option. Default: 20" />     
            <param name="count_n" argument="--count-n" type="boolean" truevalue="--count-n" falsevalue="" checked="false" optional="true" label="Count sgRNAs with Ns" help="By default, sgRNAs containing Ns will be discarded" />
            <param name="reverse_complement" argument="--reverse-complement" type="boolean" truevalue="--reverse-complement" falsevalue="" checked="false" optional="true" label="Reverse complement the sequences in library for read mapping" />
            <param name="test_run" argument="--test-run" type="boolean" truevalue="--test-run" falsevalue="" checked="false" optional="true" label="Test running" help="If this option is on, MAGeCK will only process the first 1M records for each file" />
        </section>
    </inputs>

    <outputs>       
        <data name="counts" format="tabular" from_work_dir="output.count.txt" label="${tool.name} on ${on_string}: sgRNA Counts" />
        <data name="countsummary" format="tabular" from_work_dir="output.countsummary.txt" label="${tool.name} on ${on_string}: sgRNA Count Summary" >
          <filter>out['countsummaryOpt'] is True</filter>
        </data>
        <data name="pdfreport" format="pdf" from_work_dir="output.pdf" label="${tool.name} on ${on_string}: PDF Report"  >
          <filter>out['pdfreportOpt'] is True</filter>
        </data>
        <data name="rscript" format="txt" from_work_dir="output.R" label="${tool.name} on ${on_string}: RScript">
            <filter>out['rscriptOpt'] is True</filter>
        </data>
        <data name="unmapped" format="tabular" from_work_dir="output.unmapped.txt" label="${tool.name} on ${on_string}: Unmapped" >
          <filter>out['unmappedOpt'] is True</filter>
        </data>
        <data name="log" format="txt" from_work_dir="output.log" label="${tool.name} on ${on_string}: Log" >
          <filter>out['logOpt'] is True</filter>
        </data>
        <data name="gene_high" format="tabular" from_work_dir="output.gene.high.txt" label="${tool.name} on ${on_string}: Gene High" >
          <filter>out['keep_tmp'] is True</filter>
        </data>
        <data name="gene_low" format="tabular" from_work_dir="output.gene.low.txt" label="${tool.name} on ${on_string}: Gene Low" >
          <filter>out['keep_tmp'] is True</filter>
        </data>
    </outputs>

    <tests>
        <!-- Ensure default counts output works --> 
        <test expect_num_outputs="1">
            <param name="sgrna_library_file" value="demo/demo2/library.txt" ftype="tabular" />
            <param name="format_select" value="files" />
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test1.fastq" ftype="fastq"/>
            </repeat>
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test2.fastq" ftype="fastq"/>
            </repeat>
            <param name="sample_labels" value="L1,CTRL" />
            <output name="counts" file="out.count.txt"/>
        </test>
        <!-- Ensure optional outputs work --> 
        <test expect_num_outputs="8">
            <param name="sgrna_library_file" value="demo/demo2/library.txt" ftype="tabular" />
            <param name="format_select" value="files" />
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test1.fastq" ftype="fastq"/>
            </repeat>
            <repeat name="rep_sample">
                <param name="sample" value="demo/demo2/test2.fastq" ftype="fastq"/>
            </repeat>
            <param name="sample_labels" value="L1,CTRL" />
            <param name="countsummaryOpt" value="True" />
            <param name="pdfreportOpt" value="True" />
            <param name="unmappedOpt" value="True" />
            <param name="keep_tmp" value="True" />
            <param name="rscriptOpt" value="True" />           
            <param name="logOpt" value="True" />
            <output name="counts" file="out.count.txt"/>
            <output name="countsummary" file="out.countsummary.txt" compare="re_match"/>
            <output name="log" file="out.count.log" compare="sim_size"/>
            <output name="unmapped" file="out.count.unmapped.txt" />
            <output name="pdfreport" file="out.countsummary.pdf" compare="sim_size"/>
            <output name="rscript" file="out.count.R" />
            <output name="gene_high" file="out.count.gene.high.txt"/>
            <output name="gene_low" file="out.count.gene.low.txt" />
        </test>
    </tests>
    
    <help><![CDATA[
.. class:: infomark

**What it does**

`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout` (MAGeCK) is a computational tool to identify important genes from the recent genome-scale CRISPR-Cas9 knockout screens (or GeCKO) technology. MAGeCK can be used for prioritizing single-guide RNAs, genes and pathways in genome-scale CRISPR/Cas9 knockout screens. MAGeCK identifies both positively and negatively selected genes simultaneously and reports robust results across different experimental conditions. MAGeCK is developed and maintained by Wei Li and Han Xu from Dr. Xiaole Shirley Liu's lab at Department of Biostatistics and Computational Biology, Dana-Farber Cancer Institute and Harvard School of Public Health. MAGeCK has been used to identify functional lncRNAs from screens with close to `100% validation rate`_. 

Features

* Simple, easy to use pipeline to screen genes in Genome-wide CRISPR-Cas9 Knockout experiments
* High sensitivity and low false discovery rate
* Fully utilize the screening data by performing both positive and negative screening in one dataset
* Provide statistical evaluation in genes, sgRNAs and pathways
* Require as few as 2 samples
* Identify cell-type specific targets
* A set of visualization features that generate publication standard figures

.. _`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout`: https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0554-4
.. _`100% validation rate`: https://sourceforge.net/p/mageck/wiki/Home/

http://liulab.dfci.harvard.edu/Mageck/

-----

**Inputs**

By default, MAGeCK count command will automatically determine the trimming length of the fastq file.

**sgRNA library file**

When starting from fastq files, MAGeCK needs to know the sgRNA sequence and its targeting gene. Such information is provided in the sgRNA library file, and can be specified by the ``-l/--list-seq`` option in the count subcommand.
The sgRNA library file can be provided either in .txt format or in .csv format. There are three columns in the library file: the sgRNA ID, the sequence, and the gene it is targeting. An example of a library file is as follows:

============ ==================== ========
**sgRNA ID** **Sequence**         **Gene**
------------ -------------------- --------
s_10007      TGTTCACAGTATAGTTTGCC CCNA1
s_10008      TTCTCCCTAATTGCTTGCTG CCNA1
s_10027      ACATGTTGCTTCCCCTTGCA CCNC
============ ==================== ========

-----

**Outputs**

**sgRNA Count file**

The sgRNA read count file will be used in ``-k`` parameter in the test sub-command. The read count file should list the names of the sgRNA, the gene it is targeting, followed by the read counts in each sample. Each item should be separated by the tab ('\t'). A header line is optional. For example in the studies of T. Wang et al. Science 2014, there are 4 CRISPR screening samples, and they are labeled as: HL60.initial, KBM7.initial, HL60.final, KBM7.final. Here are a few lines of the read count file:

  ==============  ========    ================    ================   ==============   ============== 
  **sgRNA**       **Gene**    **HL60.initial**    **KBM7.initial**   **HL60.final**   **KBM7.final**
  --------------  --------    ----------------    ----------------   --------------   --------------
  A1CF_m52595977  A1CF        213                 274                883              175
  A1CF_m52596017  A1CF        294                 412                1554             1891
  A1CF_m52596056  A1CF        421                 368                566              759
  A1CF_m52603842  A1CF        274                 243                314              855
  A1CF_m52603847  A1CF        0                   50                 145              266
  ==============  ========    ================    ================   ==============   ============== 
 

**Count Summary**

Since version 0.5, MAGeCK produces a **Count Summary** file containing all the statistics of the fastq files. If you use``--pdf-report`` option, the statistics of fastq files are also in the PDF file from the test. The statistics can also be found in the log file. Here is an example of the log file generated from count command (the last few lines):

INFO  @ Mon, 02 Feb 2015 08:12:15: Summary of file sample1_R1.fastq: 
INFO  @ Mon, 02 Feb 2015 08:12:15: reads        45631055 
INFO  @ Mon, 02 Feb 2015 08:12:15: mappedreads  34300176 
INFO  @ Mon, 02 Feb 2015 08:12:15: zerosgrnas   119315 
INFO  @ Mon, 02 Feb 2015 08:12:15: label        sample_1 
INFO  @ Mon, 02 Feb 2015 08:12:15: Summary of file sample2_R1.fastq: 
INFO  @ Mon, 02 Feb 2015 08:12:15: reads        36344414 
INFO  @ Mon, 02 Feb 2015 08:12:15: mappedreads  27042629 
INFO  @ Mon, 02 Feb 2015 08:12:15: zerosgrnas   119002 
INFO  @ Mon, 02 Feb 2015 08:12:15: label        sample_2  

It provides the total number of reads, the number of mapped reads, the number of sgRNAs with 0 read counts, and the sample label of the fastq file.


**Intermediate file formats**

These files will be automatically deleted after the completion of each command. To keep these files, use the ``--keep-tmp`` option during the execution.

**gene_txt**

An example of the gene ranking file (.gene.high.txt or .gene.low.txt) is as follows:
 ============ ==================== ============ ========
 **group_id** **#_items_in_group** **lo_value** **FDR**
 ------------ -------------------- ------------ -------- 
 RPL3         93                    4.9169e-36  0.000080
 RPL8         67                    1.8232e-24  0.000080
 RPS2         61                    1.6928e-20  0.000080
 RPS18        40                    1.0152e-18  0.000080
 ============ ==================== ============ ========

The contents of each column is as follows:

* **group_id**    Gene ID
* **#_items_in_group**    The number of targeting sgRNAs for each gene
* **lo_value**    The raw p-value
* **FDR** The false discovery rate

-----

**More Information**

**How to deal with biological replicates and technical replicates?**

Usually you can pool the read counts for technical replicates of the same sample. To do this, select the files together under **Sample reads** above. For biological replicates, treat them as separate samples and use them together when doing the comparison, so MAGeCK can analyze the variance of these samples. For example in the test command, ``-t sample1_bio_replicate1,sample1_bio_replicate2 -c sample2_bio_replicate1,sample2_bio_replicate2`` compares 2 samples (with 2 biological replicates in each sample).

**The ``--trim-5`` option can only trim a fixed length of nucleotides before sgRNA, but what if the trimming length is different in different reads?**

Since version 0.5.6, MAGeCK enables automatically determining trimming length, even the length may be different within the same fastq files. Alternatively, you can use **cutadapt** to trim the adaptor sequences of variable length before running MAGeCK.

**How do I get the simple statistics of the fastq files?**

Since version 0.5, MAGeCK produces a **Count Summary** file containing all the statistics of the fastq files. If you use ``--pdf-report`` option, the statistics of fastq files are also in the PDF file from the test. The statistics can also be found in the log file (for run and count command). Above has an example of the log file generated from count command.

**How do I know the quality of my samples?**

We published a paper (MAGeCK-VISPR_) to describe some quality control (QC) terms to help you determine the quality of your samples.
For simple QC terms, you can just take a look at the sample statistics. Generally in a good negative selection sample:

#. the mapped reads should be over 60 percent of the total number reads
#. the number of zero-count sgRNAs should be few (<5%, and prefered <1%). One exception is in positive selection experiments, where the number of zero-count sgRNAs may be much higher, but the percentage of mapped reads should be reasonably high.

For more information on using MAGeCK, see the `MAGeCK website here`_. 

.. _`MAGeCK-VISPR`: https://new-genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0843-6
.. _`MAGeCK website here`: https://sourceforge.net/p/mageck/wiki/QA/#using-mageck

    ]]></help>
      <expand macro="citations" />
</tool>

