<?xml version="1.0"?>
<tool id="mageck_test" name="MAGeCKs test" version="@VERSION@" >
    <description>- given a table of read counts, perform the sgRNA and gene ranking</description>
    <macros>
        <import>mageck_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version" />
    <command detect_errors="exit_code"><![CDATA[

mageck test 
-k '$counts'

#if $sampleids.sample_select == "treated":
    -t '$sampleids.treatment_id'
#elif $sampleids.sample_select == "control":
    --day0-label '$sampleids.day0_label'
#end if

#if '$control_id':    
    -c '$control_id'
#end if

-n output

$out.normcounts
$out.pdfreport
$out.keep_tmp

--norm-method $adv.norm_method
--gene-test-fdr-threshold $adv.fdr_threshold
--adjust-method $adv.adjust_method
$adv.var_samples
--sort-criteria $adv.sort_criteria
--remove-zero $adv.remove_zero
--gene-lfc-method $adv.lfc_method 
#if $adv.control_sgrna:
--control-sgrna $adv.control_sgrna
#end if
#if $adv.cnv_norm:
  --cnv-norm $adv.cnv_norm
#end if 
#if $adv.cell_line:
  --cell-line $adv.cell_line
#end if 

    ]]></command>
    <inputs> 
        <param name="counts" argument="-k/--count-table" type="data" format="tabular" label="Counts file" help="A tab-separated file of read counts. See Help below for format" />
        <conditional name="sampleids">
            <param name="sample_select" type="select" label="Specify Treated samples or Control"
                help="You can choose to either specify the treated samples or the control">
                <option value="treated">Treated samples</option>
                <option value="control">Control sample</option>
            </param>
            <when value="treated">
                <param name="treatment_id" argument="-t/--treatment-id" type="text" label="Treated Sample labels or indexes" help="If sample label is provided, the labels must match the labels in the first line of the count table, separated by comma (,); for example, HL60.final,KBM7.final. For sample index, 0,2 means the 1st and 3rd samples are treatment experiments. See Help below for a detailed description." />
            </when>
            <when value="control">
            <param name="day0_label" argument="--day0-label" type="text" optional="true" value="" label="Control sample label" help="Specify the label for the control sample. For every other sample label, the module will treat it as a treatment condition and compare with control sample (usually day 0 or plasmid)" />
            </when>
        </conditional> 
        <param name="control_id" argument="-c/--control-id" type="text" optional="true" label="Control Sample labels or indexes" help="If sample label is provided, the labels must match the labels in the first line of the count table, separated by comma (,). Default is all the samples not specified in treatment experiments. See Help below for a detailed description." />

        <section name="out" title="Output Options">
            <param name="normcounts" argument="--normcounts-to-file" type="boolean" truevalue="--normcounts-to-file" falsevalue="" checked="false" optional="true" label="Output normalized counts file" help="Default: No"  />
            <param name="pdfreport" argument="--pdf-report" type="boolean" truevalue="--pdf-report" falsevalue="" checked="false" optional="true" label="Output PDF report" help="Default: No" />
            <param name="keep_tmp" argument="--keep-tmp" type="boolean" truevalue="--keep-tmp" falsevalue="" checked="false" optional="true" label="Output intermediate files" help="Default: No"/>
            <param name="out_log" type="boolean" truevalue="True" falsevalue="" checked="false" label="Output logfile" help="This file includes the logging information during the execution. For count command, it will list some basic statistics of the dataset at the end, including the number of reads, the number of reads mapped to the library, the number of zero-count sgRNAs, etc. Default: No" />
            <param name="rscriptOpt" type="boolean" truevalue="True" falsevalue="" checked="false" optional="true" label="Output the R script used to generate the plots in the pdf report. Default: No" />
        </section>

        <section name="adv" title="Advanced Options">
            <param name="norm_method" argument="--norm-method" type="select" label="Method for normalization" help="If control is specified, the size factor will be estimated using control sgRNAs specified in --control-sgrna option. Default: Median" >
            <option value="none">None</option>
            <option value="median" selected="True">Median</option>
            <option value="total">Total</option>
            <option value="control">Control</option>
        </param>
        <param name="fdr_threshold" argument="--gene-test-fdr-threshold" type="float" value="0.25" min="0" max="1" label="Gene test FDR-adjusted Threshold" help="FDR threshold for gene test. Default: 0.25"/>
        <param name="adjust_method" argument="--adjust-method" type="select" label="P-Value Adjustment Method" help="Method for sgRNA-level p-value adjustment, including False Discovery Rate (FDR), Holm's method (Holm), or Pounds's method (Pounds). Default: FDR">
            <option value="fdr" selected="True">FDR</option>
            <option value="holm">Holm</option>
            <option value="pounds">Pounds</option>
        </param>
        <param name="var_samples" argument="--variance-from-all-samples" type="boolean" truevalue="--variance-from-all-samples" falsevalue="" checked="false" optional="true" label="Estimate the variance from all samples, instead of from only control samples" help="Use this option only if you believe there are relatively few essential sgRNAs or genes between control and treatment samples" />
        <param name="sort_criteria" argument="--sort-criteria" type="select" label="Sorting criteria, either by Negative selection (Negative) or positive selection (Positive). Default: Negative" >
            <option value="neg" selected="True">Negative</option>
            <option value="pos">Positive</option>
        </param>
        <param name="remove_zero" argument="--remove-zero" type="select" help="Whether to remove zero-count sgRNAs in control and/or treatment experiments {none,control,treatment,both}. Default: None (do not remove those zero-count sgRNAs)" > 
            <option value="none" selected="True">None</option>
            <option value="control">Control</option>
            <option value="treatment">Treatment</option>
            <option value="both">Both</option>
        </param>    
        <param name="lfc_method" argument="--gene-lfc-method" type="select" label="Gene Log-Fold Change Method." help="Method to calculate gene log fold changes (LFC) from sgRNA LFCs. Available methods include the median/mean of all sgRNAs (median/mean), or the median/mean sgRNAs that are ranked in front of the alpha cutoff in RRA (alphamedian/alphamean), or the sgRNA that has the second strongest LFC (secondbest). In the alphamedian/alphamean case, the number of sgRNAs correspond to the goodsgrna column in the output, and the gene LFC will be set to 0 if no sgRNA is in front of the alpha cutoff. Default: Median. (new since v0.5.5)"> 
            <option value="median" selected="True">Median</option>
            <option value="alphamedian">Alphamedian</option>
            <option value="mean">Mean</option>
            <option value="alphamean">Alphamean</option>
            <option value="secondbest">Secondbest</option>
        </param>
        <param name="control_sgrna" argument="--control-sgrna" type="data" format="tabular" optional="true" label="A list of control sgRNAs for normalization and for generating the null distribution of RRA" />
        <param name="cnv_norm" argument="--cnv-norm" type="data" format="tabular" optional="true" label="CNV profile file" help="A tab-delimited file containing the CNV status for each gene. See Help below for more information and format." />
        <param name="cell_line" argument="--cell-line" type="text" optional="true" label="Cell line column" help="Name of the column from the CNV profile file to use. See Help below for more information" />
        </section>
       
    </inputs>

    <outputs>
        <data name="gene_summary" format="tabular" from_work_dir="*.gene_summary.txt" label="${tool.name} on ${on_string}: Gene Summary" />
        <data name="sgrna_summary" format="tabular" from_work_dir="*.sgrna_summary.txt" label="${tool.name} on ${on_string}: sgRNA Summary" />
        <data name="log" format="tabular" from_work_dir="*.log" label="${tool.name} on ${on_string}: Log">
            <filter>out['out_log'] is True</filter>
        </data>
        <data name="normcounts" format="tabular" from_work_dir="*.count_normalized.txt" label="${tool.name} on ${on_string}: sgRNA Normalized Counts">
            <filter>out['normcounts'] is True</filter>
        </data>
        <data name="pdfreport" format="pdf" from_work_dir="*.pdf" label="${tool.name} on ${on_string}: PDF Report">
            <filter>out['pdfreport'] is True</filter>
        </data>
        <data name="rscript" format="txt" from_work_dir="*.R" label="${tool.name} on ${on_string}: RScript">
            <filter>out['rscriptOpt'] is True</filter>
        </data>
        <data name="gene_high" format="tabular" from_work_dir="*.gene.high.txt" label="${tool.name} on ${on_string}: Gene High">
            <filter>out['keep_tmp'] is True</filter>
        </data>
        <data name="gene_low" format="tabular" from_work_dir="*.gene.low.txt" label="${tool.name} on ${on_string}: Gene Low">
            <filter>out['keep_tmp'] is True</filter>
        </data>
    </outputs>
    <tests>     
        <test><!-- Ensure MAGeCK's default output works -->
            <param name="counts" value="demo/demo1/sample.txt" ftype="tabular" />
            <param name="treatment_id" value="HL60.final,KBM7.final" />
            <param name="control_id" value="HL60.initial,KBM7.initial" />
            <output name="gene_summary" file="out.test.gene_summary.txt"/>
            <output name="sgrna_summary" file="out.test.sgrna_summary.txt"/>
        </test>
        <test><!-- Ensure MAGeCK's additional outputs works -->
            <param name="counts" value="demo/demo1/sample.txt" ftype="tabular" />
            <param name="treatment_id" value="HL60.final,KBM7.final" />
            <param name="control_id" value="HL60.initial,KBM7.initial" />
            <output name="gene_summary" file="out.test.gene_summary.txt"/>
            <output name="sgrna_summary" file="out.test.sgrna_summary.txt"/>
        </test>
    </tests>
    
    <help><![CDATA[
.. class:: infomark

**What it does**

`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout` (MAGeCK) is a computational tool to identify important genes from the recent genome-scale CRISPR-Cas9 knockout screens (or GeCKO) technology. MAGeCK can be used for prioritizing single-guide RNAs, genes and pathways in genome-scale CRISPR/Cas9 knockout screens. MAGeCK identifies both positively and negatively selected genes simultaneously and reports robust results across different experimental conditions. MAGeCK is developed and maintained by Wei Li and Han Xu from `Prof. Xiaole Shirley Liu's lab`_ at the Department of Biostatistics and Computational Biology, Dana-Farber Cancer Institute and Harvard School of Public Health. MAGeCK has been used to identify functional lncRNAs from screens with close to `100% validation rate`_. 

.. _`Model-based Analysis of Genome-wide CRISPR-Cas9 Knockout`: https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0554-4
.. _`100% validation rate`: https://sourceforge.net/p/mageck/wiki/Home/
.. _`Prof. Xiaole Shirley Liu's lab`: http://liulab.dfci.harvard.edu/

-----

**mageck count**

**Inputs**

By default, MAGeCK count command will automatically determine the trimming length of the fastq file.

**sgRNA library file**

When starting from fastq files, MAGeCK needs to know the sgRNA sequence and its targeting gene. Such information is provided in the sgRNA library file, and can be specified by the -l/--list-seq option in the count subcommand.
The sgRNA library file can be provided either in .txt format or in .csv format. There are three columns in the library file: the sgRNA ID, the sequence, and the gene it is targeting. One example of the library file is provided as library.txt in demo2:

======== ==================== =====
sgRNA ID Sequence             gene
-------- -------------------- -----
s_10007  TGTTCACAGTATAGTTTGCC CCNA1
s_10008  TTCTCCCTAATTGCTTGCTG CCNA1
s_10027  ACATGTTGCTTCCCCTTGCA CCNC
======== ==================== =====


-----

**mageck test**

**Inputs**

**sgRNA count file**

The sgRNA read count file will be used in -k parameter in the test sub-command.
The read count file should list the names of the sgRNA, the gene it is targeting, followed by the read counts in each sample. Each item should be separated by the tab ('\t'). A header line is optional. For example in the studies of T. Wang et al. Science 2014, there are 4 CRISPR screening samples, and they are labeled as: HL60.initial, KBM7.initial, HL60.final, KBM7.final. Here are a few lines of the read count file:

  ==============  ========    ================    ================   ==============   ============== 
  **sgRNA**       **gene**    **HL60.initial**    **KBM7.initial**   **HL60.final**   **KBM7.final**
  --------------  --------    ----------------    ----------------   --------------   --------------
  A1CF_m52595977  A1CF        213                 274                883              175
  A1CF_m52596017  A1CF        294                 412                1554             1891
  A1CF_m52596056  A1CF        421                 368                566              759
  A1CF_m52603842  A1CF        274                 243                314              855
  A1CF_m52603847  A1CF        0                   50                 145              266
  ==============  ========    ================    ================   ==============   ============== 

**Sample labels**

In the -t/--treatment-id, -c/--control-id parameters, you can use either sample label or sample index to specify samples. If sample label is used, the labels MUST match the sample labels in the first line of the count table. For example, "HL60.final,KBM7.final".
You can also use sample index to specify samples. The index of the sample is the order it appears in the sgRNA read count file, starting from 0. The index is used in the -t/--treatment-id, -c/--control-id parameters. In the example above, there are four samples, and the index of each sample is as follows:

  ============  =======
  *sample*      *index*
  ------------  -------
  HL60.initial  0
  KBM7.initial  1
  HL60.final    2
  KBM7.final    3
  ============  =======

-----

**Outputs**

**sgRNA Summary file**

An example of the sgRNA ranking output is as follows:

================  ========  ================= ===================  ================  ============== =======  ===============  ===========  =========  ========= =========== ============== ===========  =====================
**sgrna**         **Gene**  **control_count** **treatment_count**  **control_mean**  **treat_mean** **LFC**  **control_var**  **adj_var**  **score**  **p.low** **p.high**  **p.twosided** **FDR**      **high_in_treatment**
----------------  --------  ----------------- -------------------  ----------------  -------------- -------  ---------------  -----------  ---------  --------- ----------- -------------- -----------  ---------------------
INO80B_m74682554  INO80B    0.0/0.0           1220.15/1476.14      0.810860          1348.15        10.70    0.0              19.0767      308.478    1.0       1.11022e-16  2.22044e-16   1.57651e-14  True
NHS_p17705966     NHS       1.62172/3.90887   2327.09/1849.95      2.76529           2088.52        9.54     2.61554          68.2450      252.480    1.0       1.11022e-16  2.22044e-16   1.57651e-14  True
================  ========  ================= ===================  ================  ============== =======  ===============  ===========  =========  ========= =========== ============== ===========  =====================

The contents of each column are as follows:

* **sgrna** sgRNA ID
* **Gene**  The targeting gene
* **control_count** Normalized read counts in control samples
* **treatment_count** Normalized read counts in treatment samples
* **control_mean**  Mean read counts in control samples
* **treat_mean**  Mean read counts in treatment samples
* **LFC** The log fold change of sgRNA
* **control_var** The raw variance in control samples
* **adj_var** The adjusted variance in control samples
* **score** The score of this sgRNA
* **p.low** p-value (lower tail)
* **p.high**  p-value (higher tail)
* **p.twosided**  p-value (two sided)
* **FDR** false discovery rate
* **high_in_treatment** Whether the abundance is higher in treatment samples


**Gene Summary file**
 
An example of the gene summary output file is as follows:

======= ======= ============= =============== =========== ============ ================= =========== ============= =============== =========== ============ ================= ===========
**id**  **num** **neg|score** **neg|p-value** **neg|fdr** **neg|rank** **neg|goodsgrna** **neg|lfc** **pos|score** **pos|p-value** **pos|fdr** **pos|rank** **pos|goodsgrna** **pos|lfc**
------- ------- ------------- --------------- ----------- ------------ ----------------- ----------- ------------- --------------- ----------- ------------ ----------------- -----------
ESPL1   12      6.4327e-10    7.558e-06       7.9e-05      1           -2.35             11          0.99725       0.99981         0.999992    615          0                 -0.07
RPL18   12      6.4671e-10    7.558e-06       7.9e-05      2           -2.12             11          0.99799       0.99989         0.999992    620          0                 -0.32
CDK1    12      2.6439e-09    7.558e-06       7.9e-05      3           -1.93             12          1.0           0.99999         0.999992    655          0                 -0.12
======= ======= ============= =============== =========== ============ ================= =========== ============= =============== =========== ============ ================= ===========

The contents of each column is as follows:

* **id**  Gene ID
* **num** The number of targeting sgRNAs for each gene
* **neg|score** The RRA lo value of this gene in negative selection
* **neg|p-value** The raw p-value (using permutation) of this gene in negative selection
* **neg|fdr** The false discovery rate of this gene in negative selection
* **neg|rank**  The ranking of this gene in negative selection
* **neg|goodsgrna** The number of "good" sgRNAs, i.e., sgRNAs whose ranking is below the alpha cutoff (determined by the --gene-test-fdr-threshold option), in negative selection.
* **neg|lfc** The log fold change of this gene in negative selection
* **pos|score** The number of targeting sgRNAs for each gene in positive selection (usually the same as num.neg)
* **pos|score** The RRA lo value of this gene in negative selection
* **pos|p-value** The raw p-value of this gene in positive selection
* **pos|fdr** The false discovery rate of this gene in positive selection
* **pos|rank**  The ranking of this gene in positive selection
* **pos|goodsgrna** The number of "good" sgRNAs, i.e., sgRNAs whose ranking is below the alpha cutoff (determined by the --gene-test-fdr-threshold option), in positive selection.
* **pos|lfc** The log fold change of this gene in positive selection

Genes are ranked by the p.neg field (by default). If you need a ranking by the p.pos, you can use the --sort-criteria option.

.. _`here`: https://sourceforge.net/p/mageck/wiki/advanced_tutorial/#tutorial-2-correct-the-effects-from-copy-number-variations

    ]]></help>
      <expand macro="citations" />
</tool>

