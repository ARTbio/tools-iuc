<tool id="flair_collapse" name="FLAIR collapse" version="@TOOL_VERSION@">
	<description>Defines high-confidence isoforms from flair-corrected reads.</description>

	<macros>
		<import>flair_macros.xml</import>
	</macros>

	<expand macro="requirements" />
	<expand macro="version_command" />

	<command detect_errors="exit_code"><![CDATA[

flair.py collapse

###########
## Input ##
###########

-q '$input_query'
-r '$input_reads'
-g '$input_genome'
-f '$input_gtf'

#if $input_promotors:
    -p $input_promotors
#end if

########################
## Additional Options ##
########################

-w $additional_options.window
-s $additional_options.support
$additional_options.stringent

#if str($additional_options.select_uniqueness) != "":
	-n str($additional_options.select_uniqueness)
#end if

$additional_options.isoform
--max_ends $additional_options.maxends
$additional_options.trustends

#if str($additional_options.select_filter) != "":
	-e str($additional_options.select_filter)
#end if

#########
## END ##
#########

	]]></command>
	<inputs>
		<param name="input_query" argument="-q" type="data" format="bed" label="Corrected Reads as Bed File"/>
		<param name="input_reads" argument="-r" type="data" format="fasta,fastq" label="FASTA/FASTQ file of raw reads"/>
		<param name="input_genome" argument="-g" type="data" format="fasta" label="FASTA of Reference Genome"/>
		<param name="input_gtf" argument="-f" type="data" format="gtf" label="GTF annotation file"/>
		<param name="input_promotors" optional="true" argument="-p" type="data" format="bed" label="BED File" />

		<param name="out_format" type="select" multiple="true" label="Output data type">
			<option value="bed" selected="true">BED</option>
			<option value="gtf">GTF</option>
			<option value="fasta">FASTA</option>
		</param>

		<!-- Additional Options -->
		<section name="additional_options" title="Additional Options">
			<param name="window" argument="-w" type="integer" min="0" value="100" label="Window Size" help="Window size for comparing TSS/TES (Default=100)" />
			<param name="support" argument="-s" type="integer" min="0" value="3" label="Supporting Reads" help="Minimum number of supporting reads for an isoform (Default=3)" />
			<param name="stringent" argument="--sringent" type="boolean" value="False" truevalue="--stringent" falsevalue="" label="Use Stringent Mode" help="Specify if all supporting reads need to be full-length (80% coverage and spanning 25 bp of the first and last exons) (Default=false)"/>
			<param name="select_uniqueness" argument="-n" type="select" label="Choose the TSS/TES for each unique set of splice junction." >
				<option value="" selected="true"></option>
				<option value="none">Best TSSs/TESs</option>
				<option value="longest">Single TSS/TES chosen to maximize length</option>
				<option value="best_only">Single most supported TSS/TES used in conjunction chosen</option>
			</param>
			<param name="isoform" argument="-i" type="boolean" value="False" truevalue="-i" falsevalue="" label="Use Isoform Mode" help="TSS/TES for each isoform will be determined from supporting reads for individual isoforms (Default=false)"/>
			<param name="maxends" argument="--max_ends" type="integer" min="0" value="2" label="Maximum Number of TSS/TES picked per isoform" help="(Default=2)" />
			<param name="trustends" argument="--trust_ends" type="boolean" value="False" truevalue="--trust_ends" falsevalue="" label="Reads are generated from a long read method with minimal fragmentation?" />
			<param name="select_filter" argument="-e" type="select" label="Filter for isoforms." >
				<option value="" selected="true"></option>
				<option value="nosubset">Any isoforms that are a proper set of another isoform are removed</option>
				<option value="default">Subset isoforms are removed based on support</option>
				<option value="comprehensive">Default set + all subset isoforms</option>
				<option value="ginormous">Comprehensive set + single exon subset isoforms</option>
			</param>
			<param name="mapq" argument="--quality" type="integer" min="0" value="1" label="Minimum MAPQ of read assignment to an isoform" help="(Default=1)" />
		</section>
	</inputs>

	<outputs>
		<data format="bed" name="outfile_isoforms" from_work_dir="flair.collapse.isoforms">
			<change_format>
				<when input="out_format" value="gtf" format="gtf" />
				<when input="out_format" value="fasta" format="fasta"  />
			</change_format>
		</data>
	</outputs>

	<tests>
		<!-- Test Data -->
		<test expect_num_outputs="1">
			<param name="input_query" ftype="bed" value="flair_all_corrected.bed" />
			<param name="input_reads" ftype="bed" value="EEF1A1.fastq" />
			<param name="input_genome" ftype="fasta" value="hg38.fa" />
			<param name="input_gtf" ftype="gtf" value="UCSC_Main_on_Human__knownGene_region.gtf" />
			<param name="out_format" value="bed" />
			<output name="outfile_isoforms" ftype="bed" file="flair.collapse.isoforms.bed" />
		</test>
		<test expect_num_outputs="1">
			<param name="input_query" ftype="bed" value="flair_all_corrected.bed" />
			<param name="input_reads" ftype="bed" value="EEF1A1.fastq" />
			<param name="input_genome" ftype="fasta" value="hg38.fa" />
			<param name="input_gtf" ftype="gtf" value="UCSC_Main_on_Human__knownGene_region.gtf" />
			<param name="out_format" value="gtf" />
			<output name="outfile_isoforms" ftype="gtf" file="flair.collapse.isoforms.gtf" />
		</test>
		<test expect_num_outputs="1">
			<param name="input_query" ftype="bed" value="flair_all_corrected.bed" />
			<param name="input_reads" ftype="bed" value="EEF1A1.fastq" />
			<param name="input_genome" ftype="fasta" value="hg38.fa" />
			<param name="input_gtf" ftype="gtf" value="UCSC_Main_on_Human__knownGene_region.gtf" />
			<param name="out_format" value="fasta" />
			<output name="outfile_isoforms" ftype="fasta" file="flair.collapse.isoforms.fa" />
		</test>
	</tests>
	<help><![CDATA[

.. class:: infomark

**What it does**

-------------------

@description@

**flair collapse**
Defines high-confidence isoforms from corrected reads.

-------------------

**Inputs**

-------------------

(1) Corrected Reads as Bed12 File.
(2) FASTA/FASTQ file of raw reads. All raw read fastq/fasta files should be concatenated into a single file.
(3) FASTA of Reference Genome.
(4) GTF annotation file.

-----------

**Outputs**

-----------

Outputs the high-confidence isoforms in several formats:
(1) bed,
(2) gtf,
(3) FASTA.

--------------------

**More Information**

--------------------

See the excellent `FLAIR documentation`_

.. _`FLAIR documentation`: https://github.com/BrooksLabUCSC/flair


--------------------

**Galaxy Wrapper Development**

--------------------

@citation@

	]]></help>
	<expand macro="citations" />
</tool>
