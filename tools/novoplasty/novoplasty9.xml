<?xml version="1.0"?>
<tool id="novoplasty" name="NOVOplasty9" version="@TOOL_VERSION@+galaxy0" profile="18.01">
    <description>de novo assembler for short circular genomes</description>
    <macros>
        <token name="@TOOL_VERSION@">3.7.2</token>
        <xml name="content" token_min="" token_max="">
            <param name="genome_range_min" type="text" value="@MIN@" label="Set lower limit for the expected genome size" help="(Genome Range)">
            </param>
            <param name="genome_range_max" type="text" value="@MAX@" label="Set upper limit for the expected genome size range" help="(Genome Range)">
            </param>
        </xml>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">novoplasty</requirement>
    </requirements>
    <version_command><![CDATA[NOVOPlasty.pl 2>&1 | grep 'Version' | awk -F' ' '{print $2}']]></version_command>
    <command detect_errors="exit_code"><![CDATA[
        ## initialize
        cat '$config' &&

        ## run
        NOVOPlasty.pl -c '$config'

        && ls -lisa
        ]]></command>
    <configfiles>
        <configfile name="config"><![CDATA[
#set $seed = ''
#set $combined = ''
#set $reverse = ''
#set $forward = ''
#set $reference = ''
#set $chloroplast = ''

#if $seed_input
    #set $seed = $seed_input
#end if
#if $reads_cond.reads_sel == 'combined'
    #set $combined = $reads_cond.combined_reads
#else if $reads_cond.reads_sel == 'separate'
    #set $forward = $reads_cond.forward_reads
    #set $reverse = $reads_cond.reverse_reads
#end if        
#if $reference_sequence
    #set $reference = $reference_sequence
#end if
#if $type_cond.type_sel == 'mito_plant'
    #set $chloroplast = $type_cond.chloroplast
#end if


Project:
-----------------------
Project name          = Result
Type                  = ${type_cond.type_sel}
Genome Range          = ${type_cond.genome_range_min}-${type_cond.genome_range_max}
K-mer                 = ${kmer}
Max memory            = 
Extended log          = 1
Save assembled reads  = 2
Seed Input            = ${seed}
Reference sequence    = ${reference}
Variance detection    = #if $reference != '' then 'yes' else ''
Heteroplasmy          = 
Chloroplast sequence  = $chloroplast

Dataset 1:
-----------------------
Read Length           = ${read_length}
Insert size           = ${insert_size}
Platform              = ${platform}
Single/Paired         = ${single_paired}
Combined reads        = ${combined}
Forward reads         = ${forward}
Reverse reads         = ${reverse}

Heteroplasmy:
-----------------------
MAF                   =
HP exclude list       = 
PCR-free              =

Optional:
-----------------------
Insert size auto      = ${insert_size_auto}
Insert Range          = ${insert_range}
Insert Range strict   = ${insert_range_strict}
Use Quality Scores    = ${use_quality_scores}
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="reads_cond" label="">
            <param name="reads_sel" type="select" label="Select read file type" help="(Combined reads/Forward reads/Reverse reads)">
                <option value="combined">Combined reads</option>
                <option value="separate">Separate reads</option>
            </param>
            <when value="combined">
                <param name="combined_reads" type="data" format="fasta" label="Select file with combined reads" help="(Combined reads)"/>
            </when>
            <when value="separate">
                <param name="forward_reads" type="data" format="fasta" label="Select file with forward reads" help="(Forward reads)"/>
                <param name="reverse_reads" type="data" format="fasta" label="Select file with reverse reads" help="(Reverse reads)"/>
            </when>    
        </conditional>
        <param name="seed_input" type="data" format="fasta" label="Select file with seed sequence" help="(Seed Input)"/>
        <param name="reference_sequence" type="data" format="fasta" optional="true" label="Select reference file" help="The assembly will still be de novo, but references of the same genus can be used as a guide to resolve duplicated regions in the plant mitochondria or the inverted repeat in the chloroplast. References from different genus haven't beeen tested yet. (Reference sequence)"/>
        <param name="heteroplasmy" type="float" value="" optional="true" label="Set value for heteroplasmy detection" help="If you want to detect heteroplasmy, first assemble the genome without this option. Then give the resulting sequence as a reference and as a seed input. And give the minimum minor allele frequency for this option (0.01 will detect heteroplasmy of >1%) (Heteroplasmy)"/> <!-- todo minmax -->
        <conditional name="type_cond">
            <param name="type_sel" type="select" multiple="false" label="Select assembly type" help="(Type)">
                <option value="chloro" selected="true">chloroplast assembly (chloro)</option>
                <option value="mito">mitochondrial assembly (mito)</option>
                <option value="mito_plant">mitochondrial assembly in plants (mito_plant)</option>
            </param>
            <when value="chloro">
                <expand macro="content" min="120000" max="200000"/>
            </when>
            <when value="mito">
                <expand macro="content" min="12000" max="20000"/>
            </when>
            <when value="mito_plant">
                <expand macro="content" min="12000" max="20000"/>
                <param name="chloroplast_sequence" type="data" format="fasta" label="Select chloroplast sequence" help="You have to assemble the chloroplast before you assemble the mitochondria of  plants. (Chloroplast sequence)"/>
            </when>
        </conditional>
        <param name="kmer" type="integer" value="33" min="1" label="Set the length of the overlap between matching reads" help="If reads are shorter then 90 bp or you have low coverage data, this value should be decreased down to 23. For reads longer then 101 bp, this value can be increased, but this is not necessary."/> <!-- todo min -->

        <param name="read_length" type="integer" value="151" label="Set read length" help="(Read Length)"/>
        <param name="insert_size" type="integer" value="300" label="Set total insert size of your paired end reads" help="It doesn't have to be accurate but should be close enough. (Insert size)"/>
        <param name="platform" type="select" label="Select platform" help="(Platform)">
            <option value="illumina" selected="true">Illumina</option>
            <option value="ion">ION</option>
        </param>
        <param name="single_paired" type="select" label="Select read type" help="(Single/Paired)">
            <option value="PE" selected="true">Paired</option>
            <option value="SE">Single</option>
        </param>
        <param name="insert_size_auto" type="boolean" truevalue="yes" falsevalue="no" checked="true" label="Finetune your insert size automatically" help="(Insert size auto)"/>

        <param name="insert_range" type="float" value="1.9" label="Set variation of the insert size" help="Lower it when the coverage is very high or raise it when the coverage is too low. (Insert Range)"/> <!-- todo minmax -->
        <param name="insert_range_strict" type="float" value="1.3" label="Set strict variation to resolve repetitive regions" help="(Insert Range strict)"/> <!-- todo minmax -->
        <param name="use_quality_scores" type="boolean" truevalue="yes" falsevalue="no" label="Take quality scores into account?" help="Only use this when reads have low quality, like with the 300 bp reads of Illumina. (Use Quality Scores)"/>



        <param name="out" type="select" multiple="true" optional="false" label="Select output file(s)">
            <!-- Assembly -->
            <option value="arr1" selected="true">Assembled reads R1</option>
            <option value="arr2" selected="true">Assembled reads R2</option>
            <option value="ca1" selected="true">Circularized assembly</option>
            <option value="mc" selected="true">Merged contigs</option>
            <option value="ct" selected="true">Contigs</option>
            <!-- Variance -->
            <option value="v">Variance</option>
            <!-- Heteroplasmy -->
            <option value="h">Heteroplasmy</option>
            <option value="ha">Heteroplasmy assemblies</option>
            <option value="lth">Linkage table heteroplasmy</option>
            <option value="pn">Possible NUMTs</option>
            <option value="pna">Possible NUMTs assemblies</option>
            <option value="ltn">Linkage table NUMTs</option>
            <option value="cmr">Circos mutations</option>
            <option value="cl">Circos links</option>
            <!-- Log -->
            <option value="el" selected="true">Extended log</option>
            <option value="l" selected="true">Log</option>
        </param>
    </inputs>
    <outputs>
        <!-- Assembly -->
        <data name="out_arr1" format="fasta" from_work_dir="Assembled_reads_Result_R1.fasta" label="${tool.name} on ${on_string}: Assembled reads R1">
            <filter>'arr1' in out</filter>
        </data>
        <data name="out_arr2" format="fasta" from_work_dir="Assembled_reads_Result_R2.fasta" label="${tool.name} on ${on_string}: Assembled reads R2">
            <filter>'arr2' in out</filter>
        </data>
        <data name="out_ca1" format="fasta" from_work_dir="Circularized_assembly_1_Result.fasta" label="${tool.name} on ${on_string}: Circularized assembly">
            <filter>'ca1' in out</filter>
        </data>
        <data name="out_mc" format="fasta" from_work_dir="Merged_contigs_Result.txt" label="${tool.name} on ${on_string}: Merged contigs">
            <filter>'mc' in out</filter>
        </data>
        <data name="out_ct" format="txt" from_work_dir="contigs_tmp_Result.txt" label="${tool.name} on ${on_string}: Contigs">
            <filter>'ct' in out</filter>
        </data>
        <!-- Variance -->
        <data name="out_v" format="vcf" from_work_dir="Variance_Result.vcf" label="${tool.name} on ${on_string}: Variance">
            <filter>'v' in out</filter>
        </data>
        <!-- Heteroplasmy -->     
        <data name="out_h" format="vcf" from_work_dir="Heteroplasmy_Result.vcf" label="${tool.name} on ${on_string}: Heteroplasmy">
            <filter>'h' in out</filter>
        </data>
        <data name="out_ha" format="fasta" from_work_dir="Heteroplasmy_assemblies_Result.fasta" label="${tool.name} on ${on_string}: Heteroplasmy assemblies">
            <filter>'ha' in out</filter>
        </data>
        <data name="out_lth" format="txt" from_work_dir="Linkage_table_heteroplasmy_Result.txt" label="${tool.name} on ${on_string}: Linkage table heteroplasmy">
            <filter>'lth' in out</filter>
        </data>
        <data name="out_pn" format="vcf" from_work_dir="Possible_NUMTs_Result.vcf" label="${tool.name} on ${on_string}: Possible NUMTs">
            <filter>'pn' in out</filter>
        </data>
        <data name="out_pna" format="fasta" from_work_dir="Possible_NUMTs_assemblies_Result.fasta" label="${tool.name} on ${on_string}: Possible_NUMTs_assemblies_project.fasta">
            <filter>'pna' in out</filter>
        </data>
        <data name="out_ltn" format="txt" from_work_dir="Linkage_table_NUMTs_Result.txt" label="${tool.name} on ${on_string}: Linkage table NUMTs">
            <filter>'ltn' in out</filter>
        </data>
        <data name="out_cmr" format="txt" from_work_dir="Circos_mutations_Result.txt" label="${tool.name} on ${on_string}: Circos mutations">
            <filter>'cmr' in out</filter>
        </data>
        <data name="out_cl" format="txt" from_work_dir="Circos_links_Result.txt" label="${tool.name} on ${on_string}: Circos links">
            <filter>'cl' in out</filter>
        </data>
        <!-- Log -->
        <data name="out_el" format="txt" from_work_dir="log_extended_Result.txt" label="${tool.name} on ${on_string}: Extended log">
            <filter>'el' in out</filter>
        </data>
        <data name="out_l" format="txt" from_work_dir="log_Result.txt" label="${tool.name} on ${on_string}: Log">
            <filter>'l' in out</filter>
        </data>
    </outputs>
    <tests>
        <!-- #1 default, combined -->
        <test expect_num_outputs="1">
            <param name="seed_input" value="seed.fasta"/>
            <conditional name="reads_cond">
                <param name="read_sel" value="combined"/>
                <param name="combined_reads" value="combined.fasta"/>
            </conditional>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression=".+"/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 default, separate -->
        <test expect_num_outputs="1">
            <conditional name="reads_cond">
                <param name="read_sel" value="combined"/>
                <param name="forward_reads" value="forward.fasta"/>
                <param name="reverse_reads" value="reverse.fasta"/>
            </conditional>
            <output name="out_l">
                <assert_contents>
                    <has_text_matching expression=".+"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

NOVOPlasty is a de novo assembler and heteroplasmy/variance caller for short circular genomes.

**Input**

- suitable seed: There are different types of seed possible: A single read from the dataset that originates from the organelle genome. A organelle sequence derived from the same or a related species. A complete organelle sequence of a more distant species (recommended when there is no close related sequence available)
- input reads: Either two separate files(forward and reverse) or a merged fastq/fasta file. Multiple libraries as input is not yet supported. There is also an Ion Torrent option, but it does not produce the best results.

**Output**

- Contigs: This file contains all the assembled contigs.
- Circularized _assembly: When NOVOPlasty is able to circularize one contig, without any additional contigs being produced, it will just output this circularized fasta file.
- Merged contigs: When there are multiple contigs, NOVOPlasty will try to combine all contigs in to a complete circular genome, all the different possibilities can be found in this file.
- Contigs: If non of the above files are outputted or are empty, you can retrieve some contigs from this file.
- Variance: When the variance detection option is selected, an additional vcf file will be outputted.
- Heteroplasmy: This vcf file contains all the detected heteroplasmy positions.
- Heteroplasmy assemblies: NOVOPlasty will assemble around each position of the above vcf output. The resulting assemblies will be outputted in this fasta file.
- Linkage table heteroplasmy: This file contains all the polymorphisms that are fully/partially/not linked with each detected heteroplasmic position.
- Possible NUMTs / Possible NUMTs assemblies / Linkage table NUMTs: These are the same files as the above three, but then for all the polymorphisms that were identified as NUMT origin.
- Circos mutations / Circos links: These files can be used to draw figures with Circos. See "Circos Figures" section.
- Log: This is a basic log file with the information that shows up on your terminal.
- Extended log: A elaborate log file that can be send to me for troubleshooting, it won't provide the user additional info.

.. class:: infomark

**References**

More information are available on `github <https://github.com/ndierckx/NOVOPlasty/>`_.
    ]]></help>
    <citations>
        <citation type="doi">10.1093/nar/gkw955</citation>
        <citation type="doi">10.1093/nargab/lqz011</citation>
    </citations>
</tool>