<tool id="kofamscan" name="KofamScan" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>gene function annotation based on KEGG orthology and HMM</description>
    <macros>
        <token name="@TOOL_VERSION@">1.3.0</token>    
        <token name="@VERSION_SUFFIX@">0</token>
        <xml name="reportannotation" token_selected="">
            <param name="reportannotation" type="boolean" truevalue="--report-unannotated" falsevalue="--no-report-unannotated" selected="@SELECTED@" label="Shown sequence name even if no KOs are assigned?"/>
            </xml>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kofamscan</requirement>
        <requirement type="package" version="3.0">zip</requirement>
    </requirements>
    <version_command><![CDATA[exec_annotation | grep "exec_annotation version" | cut -d" " -f 4]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
ls -lisa &&

## preprocessing
mkdir 'profile' &&
#if $p_cond.p_sel == 'compressed'
    tar -xzf '${p_cond.p}' -C 'profile' &&
#elif $p_cond.p_sel == 'hmm'
    ## input files require prefix 'K' and file extension '.hmm'
    #for $i, $current in enumerate($p_cond.p)
        ln -s '$current' 'profile/K${i}.hmm' &&
    #end for
#end if

ls -lisa profile &&

## run
exec_annotation
-p 'profile'
-o 'results.txt'
-k '$k'
-cpu \${GALAXY_SLOTS:-4}
-E $E
#if $ap.T
    -T $ap.T
#end if
-f '$ap.f_cond.f_sel'
'$ap.f_cond.reportannotation'


#if 'alignment' in $op.
    && test -d 'tmp/alignment' && zip -q -r 'tmp/alignment.zip' 'tmp/alignment/*' || echo 'No alignment files.'
#end if

'$query' 

&& ls -lisa

## postprocessing
    ]]></command>
    <inputs>
        <param name="query" type="data" format="fasta" label="Select query file" help="You cannot use nucleotide sequences."/>
        <conditional name="p_cond">
            <param name="p_sel" type="select" label="Select profile input type">
                <option value="compressed" selected="true">Compressed set of HMM and HAL files</option>
                <option value="hmm">HMM file(s)</option>
            </param>
            <when value="compressed">
                <param argument="-p" type="data" format="data" label="Select a compressed file with HMM and HAL files" help="tar.gz archives are available from KofamKOALA web service (https://www.genome.jp/tools/kofamkoala/)."/>
            </when>
            <when value="hmm">
                <param argument="-p" type="data" format="hmm3" multiple="true" label="Select profile HMM file(s)"/>
            </when>
        </conditional>
        <param argument="-k" type="data" format="tabular" label="Select KO list file"/>
        <param argument="-E" type="float" min="0.0" max="1.0" value="0.01" label="Set E-value threshold"/>
        <section name="ap" label="Advanced parameters" expanded="true">
            <!-- TODO type, min, max, default missing, readme mentions -T2 so it seems to be an integer, but -T2 looks like a typo -->
            <param argument="-T" type="integer" value="" optional="true" label="Set threshold scale" help="The score thresholds will be multiplied by this value."/>
            <conditional name="f_cond">
                <param name="f_sel" type="select" label="Select output format">
                    <option value="detail" selected="true">Details for each hit (including hits below threshold) (detail)</option>
                    <option value="detail-tsv">Tab separeted values for detail format (detail-tsv)</option>
                    <option value="mapper">KEGG Mapper compatible format (mapper)</option>
                    <option value="mapper-one-line">KEGG Mapper compatible format, but all hit KOs are listed in one line (mapper-oneline)</option>
                </param>
                <when value="detail">
                    <expand macro="reportannotation" selected="false"/>
                </when>
                <when value="detail-tsv">
                    <expand macro="reportannotation" selected="false"/>
                </when>
                <when value="mapper">
                    <expand macro="reportannotation" selected="true"/>
                </when>
                <when value="mapper-one-line">
                    <expand macro="reportannotation" selected="true"/>
                </when>  
            </conditional>
             <!-- TODO better description required, not sure how to describe the content of these two files-->
            <param name="tabular" type="boolean" label="Create tabular files?"/>
            <param name="output" type="boolean" label="Create output files?"/>
            <param name="alignments" type="boolean" label="Create alignment files?"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_result" format="txt" from_work_dir="results.txt" label="${tool.name} on ${on_string}: Result" />
        <!-- TODO change label -->
        <data name="out_tabular" format="txt" from_work_dir="tmp/tabular/tabular.txt" label="${tool.name} on ${on_string}: Tabular">
            <filter>ap['tabular']</filter>
        </data>
        <data name="out_output" format="txt" from_work_dir="tmp/output/output.txt" label="${tool.name} on ${on_string}: Output">
            <filter>ap['output']</filter>
        </data>
        <data name="out_alignment" format="txt" from_work_dir="tmp/alignment.zip" label="${tool.name} on ${on_string}: Alignments">
            <filter>ap['alignments']</filter>
        </data>
    </outputs>
    <tests>
        <!-- with single hmm file and default parameters -->

        <test>
            <param name="fasta_file" value="protein_in.fasta" />
            <param name="k" value="ko_list" />
            <conditional name="profile">
                <param name="profile_sel" value="single"/>
                <param name="p" value="K00001.hmm"/>
            </conditional>
            <output name="result">
                <assert_contents>
                    <has_n_lines n="5"/>
                    <has_line line="  sp|P00325|ADH1B_HUMAN  K00001  361.33  344.3  4.7e-106 alcohol dehydrogenase [EC:1.1.1.1]"/>
                </assert_contents>
            </output>
        </test>


    </tests>
    <help><![CDATA[

...
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btz859</citation>
    </citations>
</tool>