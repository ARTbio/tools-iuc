<tool id="kofamscan" name="KofamScan" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>gene function annotation based on KEGG orthology and HMM</description>
    <macros>
        <token name="@TOOL_VERSION@">1.3.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <xml name="reportannotation" token_selected="">
            <param name="reportannotation" type="boolean" truevalue="--report-unannotated" falsevalue="--no-report-unannotated" checked="@SELECTED@" label="Shown sequence name even if no KOs are assigned?"/>
            </xml>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kofamscan</requirement>
        <requirement type="package" version="3.0">zip</requirement>
    </requirements>
    <version_command><![CDATA[exec_annotation -v | grep "exec_annotation" | cut -d" " -f 2]]></version_command>
    <command detect_errors="exit_code"><![CDATA[
ls -lisa &&

## preprocessing
mkdir 'profile' &&
#if $p_cond.p_sel == 'compressed'
    tar -xf '${p_cond.p}' -C 'profile' > /dev/null && ## TODO notwendig?
#elif $p_cond.p_sel == 'hmm'
    ## input files require prefix 'K' and file extension '.hmm'
    #for $i, $current in enumerate($p_cond.p)
        ln -s '$current' 'profile/K${i}.hmm' &&
    #end for
#end if

ls -lisa profile &&

## run
exec_annotation
-p 'profile'
-o 'results.txt'
-k '$k'
--cpu \${GALAXY_SLOTS:-4}
-E $E
#if $ap.T
    -T $ap.T
#end if
-f '$ap.f_cond.f_sel'
$ap.f_cond.reportannotation
#if $ap.alignments
    --create-alignment
#end if
'$query'

&& ls -lisa
&& ls -lisa tmp
&& test -d 'tmp/alignment' && ls -lisa tmp/alignment || echo 'nope'


## postprocessing
#if $ap.alignments
    && test -d 'tmp/alignment' && zip -q -r 'tmp/alignment.zip' tmp/alignment/* || echo 'No alignment files.'
#end if 

&& ls -lisa
    ]]></command>
    <inputs>
        <param name="query" type="data" format="fasta" label="Select query sequence file" help="Nucleotide sequences are not accepted."/>
        <conditional name="p_cond">
            <param name="p_sel" type="select" label="Select profile input type">
                <option value="compressed" selected="true">Compressed set of HMM and HAL files</option>
                <option value="hmm">HMM file(s)</option>
            </param>
            <when value="compressed">
                <param argument="-p" type="data" format="data" label="Select a compressed file with HMM and HAL files" help="tar.gz archives are available from KofamKOALA web service (https://www.genome.jp/tools/kofamkoala/)."/>
            </when>
            <when value="hmm">
                <param argument="-p" type="data" format="hmm3" multiple="true" label="Select profile HMM file(s)"/>
            </when>
        </conditional>
        <param argument="-k" type="data" format="tabular" label="Select KO list file"/>
        <param argument="-E" type="float" min="0.0" max="1.0" value="0.01" label="Set E-value threshold"/>
        <section name="ap" title="Advanced parameters" expanded="true">
            <!-- TODO type, min, max, default missing, readme mentions -T2 so it seems to be an integer, but -T2 looks like a typo -->
            <param argument="-T" type="integer" value="" optional="true" label="Set threshold scale" help="The score thresholds will be multiplied by this value."/>
            <conditional name="f_cond">
                <param name="f_sel" type="select" label="Select output format">
                    <option value="detail" selected="true">Details for each hit (including hits below threshold) (detail)</option>
                    <option value="detail-tsv">Tab separeted values for detail format (detail-tsv)</option>
                    <option value="mapper">KEGG Mapper compatible format (mapper)</option>
                    <option value="mapper-one-line">KEGG Mapper compatible format, but all hit KOs are listed in one line (mapper-oneline)</option>
                </param>
                <when value="detail">
                    <expand macro="reportannotation" selected="false"/>
                </when>
                <when value="detail-tsv">
                    <expand macro="reportannotation" selected="false"/>
                </when>
                <when value="mapper">
                    <expand macro="reportannotation" selected="true"/>
                </when>
                <when value="mapper-one-line">
                    <expand macro="reportannotation" selected="true"/>
                </when>
            </conditional>
             <!-- TODO better description required, not sure how to describe the content of these two files-->
            <param name="tabular" type="boolean" label="Create tabular files?"/>
            <param name="output" type="boolean" label="Create output files?"/> <!-- TODO maybe HMMsearch query output/log? -->
            <param name="alignments" type="boolean" label="Create alignment files?"/>
        </section>
    </inputs>
    <outputs>
        <data name="out_result" format="txt" from_work_dir="results.txt" label="${tool.name} on ${on_string}: Result" />
        <!-- TODO change label -->
        <data name="out_tabular" format="txt" from_work_dir="tmp/tabular/tabular.txt" label="${tool.name} on ${on_string}: Tabular">
            <filter>ap['tabular']</filter>
        </data>
        <data name="out_output" format="txt" from_work_dir="tmp/output/output.txt" label="${tool.name} on ${on_string}: Output">
            <filter>ap['output']</filter>
        </data>
        <data name="out_alignment" format="zip" from_work_dir="tmp/alignment.zip" label="${tool.name} on ${on_string}: Alignments">
            <filter>ap['alignments']</filter>
        </data>
    </outputs>
    <tests>
        <!-- #1 default -->
        <test>
            <param name="query" value="query.fasta"/>
            <conditional name="p_cond">
                <param name="p_sel" value="compressed"/>
                <param name="p" value="profiles.tar.gz"/>
            </conditional>
            <param name="k" value="ko"/>
            <output name="out_result">
                <assert_contents>
                    <has_n_lines n="5"/>
                    <has_text_matching expression=".+sp\|P00329\|ADH1_MOUSE.+"/>
                </assert_contents>
            </output>
        </test>
        <!-- #2 -->
        <test>
            <param name="query" value="query.fasta"/>
            <conditional name="p_cond">
                <param name="p_sel" value="hmm"/>
                <param name="p" value="K00001.hmm,K00002.hmm,K00003.hmm"/>
            </conditional>
            <param name="k" value="ko"/>
            <param name="E" value="0.02"/>
            <section name="ap">
                <param name="T" value="2"/>
                <conditional name="f_cond">
                    <param name="f_sel" value="detail-tsv"/>
                    <param name="reportannotation" value="true"/>
                </conditional>
                <param name="tabular" value="true"/>
                <param name="output" value="true"/>
                <param name="alignments" value="true"/>
            </section>
            <output name="out_result">
                <assert_contents>
                    <has_n_lines n="9"/>
                    <has_text_matching expression=".+sp\|P19858\|LDHA_BOVIN"/>
                </assert_contents>
            </output>
            <output name="out_tabular">
                <assert_contents>
                    <has_n_lines n="48"/>
                    <has_line line="K1"/>
                </assert_contents>
            </output>
            <output name="out_output">
                <assert_contents>
                    <has_n_lines n="224"/>
                    <has_line line="Internal pipeline statistics summary:"/>
                </assert_contents>
            </output>
            <output name="out_alignment">
                <assert_contents>
                    <has_size value="4099"/>
                </assert_contents>
            </output>
        </test>
        <!-- #3 -->
        <test>
            <param name="query" value="query.fasta"/>
            <conditional name="p_cond">
                <param name="p_sel" value="hmm"/>
                <param name="p" value="K00001.hmm,K00002.hmm,K00003.hmm"/>
            </conditional>
            <param name="k" value="ko"/>
            <section name="ap">
                <conditional name="f_cond">
                    <param name="f_sel" value="mapper"/>
                </conditional>
            </section>
            <output name="out_result">
                <assert_contents>
                    <has_n_lines n="7"/>
                    <has_line line="sp|P19858|LDHA_BOVIN"/>
                </assert_contents>
            </output>
        </test>
        <!-- #4 -->
        <test>
            <param name="query" value="query.fasta"/>
            <conditional name="p_cond">
                <param name="p_sel" value="hmm"/>
                <param name="p" value="K00001.hmm,K00002.hmm,K00003.hmm"/>
            </conditional>
            <param name="k" value="ko"/>
            <section name="ap">
                <conditional name="f_cond">
                    <param name="f_sel" value="mapper-one-line"/>
                </conditional>
            </section>
            <output name="out_result">
                <assert_contents>
                    <has_n_lines n="7"/>
                    <has_line line="sp|P19858|LDHA_BOVIN"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
.. class:: infomark

**What it does**

KofamScan is a gene function annotation tool based on KEGG Orthology and hidden Markov model.

**Input**

- a query file in FASTA format with one or more amino acid sequences. Each sequence must have a unique name. A name of a sequence is a string between the header symbol (">") and the first blank character (whitespace, tab, line break, etc.). Do not put a whitespace right after ">".
- a KO list file of KOfam
- KOfam profile files in HMM3 format or a compressed dataset containing HMM3 profiles and HAL filtering files available e.g. `here <ftp://ftp.genome.jp/pub/db/kofam/>`_

**Output**

- KofamScan output
- hmmsearch results as alignments, run output and tabular summary

.. class:: infomark

**References**

More information are available on `GitHub <https://github.com/takaram/kofam_scan>`_ and the `webserver <https://www.genome.jp/tools/kofamkoala/>`.
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btz859</citation>
    </citations>
</tool>