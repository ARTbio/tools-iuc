<?xml version="1.0" encoding="utf-8"?>
<tool id="merlin" name="Tool for Linkage Analysis" version="0.1.0" python_template_version="3.5">
    <requirements>
        <requirement type="package">merlin</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    merlin -p $pname -m $mname -d $dname --quiet --error --best --npl 
    
    #if $markerNames
    --markerNames
    #end if

    #if $minStep
    --minStep $minStep
    #end if

    #if $maxStep
    --maxStep $maxStep
    #end if

    #if $steps
    --steps $steps
    #end if

    #if $grid
    --grid $grid
    #end if

    #if $start
    --start $start
    #end if

    #if $stop
    --stop $stop
    #end if
    
    > $merlinoutput
    ]]></command>
    <inputs>
	<param name="pname" type="data" format="txt" help="Set of data values" />
	<param name="mname" type="data" format="txt" help="Set of map values" />
	<param name="dname" type="data" format="txt" help="Set of pedigree values" />
	<!-- Beginning of the optional paramters -->
	<param name="markerNames" type="boolean" checked="false" optional="true" label="For Marker Serial" help="Useful to eliminate numbers and introduce serial" />
	<param name="minStep" type="float" optional="true" label="For Minimum Step" help="Useful to find the minimum value" />
	<param name="maxStep" type="float" optional="true" label="For Maximum Step" help="Useful to find the maximum value" />
	<param name="steps" type="integer" min="0" optional="true" label="Steps" help="I can't" />
	<param name="grid" type="integer" min="0" optional="true" label="Grid" help="I can't" />
	<param name="start" type="integer" min="0" optional="true" label="Getting Started" help="Useful to start" />
	<param name="stop" type="integer" min="0" optional="true" label="Halt" help="Useful to stop" />
    </inputs>
    <outputs>
	<data name="errors" format="txt" from_work_dir="merlin.err" />
	<data name="flow" format="txt" from_work_dir="merlin.flow" />
	<data name="chromosome" format="txt" from_work_dir="merlin.chr" />
	<data name="merlinoutput" format="lod" />
    </outputs>
    <tests>
	<test>
	    <!-- No optional parameters used in this test -->
	    <param name="pname" value="parametric.ped"/>
	    <param name="mname" value="parametric.map"/>
	    <param name="dname" value="parametric.dat"/>
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text="MRK1 MRK2 MRK3 MRK4 MRK5 MRK6 MRK7 MRK8 MRK9 MRK10" />
		    <not_has_text text="--minStep [2]" />
		    <has_line line="Phenotype: VERY_RARE_DISEASE [ALL] (1 family)" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="parametric.chr" />
	    <output name="flow" file="parametric.flow" />
	    <output name="errors" file="parametric.err" />
	</test>
	<test>
	    <!-- This test uses markerNames optional parameter -->
	    <param name="pname" value="x.ped"/>
	    <param name="mname" value="x.map"/>
	    <param name="dname" value="x.dat"/>
	    <param name="markerNames" value="true" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "MRK1 MRK2 MRK3 MRK4 MRK5 MRK6 MRK7 MRK8 MRK9 MRK10" />
		    <has_text text= "Family:     1 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text="Family:     2 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:     3 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:     4 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:     5 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <not_has_text text="--minStep [2]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="x.chr" />
	    <output name="flow" file="x.flow" />
	    <output name="errors" file="x.err" />
	</test>
	<test>
	    <!-- This test uses minStep optional parameter -->
	    <param name="pname" value="haplo.ped"/>
	    <param name="mname" value="haplo.map"/>
	    <param name="dname" value="haplo.dat"/>
	    <param name="minStep" value="2" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "SNP-1 SNP-2 SNP-3" />
		    <has_text text= "--minStep [2.00]" />
		    <not_has_text text="--markerNames [ON]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="haplo.chr" />
	    <output name="flow" file="haplo.flow" />
	    <output name="errors" file="haplo.err" />
	</test>
	<test>
	    <!--This test uses steps optinal parameter -->
	    <param name="pname" value="asp.ped"/>
	    <param name="mname" value="asp.map"/>
	    <param name="dname" value="asp.dat"/>
	    <param name="steps" value="3" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "Phenotype: affection [ALL] (200 families)" />
		    <has_text text= "--steps [3]" />
		    <not_has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="asp.chr" />
	    <output name="flow" file="asp.flow" />
	    <output name="errors" file="asp.err" />
	</test>
	<test>
	    <!-- This test uses grid optional parameter -->
	    <param name="pname" value="sibs.ped"/>
	    <param name="mname" value="sibs.map"/>
	    <param name="dname" value="sibs.dat"/>
	    <param name="grid" value="3" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "SNP_1 SNP_2 SNP_3" />
		    <has_text text= "Family:    29 - Founders: 2  - Descendants: 4  - Bits: 6" />
		    <has_text text= "--grid [3.00]" />
		    <not_has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="sibs.chr" />
	    <output name="flow" file="sibs.flow" />
	    <output name="errors" file="sibs.err" />
	</test>
	<test>
	    <!-- This test uses start optional parameter -->
	    <param name="pname" value="assoc.ped"/>
	    <param name="mname" value="assoc.map"/>
	    <param name="dname" value="assoc.dat"/>
	    <param name="start" value="2" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "Estimating allele frequencies... [using all genotypes]" />
		    <has_text text= "--start [2.00]" />
		    <not_has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="assoc.chr" />
	    <output name="flow" file="assoc.flow" />
	    <output name="errors" file="assoc.err" />
	</test>
	<test>
	    <!-- This test uses stop parameter. However when stop is used, the test case fails.-->
	    <param name="pname" value="basic2.ped"/>
	    <param name="mname" value="basic2.map"/>
	    <param name="dname" value="basic2.dat"/>
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "Phenotype: some_disease [ALL] (1 family)" />
		    <has_text text= "Pos   Zmean  pvalue    delta    LOD  pvalue" />
		    <not_has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="basic2.chr" />
	    <output name="flow" file="basic2.flow" />
	    <output name="errors" file="basic2.err" />
	</test>
	<test>
	    <!-- This test uses two optional parameters -->
	    <param name="pname" value="error.ped"/>
	    <param name="mname" value="error.map"/>
	    <param name="dname" value="error.dat"/>
	    <param name="start" value="3" />
	    <param name="markerNames" value="true" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "Family:     2 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:    73 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:    81 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:    94 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:   136 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:   162 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "Family:   164 - Founders: 2  - Descendants: 2  - Bits: 2" />
		    <has_text text= "--start [3.00]" />
		    <has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="error.chr" />
	    <output name="flow" file="error.flow" />
	    <output name="errors" file="error.err" />
	</test>
	<test>
	    <!-- This test uses three optional parameters -->
	    <param name="pname" value="gene.ped"/>
	    <param name="mname" value="gene.map"/>
	    <param name="dname" value="gene.dat"/>
	    <param name="steps" value="3" />
	    <param name="grid" value="2" />
	    <param name="stop" value="4" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "Estimating allele frequencies... [using all genotypes]" />
		    <has_text text= "SNP-1 SNP-2 SNP-3 SNP-4 SNP-5 SNP-6 SNP-7 SNP-8" />
		    <has_text text= "--stop [4.00]" />
		    <has_text text= "--steps [3]" />
		    <has_text text= "--grid [2.00]" />
		    <not_has_text text="--markerNames [ON]" />
		    <not_has_text text="--minStep [2.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="gene.chr" />
	    <output name="flow" file="gene.flow" />
	    <output name="errors" file="gene.err" />
	</test>
	<test>
	    <!-- This test uses all of the optional parameters. -->
	    <param name="pname" value="snp-scan.ped"/>
	    <param name="mname" value="snp-scan.map"/>
	    <param name="dname" value="snp-scan.dat"/>
	    <param name="markerNames" value="true" />
	    <param name="minStep" value="5" />
	    <param name="maxStep" value="6" />
	    <param name="steps" value="2" />
	    <param name="grid" value="4" />
	    <param name="start" value="2" />
	    <param name="stop" value="3" />
	    <output name="merlinoutput">
		<assert_contents>
		    <has_text text= "--markerNames [ON]" />
		    <has_text text= "--minStep [5.00]" />
		    <has_text text= "--maxStep [6.00]" />
		    <has_text text= "--steps [2]" />
		    <has_text text= "--grid [4.00]" />
		    <has_text text= "--start [2.00]" />
		    <has_text text= "--stop [3.00]" />
		</assert_contents>
	    </output>
	    <output name="chromosome" file="snp-scan.chr" />
	    <output name="flow" file="snp-scan.flow" />
	    <output name="errors">
		<assert_contents>
		    <has_text text= "64          5  rs7984335     0.0213"/>
		    <has_text text= "134          3  rs9580624     0.0177"/>
		    <has_text text= "326          5  rs7984335     0.0205" />
		</assert_contents>
	    </output>
	</test>
    </tests>
    <help>
	<![CDATA[
		 MERLIN 1.1.2 - (c) 2000-2007 Goncalo Abecasis

References for this version of Merlin:

Abecasis et al (2002) Nat Gen 30:97-101        [original citation]
Fingerlin et al (2004) AJHG 74:432-43          [case selection for association studies]
Abecasis and Wigginton (2005) AJHG 77:754-67   [ld modeling, parametric analyses]
Fingerlin et al (2006) Gen Epidemiol 30:384-96 [sex-specific maps]
Chen and Abecasis (2007) AJHG 81:913-26        [qtl association analysis, qtl simulation]


The following parameters are in effect:
Data File :      merlin.dat (-dname)
Pedigree File :      merlin.ped (-pname)
Missing Value Code :         -99.999 (-xname)
Map File :      merlin.map (-mname)
Allele Frequencies : ALL INDIVIDUALS (-f[a|e|f|m|file])
Random Seed :          123456 (-r9999)

Data Analysis Options
General : --error, --information, --likelihood, --model [param.tbl]
IBD States : --ibd, --kinship, --matrices, --extended, --select
NPL Linkage : --npl, --pairs, --qtl, --deviates, --exp
VC Linkage : --vc, --useCovariates, --ascertainment, --unlinked [0.00]
Association : --infer, --assoc, --fastAssoc, --filter, --custom [cov.tbl]
Haplotyping : --best, --sample, --all, --founders, --horizontal
Recombination : --zero, --one, --two, --three, --singlepoint
Positions : --steps, --maxStep, --minStep, --grid, --start, --stop
LD Clusters : --clusters [], --distance, --rsq, --cfreq
Limits : --bits [24], --megabytes, --minutes
Performance : --trim, --noCoupleBits, --swap, --smallSwap
Output : --quiet, --markerNames, --frequencies, --perFamily, --pdf,
--tabulate, --prefix [merlin]
Simulation : --simulate, --reruns, --save, --trait []


FATAL ERROR - The datafile merlin.dat cannot be opened
 ]]>

	    
    </help>
    <citations>
    </citations>
</tool>

