<tool id="gdtools_annotate" name="gdtools_annotate" version="0.1.0">

    <description>Annotate a GenomeDiff file</description>

    <requirements>
        <requirement type="package" version="0.34.0">breseq</requirement>
    </requirements>

    <version_command>gdtools --version</version_command>

    <command detect_errors="aggressive">
        <![CDATA[
            #set formats = []
            #if $html:
                $formats.append("html")
            #end if
            #if $gd:
                $formats.append("gd")
            #end if
            #if $tsv:
                $formats.append("tsv")
            #end if
            #if $phylip:
                $formats.append("phylip")
            #end if
            #if $json:
                $formats.append("json")
            #end if
            #if len($formats) == 0:
                $formats.append("html")
            #end if

            #set first = 1
            #for $j, $o in enumerate( $formats ):

                #if $first == 0
                    &&
                #end if
                #set $first = 0

                gdtools ANNOTATE

                --format '$o'

                -o annotated.'$o'

                #if str($reference.source) == "history":
                    #for $i, $ref in enumerate( $reference.own_genome )
                        #if $ref
                            --reference $ref
                        #end if
                    #end for
                #else:
                    #for $i, $ref in enumerate( $reference.fixed_genome )
                        #if $ref
                            --reference $ref.fields.path
                        #end if
                    #end for
                #end if

                #for $i, $s in enumerate( $gds )
                    ${s}
                #end for

                &&

                #if $o == 'html':
                    cp annotated.html '$report'
                #else if $o == 'gd':
                    cp annotated.gd '$genomediff'
                #else if $o == 'tsv':
                    cp annotated.tsv '$tabdelim'
                #else if $o == 'phylip':
                    cp annotated.phylip '$phylipout'
                #else if $o == 'json':
                    cp annotated.json '$jsonout'
                #end if
            #end for
        ]]>
    </command>

    <inputs>
        <conditional name="reference">
            <param name="source" type="select" label="Reference source" >
                <option value="builtin">built-in</option>
                <option value="history">history</option>
            </param>
            <when value="builtin">
                <param name="fixed_genome" type="select" multiple="true" label="Galaxy Built-in Reference(s)">
                    <options from_data_table="genbank_files">
                        <filter type="sort_by" column="2"/>
                        <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                    </options>
                </param>
            </when>
            <when value="history">
                <param name="own_genome" argument="--reference" type="data" format="fasta,genbank" multiple="true" label="Fasta or Genbank Reference(s)" />
            </when>
        </conditional>

        <param name="gds" type="data" format="txt" multiple="true" label="GenomeDiff (gd) Files" help="Files as produced by breseq" />

        <param argument="--format" name="html" type="boolean" checked="true" label="Output an HTML File" help="Note, this tool will run as many times (serially) as the number of output formats selected." />
        <param argument="--format" name="gd" type="boolean" checked="false" label="Output a GenomeDiff File" help="Note, this tool will run as many times (serially) as the number of output formats selected." />
        <param argument="--format" name="tsv" type="boolean" checked="false" label="Output a Tab-delimited File" help="Note, this tool will run as many times (serially) as the number of output formats selected." />
        <param argument="--format" name="phylip" type="boolean" checked="false" label="Output a Phylip File" help="Note, this tool will run as many times (serially) as the number of output formats selected." />
        <param argument="--format" name="json" type="boolean" checked="false" label="Output a Phylip File" help="Note, this tool will run as many times (serially) as the number of output formats selected." />
    </inputs>

    <outputs>
        <data format="html" name="report" label="${tool.name} on ${on_string}: HTML Output">
            <filter>html or (not html and not gd and not tsv and not phylip and not json)</filter>
        </data>
        <data format="txt" name="genomediff" label="${tool.name} on ${on_string}: GenomeDiff Output">
            <filter>gd</filter>
        </data>
        <data format="tabular" name="tabdelim" label="${tool.name} on ${on_string}: Tab-delimited Output">
            <filter>tsv</filter>
        </data>
        <data format="phylip" name="phylipout" label="${tool.name} on ${on_string}: Phylip Output">
            <filter>phylip</filter>
        </data>
        <data format="txt" name="jsonout" label="${tool.name} on ${on_string}: JSON Output">
            <filter>json</filter>
        </data>
    </outputs>

    <tests>
        <test>
            <param name="source" value="history" />
            <param name="own_genome" value="lambda.gbk" />
            <param name="gds" value="gdout.txt" />
            <param name="html" value="false" />
            <param name="gd" value="false" />
            <param name="tsv" value="false" />
            <param name="phylip" value="false" />
            <param name="json" value="false" />

            <output name="report" file="gdtoolsout.html" compare="sim_size" delta="100" />
        </test>
    </tests>
        
    <help>
        <![CDATA[
             Annotate a GenomeDiff file (generated by breseq) with information about mutations (what genes they affect, amino acid substitutions, etc.) If multiple input files are provided, then also COMPARE the frequencies for identical mutations across samples.

**IMPORTANT:** *In order to properly view gdtools_annotate's html output in Galaxy, gdtools_annotate needs to be whitelisted by your galaxy admin.  Otherwise, the results will not be displayed properly.*
        ]]>
    </help>

    <citations>
        <citation type="doi">10.1007/978-1-4939-0554-6_12</citation>
    </citations>

</tool>