<?xml version="1.0"?>

<tool name="codeML" id="codeml" version="1.0">

    <description>
        Detects positive selection.
    </description>   

    <requirements>
        <requirement type="package" version="4.9">paml</requirement>
    </requirements>
    
    <command>
    <![CDATA[       
        python '$__tool_directory__/scripts/comp_codeml.py' $best_tree $concat_nuc $compat_model.brmodel 

        #if str($compat_model.brmodel) != "1" :
            $compat_model.FSsites
        #else
            0
        #end if

        $fix_omega $omega > $log;
    ]]>
    </command>
    
    <inputs>
        <conditional name="compat_model" >
            <param name="brmodel" type="select" label="CodeML branch model" help="for tree file editing in model 2 and 3, see paml manual (chap.3)" >
                <option value="0">'0' : one dN/dS ratio for all branches</option>
                <option value="1">'1' : one dN/dS ratio for each branch ("free-ratio model") ; its use is discouraged</option>
                <option value="2">'2' : arbitrary number of ratios ; implies to manually edit your tree file</option>
                <option value="3">'3' : clade-model ; implies to manually edit your tree file</option>
            </param>
            <!-- Is there a way to do some code factoring with all the lines below ?? -->
            <when value="0" >
                <param name="FSsites" type="select" label="CodeML site model" >
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </param>
            </when>

            <when value="1">
            </when>

            <when value="2" >
                <param name="FSsites" type="select" label="CodeML site model" >
                    <option value="0">0</option>
                    <option value="2">2 (Warning : only two branch type allowed for branch models)</option>
                    <option value="3">3 (Warning : only two branch type allowed for branch models)</option>
                </param>
            </when>

            <when value="3" >
                <param name="FSsites" type="select" label="CodeML site model" >
                    <option value="0">0</option>
                    <option value="2">2 (Warning : only two branch type allowed for branch models)</option>
                    <option value="3">3 (Warning : only two branch type allowed for branch models)</option>
                </param>
            </when>
        </conditional>

        <param name="fix_omega" type="float" label="fix_omega" value="0" help="1 : fixed to the omega value specified below - 0 : estimate"/>
        <param name="omega" type="float" label="omega" value="0.2" help="initial or fixed omega, for codons or codon-based AAs" />
        
        <param name="concat_nuc" type="data" format="fasta" label="Nucleic Fasta concatenation file" help="Your Fasta codon (nucleic) concatenation file from the ConcatPhyl tool" />
        <param name="best_tree" type="data" format="txt" label="BestTree file" help="Your BestTree file from the ConcatPhyl tool (Nucleic or proteic)" />
    </inputs>
    
    <outputs>       
        <data format="txt" name="log" label="CompCodeML_output_log"/>
        <data format="txt" name="2ngdn" label="2NG.dN" from_work_dir="2NG.dN" />
        <data format="txt" name="2ngds" label="2NG.dS" from_work_dir="2NG.dS" />
        <data format="txt" name="2ngt" label="2NG.t" from_work_dir="2NG.t" />
        <data format="txt" name="ctl" label="codeml.ctl" from_work_dir="codeml.ctl" />
        <data format="txt" name="lnf" label="lnf" from_work_dir="lnf" />
        <data format="txt" name="rst" label="rst" from_work_dir="rst" />
        <data format="txt" name="rst1" label="rst1" from_work_dir="rst1" />
        <data format="txt" name="rub" label="rub" from_work_dir="rub" />
        <data format="txt" name="run" label="run_codeml" from_work_dir="run_codeml" />
    </outputs>
    
    <tests>
        <test>
            <conditional name="compat_model" >
                <param name="brmodel" value="0" />
                <param name="FSsites" value="0" />
            </conditional>
            <param name="fix_omega" value="0" />
            <param name="omega" value="0.2" />
            <param name="concat_nuc" ftype="fasta" value="concat.fasta" />
            <param name="best_tree" ftype="txt" value="RAxML_bestTree" />
            <output name="ctl" value="1_codeml.ctl" lines_diff="4"/>
            <output name="2ngdn" value="1_2ngdn" />
            <output name="2ngds" value="1_2ngds" />
            <output name="2ngt" value="1_2ngt" />           
        </test>
        <test>      
            <conditional name="compat_model" >
                <param name="brmodel" value="1" />              
            </conditional>
            <param name="fix_omega" value="0" />
            <param name="omega" value="0.2" />
            <param name="concat_nuc" ftype="fasta" value="concat.fasta" />
            <param name="best_tree" ftype="txt" value="RAxML_bestTree" />
            <output name="ctl" value="2_codeml.ctl" lines_diff="4"/>
            <output name="2ngdn" value="2_2ngdn" />
            <output name="2ngds" value="2_2ngds" />
            <output name="2ngt" value="2_2ngt" />           
        </test>
        <test>      
            <conditional name="compat_model" >
                <param name="brmodel" value="2" />
                <param name="FSsites" value="0" />            
            </conditional>
            <param name="fix_omega" value="0" />
            <param name="omega" value="0.2" />
            <param name="concat_nuc" ftype="fasta" value="concat.fasta" />
            <param name="best_tree" ftype="txt" value="tree_model2" />
            <output name="ctl" value="3_codeml.ctl" lines_diff="4"/>
            <output name="2ngdn" value="3_2ngdn" />
            <output name="2ngds" value="3_2ngds" />
            <output name="2ngt" value="3_2ngt" />           
        </test>
        <test>
            <conditional name="compat_model" >
                <param name="brmodel" value="0" />
                <param name="FSsites" value="2" />
            </conditional>
            <param name="fix_omega" value="1" />
            <param name="omega" value="1" />
            <param name="concat_nuc" ftype="fasta" value="concat.fasta" />
            <param name="best_tree" ftype="txt" value="RAxML_bestTree" />
            <output name="ctl" value="4_codeml.ctl" lines_diff="4"/>
            <output name="2ngdn" value="4_2ngdn" />
            <output name="2ngds" value="4_2ngds" />
            <output name="2ngt" value="4_2ngt" />           
        </test>
        <test>
            <conditional name="compat_model" >
                <param name="brmodel" value="3" />
                <param name="FSsites" value="2" />
            </conditional>
            <param name="fix_omega" value="0" />
            <param name="omega" value="0.2" />
            <param name="concat_nuc" ftype="fasta" value="concat.fasta" />
            <param name="best_tree" ftype="txt" value="tree_model3" />
            <output name="ctl" value="5_codeml.ctl" lines_diff="4"/>
            <output name="2ngdn" value="5_2ngdn" />
            <output name="2ngds" value="5_2ngds" />
            <output name="2ngt" value="5_2ngt" />           
        </test>
    </tests>
    
    <help>

.. class:: infomark

**Galaxy integration** Victor Mataigne and ABIMS TEAM

 | Contact support.abims@sb-roscoff.fr for any questions or concerns about the Galaxy implementation of this tool.

---------------------------------------------------

==========
CompCodeML
==========

|Â Full and detailed codeml readme in the paml manual (see citation).

-----------
Description
-----------

| codeML finds positive selection within branches or codons within a tree and a set of sequences.
| It takes as inputs a treefile in Newick format and a fasta file with sequences from the species of the tree file (one header/sequence per species) and run codeml (from the paml suite).
|
| Several models are available (not all are compatible).
|
| Basically, this tool write a configfile called codeml.ctl with the specified parameters and then launches codeml.

----------
Parameters
----------

| Branch model :
| Site model :
| fix_omega : choose "0" to have omega estimated along the run ; choose "1" to set a fixed omega value for the whole run.
| omega : if fix_omega = 0, this parameter is the initial value of omega; if fix_omega = 1, it is the omega value for the whole run.
| More parameters coming soon.

    </help>

    <citations>
        <citation type="bibtex">http://abacus.gene.ucl.ac.uk/software/paml.html</citation>
    </citations>
</tool>
