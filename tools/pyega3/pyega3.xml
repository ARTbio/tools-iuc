<tool id="pyega3" name="EGA Download Client" version="@VERSION@+galaxy0" python_template_version="3.5">
    <macros>
        <token name="@VERSION@">3.1.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@VERSION@">pyega3</requirement>
    </requirements>
    <configfiles>
        <configfile name="credentials"><![CDATA[
#set $password = $__user__.extra_preferences.get('ega_account|password', "")
#set $username = $__user__.extra_preferences.get('ega_account|username', "")
#if $username == "" or $password == "":
   #set $username = "ega-test-data@ebi.ac.uk"
   #set $password = "egarocks"
#end if
{
    "username": "$username",
    "password": "$password"
}
        ]]></configfile>
    </configfiles>
    <command detect_errors="exit_code"><![CDATA[
        #set $username = $__user__.extra_preferences.get('ega_account|username', "")
        #if $username == "":
            #set $username = "ega-test-data@ebi.ac.uk (default user)"
        #end if
        echo "Running as user: $username. Set your credentials via: User -> Preferences -> Manage Information"  &&

        #if $action.action_type == "list_datasets"
            pyega3 -cf '$credentials' datasets > '$authorized_datasets'
        #elif $action.action_type == "list_dataset_files"
            pyega3 -cf '$credentials' files '$action.dataset_id' > '$dataset_file_list'
        #elif $action.action_type == "download"
            echo "downloading"
        #end if

    ]]></command>
    <inputs>
        <conditional name="action">
            <param name="action_type" type="select" label="What would you like to do?">
                <option value="list_datasets"> List my authorized datasets </option>
                <option value="list_dataset_files"> List files in a datasets </option>
                <option value="download"> Download datasets </option>
            </param>
            <when value="list_dataset_files">
                <param name="dataset_id" type="text" optional="false" label="EGA identifier" help="For example: EGAD00001003338"/>
            </when>
            <when value="list_datasets"/>
            <when value="download"/>
        </conditional>
    </inputs>
    <outputs>
        <data name="authorized_datasets" format="txt" label="${tool.name}: authorized datasets">
            <filter> action['action_type'] == 'list_datasets' </filter>
        </data>
        <data name="dataset_file_list" format="txt" label="${tool.name}: dataset file list">
            <filter> action['action_type'] == 'list_dataset_files' </filter>
        </data>
    </outputs>
    <tests>
        <test><!-- list datasets with default credentials -->
            <param name="action_type" value="list_datasets"/>
            <output name="authorized_datasets" ftype="txt">
                <assert_contents>
                    <has_text text="pyEGA3 - EGA python client version @VERSION@"/>
                    <has_text text="EGAD00001003338"/>
                </assert_contents>
            </output>
        </test>
        <test><!-- list dataset files with default credentials -->
            <param name="action_type" value="list_dataset_files"/>
            <param name="dataset_id" value="EGAD00001003338"/>
            <output name="dataset_file_list" ftype="txt">
                <assert_contents>
                    <has_text text="pyEGA3 - EGA python client version @VERSION@"/>
                    <has_line_matching expression="^File ID\s+Status\s+Bytes\s+Check sum\s+File name$"/>
                    <has_text text="EGAF00001753734"/>
                </assert_contents>
            </output>
        </test>

    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>
