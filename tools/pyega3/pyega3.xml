<tool id="pyega3" name="EGA Download Client" version="@VERSION@+galaxy0" python_template_version="3.5">
    <macros>
        <token name="@VERSION@">3.1.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@VERSION@">pyega3</requirement>
    </requirements>
    <configfiles>
        <configfile name="credentials"><![CDATA[
#set $password = $__user__.extra_preferences.get('ega_account|password', "")
#set $username = $__user__.extra_preferences.get('ega_account|username', "")
#if $username == "" or $password == "":
   #set $username = "ega-test-data@ebi.ac.uk"
   #set $password = "egarocks"
#end if
{
    "username": "$username",
    "password": "$password"
}
        ]]></configfile>
    </configfiles>
    <command detect_errors="exit_code"><![CDATA[
        #set $username = $__user__.extra_preferences.get('ega_account|username', "")
        #if $username == "":
            #set $username = "ega-test-data@ebi.ac.uk (default user)"
        #end if
        echo "Running as user: $username. Set your credentials via: User -> Preferences -> Manage Information"  &&

        #if $action.action_type == "list_datasets"
            pyega3 -cf '$credentials' datasets > '$authorized_datasets'
        #elif $action.action_type == "list_dataset_files"
            pyega3 -cf '$credentials' files '$action.dataset_id' > '$dataset_file_list'
        #elif $action.action_type == "download_file"
            pyega3 -cf '$credentials' fetch '$action.file_id' --saveto '$downloaded_file'
        #end if

    ]]></command>
    <inputs>
        <conditional name="action">
            <param name="action_type" type="select" label="What would you like to do?">
                <option value="list_datasets"> List my authorized datasets </option>
                <option value="list_dataset_files"> List files in a datasets </option>
                <option value="download_file"> Download a single file </option>
            </param>
            <when value="list_dataset_files">
                <param name="dataset_id" type="text" optional="false" label="EGA Dataset Accession ID" help="Identifier starting with 'EGAD'. For example: EGAD00001003338">
                    <validator type="regex" message="EGA dataset ID must be a string of numbers prefixed by 'EGAD'">EGAD[0-9]+</validator>
                </param>
            </when>
            <when value="list_datasets"/>
            <when value="download_file">
                <param name="file_id" type="text" optional="false" label="EGA File Accession Identifier" help="Identifier starting with 'EGAF'. For example: EGAF00001753735">
                     <validator type="regex" message="EGA Accession ID must be a string of numbers prefixed by 'EGAD' (datasets) or 'EGAF' (files)">EGAF[0-9]+</validator>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="authorized_datasets" format="txt" label="${tool.name}: authorized datasets">
            <filter> action['action_type'] == 'list_datasets' </filter>
        </data>
        <data name="dataset_file_list" format="txt" label="${tool.name}: dataset file list">
            <filter> action['action_type'] == 'list_dataset_files' </filter>
        </data>
        <data name="downloaded_file" format="auto" label="${tool.name}: ${action.file_id}">
            <filter> action['action_type'] == 'download_file' </filter>
        </data>
    </outputs>
    <tests>
        <test><!-- list datasets with default credentials -->
            <param name="action_type" value="list_datasets"/>
            <output name="authorized_datasets" ftype="txt">
                <assert_contents>
                    <has_text text="pyEGA3 - EGA python client version @VERSION@"/>
                    <has_text text="EGAD00001003338"/>
                </assert_contents>
            </output>
        </test>
        <test><!-- list dataset files with default credentials -->
            <param name="action_type" value="list_dataset_files"/>
            <param name="dataset_id" value="EGAD00001003338"/>
            <output name="dataset_file_list" ftype="txt">
                <assert_contents>
                    <has_text text="pyEGA3 - EGA python client version @VERSION@"/>
                    <has_line_matching expression="^File ID\s+Status\s+Bytes\s+Check sum\s+File name$"/>
                    <has_text text="EGAF00001753734"/>
                </assert_contents>
            </output>
        </test>
        <test> <!-- download a single file -->
            <param name="action_type" value="download_file"/>
            <param name="file_id" value="EGAF00001775036"/>
            <output name="downloaded_file" md5="3b89b96387db5199fef6ba613f70e27c"/>
        </test>
    </tests>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>
