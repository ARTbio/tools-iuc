<tool id="sniffles" name="sniffles" version="1.0.12+galaxy0">
  <description>Structural variation caller using third generation sequencing</description>
  <requirements>
    <requirement type="package" version="1.0.12">sniffles</requirement>
  </requirements>
  <command detect_errors="exit_code">
    <![CDATA[
ln -f -s '$input' input.bam &&
sniffles
-t \${GALAXY_SLOTS:-2}
-m 'input.bam'
-v '$output'
## general_options
#if $general_options.min_support:
    --min_support $general_options.min_support
#end if
#if $general_options.max_num_splits:
    --max_num_splits $general_options.max_num_splits
#end if
#if $general_options.max_distance:
    --max_distance $general_options.max_distance
#end if
#if $general_options.min_length:
    --min_length $general_options.min_length
#end if
#if $general_options.minmapping_qual:
    --minmapping_qual $general_options.minmapping_qual
#end if
#if $general_options.num_reads_report:
    --num_reads_report $general_options.num_reads_report
#end if
#if $general_options.min_seq_size:
    --min_seq_size $general_options.min_seq_size
#end if
#if $general_options.min_zmw:
    --min_zmw $general_options.min_zmw
#end if
#if $general_options.cs_string:
    --cs_string
#end if
## clustering_options
#if $clustering_options.cluster:
    --cluster
#end if
#if $clustering_options.cluster_support:
    --cluster_support $clustering_options.cluster_support
#end if
#if $clustering_options.allelefreq:
    --allelefreq $clustering_options.allelefreq
#end if
#if $clustering_options.min_homo_af:
    --min_homo_af $clustering_options.min_homo_af
#end if
#if $clustering_options.min_het_af:
    --min_het_af $clustering_options.min_het_af
#end if
##advanced_options
#if $advanced_options.report_BND:
    --report_BND
#end if
#if $advanced_options.not_report_seq:
    --not_report_seq
#end if
#if $advanced_options.ignore_sd:
    --ignore_sd
#end if
#if $advanced_options.ccs_reads:
    --ccs_reads
#end if
## parameter_estimation_options

    ]]>
  </command>
  <inputs>
    <param type="data" name="input" format="bam" label="Input BAM file"/>
    <section name="general_options" title="Set general options" expanded="False">
      <param argument="--min_support" type="integer" value="" optional="true" label="Minimum number of reads that support a SV. [10]"/>
      <param argument="--max_num_splits" type="integer" value="" optional="true" label="Maximum number of splits per read to be still taken into account. [7]"/>
      <param argument="--max_distance" type="integer" value="" optional="true" label="Maximum distance to group SV together. [1000]"/>
      <param argument="--min_length" type="integer" value="" optional="true" label="Minimum length of SV to be reported. [30]"/>
      <param argument="--minmapping_qual" type="integer" value="" optional="true" label="Minimum Mapping Quality. [20]"/>
      <param argument="--num_reads_report" type="integer" value="" optional="true" label="Report up to N reads that support the SV in the vcf file. -1: report all. [0]"/>
      <param argument="--min_seq_size" type="integer" value="" optional="true" label="Discard read if non of its segment is larger then this. [2000]"/>
      <param argument="--min_zmw" type="integer" value="" optional="true" label="Discard SV that are not supported by at least x zmws. This applies only for PacBio recognizable reads. [0]"/>
      <param argument="--cs_string" type="boolean" value="" optional="true" label="Enables the scan of CS string instead of Cigar and MD.  [false]"/>
    </section>
    <section name="clustering_options" title="Clustering/phasing and genotyping options" expanded="False">
        <param argument="--cluster" type="boolean" value="" optional="true" label="Enables Sniffles to phase SVs that occur on the same reads [false]"/>
        <param argument="--cluster_support" type="integer" optional="true" label="Minimum number of reads supporting clustering of SV. [1]"/>
        <param argument="--allelefreq" type="float" optional="true" label="Threshold on allele frequency (0-1).  [0]"/>
        <param argument="--min_homo_af" type="float" optional="true" label="Minimum homogeneous threshold on allele frequency (0-1).  [0.8]"/>
        <param argument="--min_het_af" type="float" optional="true" label="Minimum heterogeneous threshold on allele frequency (0-1).  [0.3]"/>
    </section>
    <section name="advanced_options" title="Advanced options" expanded="False">
        <param argument="--report_BND" type="boolean" value="" optional="true" label="Report BND instead of Tra in vcf output.  [true]"/>
        <param argument="--not_report_seq" type="boolean" value="" optional="true" label="Dont report sequences for indels in vcf output. (Beta version!)  [false]"/>
        <param argument="--ignore_sd" type="boolean" value="" optional="true" label="Ignores the sd based filtering.  [false]"/>
        <param argument="--ccs_reads" type="boolean" value="" optional="true" label="Preset CCS Pacbio setting. (Beta)  [false]"/>
    </section>
    <section name="parameter_estimation_options" title="Parameter Estimation Options" expanded="False">
        <param argument="--skip_parameter_estimation" type="boolean" value="" optional="true" label="Enables the scan if only very few reads are present.  [false]"/>
        <param argument="--del_ratio" type="float" value="" optional="true" label="Estimated ratio of deletions per read (0-1).  [0.0458369]"/>
        <param argument="--ins_ratio" type="float" value="" optional="true" label="Estimated ratio of insertions per read (0-1).  [0.049379]"/>
        <param argument="--max_diff_per_window" type="integer" value="" optional="true" label="Maximum differences per 100bp. [50]"/>
        <param argument="--max_dist_aln_events" type="integer" value="" optional="true" label="Maximum distance between alignment (indel) events. [4]"/>
    </section>
  </inputs>
  <outputs>
    <data name="output" format="vcf" label="${tool.name} on ${on_string} (${output_format} format)">
      <change_format>
        <when input="output_format" value="bedpe" format="tabular"/>
      </change_format>
    </data>
  </outputs>
  <tests>
    <test> <!-- test 1 - standard run -->
      <param name="input" value="reads_region.bam"/>
      <param name="output_format" value="vcf"/>
      <output name="output" file="expected_output.vcf" lines_diff="2"/>
    </test>
    <test> <!-- test 2 - add reads into report -->
        <param name="input" value="reads_region.bam"/>
        <param name="output_format" value="vcf"/>
        <param name="num_reads_report" value="-1"/>
        <output name="output" file="expected_output2.vcf" lines_diff="2"/>
    </test>
    <test> <!-- test 3 - use cs_string -->
        <param name="input" value="reads_region.bam"/>
        <param name="output_format" value="vcf"/>
        <param name="cs_string" value="true"/>
        <output name="output" file="expected_outcome3.vcf" lines_diff="2"/>
    </test>
    <test> <!-- test 4 - clustering -->
        <param name="input" value="reads_region.bam"/>
        <param name="output_format" value="vcf"/>
        <param name="cluster" value="True"/>
        <output name="output" file="expected_outcome4.vcf" lines_diff="2"/>
    </test>
    <test> <!-- test 5 - Advanced - Report BND -->
        <param name="input" value="reads_region.bam"/>
        <param name="output_format" value="vcf"/>
        <param name="report_BND" value="True"/>
        <output name="output" file="expected_outcome5.vcf" lines_diff="2"/>
    </test>
    <test> <!-- test 6 - Parameter Estimation - skip -->
        <param name="input" value="reads_region.bam"/>
        <param name="output_format" value="vcf"/>
        <param name="skip_parameter_estimation" value="True"/>
        <output name="output" file="expected_outcome6.vcf" lines_diff="2"/>
    </test>
  </tests>
  <help>
    <![CDATA[
Usage: sniffles [options] -m <sorted.bam> -v <output.vcf>

Input/Output:
    -m <string>,  --mapped_reads <string>
        (required)  Sorted bam File
    -v <string>,  --vcf <string>
        VCF output file name []
    -b <string>,  --bedpe <string>
         bedpe output file name []
    \--Ivcf <string>
        Input VCF file name. Enable force calling []
    \--tmp_file <string>
        path to temporary file otherwise Sniffles will use the current directory. []

General:
    -s <int>,  --min_support <int>
        Minimum number of reads that support a SV. [10]
    \--max_num_splits <int>
        Maximum number of splits per read to be still taken into account. [7]
    -d <int>,  --max_distance <int>
        Maximum distance to group SV together. [1000]
    -t <int>,  --threads <int>
        Number of threads to use. [3]
    -l <int>,  --min_length <int>
        Minimum length of SV to be reported. [30]
    -q <int>,  --minmapping_qual <int>
        Minimum Mapping Quality. [20]
    -n <int>,  --num_reads_report <int>
        Report up to N reads that support the SV in the vcf file. -1: report all. [0]
    -r <int>,  --min_seq_size <int>
        Discard read if non of its segment is larger then this. [2000]
    -z <int>,  --min_zmw <int>
        Discard SV that are not supported by at least x zmws. This applies only for PacBio recognizable reads. [0]
    \--cs_string
        Enables the scan of CS string instead of Cigar and MD.  [false]

Clustering/phasing and genotyping:
    \--genotype
        Enables Sniffles to compute the genotypes. [false]
    \--cluster
        Enables Sniffles to phase SVs that occur on the same reads [false]
    \--cluster_support <int>
        Minimum number of reads supporting clustering of SV. [1]
    -f <float>,  --allelefreq <float>
        Threshold on allele frequency (0-1).  [0]
    \--min_homo_af <float>
        Threshold on allele frequency (0-1).  [0.8]
    \--min_het_af <float>
        Threshold on allele frequency (0-1).  [0.3]

Advanced:
    \--report_BND
        Dont report BND instead use Tra in vcf output.  [true]
    \--report_seq
        Report sequences for indels in vcf output. (Beta version!)  [false]
    \--ignore_sd
        Ignores the sd based filtering.  [false]
    \--report_read_strands
        Enables the report of the strand categories per read. (Beta)  [false]
    \--ccs_reads
        Preset CCS Pacbio setting. (Beta)  [false]

Parameter estimation:
    \--skip_parameter_estimation
        Enables the scan if only very few reads are present.  [false]
    \--del_ratio <float>
        Estimated ration of deletions per read (0-1).  [0.0458369]
    \--ins_ratio <float>
        Estimated ratio of insertions per read (0-1).  [0.049379]
    \--max_diff_per_window <int>
        Maximum differences per 100bp. [50]
    \--max_dist_aln_events <int>
        Maximum distance between alignment (indel) events. [4]
    ]]>
  </help>
    <citations>
        <citation type="doi">10.1038/s41592-018-0001-7</citation>
    </citations>
</tool>