<tool id="pureclip" name="PureCLIP" version="1.0.4">
    <requirements>
        <requirement type="package" version="1.0.4">pureclip</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
pureclip
    -o crosslink_sites.bed
    -or binding_regions.bed
    -p learned_parameters.txt
    -i '$input_bam'
    -bai '$input_bai'
    -g '$input_genome'
    #if $learn_params_contigs
        -iv '$learn_params_contigs'
    #end if
    #if $apply_hmm_contigs
        -iv '$apply_hmm_contigs'
    #end if
    -dm $merge_dist
    -bc 0
    #if str( $control_data.control_data_selector ) == 'Supply_control_data':
        -ibam '$control_data.control_bam_file'
        -ibai '$control_data.control_bai_file'
    #end if

    #if str( $motif_data.motif_data_selector ) == 'Supply_CL_motifs':
        -fis '$motif_data.cl_motif_bed_file'
        -nim $motif_data.max_motif_id
    #end if

    ]]></command>
    <inputs>
        <param name="target_bam_file" type="data" format="bam" label="Target BAM file" argument="-i"/>
        <param name="target_bai_file" type="data" format="bai" label="Target BAM index file" argument="-bai"
            help="Target BAM index file created e.g. with \"samtools index\" target.bam"/>
        <param name="input_genome" type="data" format="fasta" label="Genome reference file" argument="-g"/>
        <!-- Options -->
        <param name="learn_params_contigs" type="data" format="txt" optional="True"
               label="Genomic chromosomes to learn HMM parameters" argument="-iv" 
               help="Genomic chromosomes to learn HMM parameters, e.g. 'chr1;chr2;chr3'. Contigs have to be in the same order as in BAM file. Useful to reduce runtime and memory consumption. Default: all contigs from reference file are used (useful when applying to transcript-wise alignments or poor data)."/>
        <param name="apply_hmm_contigs" type="data" format="txt" label="Contigs to apply HMM" argument="-chr" optional="True"
               help="Contigs to apply HMM, e.g. 'chr1;chr2;chr3;'. Contigs have to be in the same order as in BAM file."/>
        <param name="merge_dist" type="integer" value="8" min="1"
               label="Distance used to merge individual crosslink sites to binding regions" argument="-dm"/>

        <conditional name="control_data">
            <param name="control_data_selector" type="select" label="Control data options">
                <option value="No_control_available" selected="true">No control available</option>
                <option value="Supply_control_data">Supply control data</option>
            </param>
            <when value="No_control_available" />
            <when value="Supply_control_data">
                <param name="control_bam_file" type="data" format="bam"
                       label="BAM file containing mapped reads from control experiment" argument="-ibam"
                       help="Mapped reads in BAM format from a control experiment, e.g. eCLIP input"/>
                <param name="control_bai_file" type="data" format="bai" label="BAI (BAM index) file for control experiment" argument="-ibai"
                       help="File containing BAM index corresponding to mapped reads from control experiment"/>
            </when>
        </conditional>
        <conditional name="motif_data">
            <param name="motif_data_selector" type="select" label="Crosslink-associated (CL) motif options">
                <option value="No_CL_motifs_available" selected="true">No CL motifs available</option>
                <option value="Supply_CL_motifs">Supply CL motifs</option>
            </param>
            <when value="No_CL_motifs_available" />
            <when value="Supply_CL_motifs">
                <param name="cl_motif_bed_file" type="data" format="bed"
                       label="FIMO input motif score covariates file" argument="-fis"
                       help="FIMO input motif score covariates file"/>
                <param name="max_motif_id" type="integer" value="1"
                       label="Max. motif ID to use" argument="-nim"
                       help="Max. motif ID to use (Default: only covariates with motif ID 1 are used)"/>
            </when>
        </conditional>

        <conditional name="bc_data">
            <param name="bc_data_selector" type="select" label="Protein binding characteristics mode">
                <option value="mode_0" selected="true">Mode 0 (-bc 0)</option>
                <option value="mode_1">Mode 1 (-bc 1)</option>
                <option value="custom_mode">Custom mode</option>
            </param>
            <when value="mode_0">
                <param name="bc_mode" type="integer" value="0"
                       label="Max. motif ID to use" argument="-nim"
                       help="Max. motif ID to use (Default: only covariates with motif ID 1 are used)"/>
            </when>
            <when value="Supply CL motifs">
                <param name="cl_motif_bed_file" type="data" format="bed"
                       label="FIMO input motif score covariates file" argument="-fis"
                       help="FIMO input motif score covariates file"/>
                <param name="max_motif_id" type="integer" value="1"
                       label="Max. motif ID to use" argument="-nim"
                       help="Max. motif ID to use (Default: only covariates with motif ID 1 are used)"/>
            </when>
        </conditional>


<!--
    -bc, --bc NUM
          Flag to set parameters according to binding characteristics of
          protein: see description in section below. In range [0..1].
  Options for incorporating covariates:
    -is, --is FILE
          Covariates file: position-wise values, e.g. smoothed reads start
          counts (KDEs) from input data. Valid filetype is: .bed.
          
chrM:4000-8300.binding_regions.bed
chrM:4000-8300.crosslink_sites.bed.stats
chrM:4000-8300.crosslink_sites.bed


pureclip -i aligned.prepro.R2.chrM:4000-8300.bam -bai aligned.prepro.R2.chrM:4000-8300.bam.bai -g chrM.fa -nt 2 -o chrM:4000-8300.crosslink_sites.bed -or chrM:4000-8300.binding_regions.bed -p learned_parameters.txt

pureclip  -i aligned.prepro.R2.chrM:4000-8300.bam -bai aligned.prepro.R2.chrM:4000-8300.bam.bai -g chrM.fa -nt 2 -o chrM:4000-8300.crosslink_sites.cov_input_signal.bed -or chrM:4000-8300.binding_regions.cov_input_signal.bed -ibam input.aligned.prepro.R2.chrM:4000-8300.bam -ibai input.aligned.prepro.R2.chrM:4000-8300.bam.bai

--> 

<!--
3 settings:
-bc 0
-bc 1
Define yourself advanced user options:
-bdwn -ntp -ntp2 -b1p -b2p -antp
        <param name="bc_flag" type="integer" optional="True"
               label="minimum width of core motif" argument="-bc" value="0" min="0" max="1"
               help="Flag to set parameters according to binding characteristics of
          protein"/>

PARAMETER SETTINGS FOR PROTEINS WITH DIFFERENT BINDING CHARACTERISTICS
    By default, the parameters are set to values optimized for proteins
    binding to short defined binding regions, e.g. proteins binding to short
    specific motifs such as PUM2 and RBFOX2. With the -bc option this
    behaviour can be changed:

    0
          Short defined. Default. Equivalent to: -bdwn 50 -ntp 10 -ntp2 0 -b1p
          0.01 -b2p 0.15.
    1
          Larger clusters. Proteins causing larger crosslink clusters with
          relatively lower read start counts, e.g. proteins binding to low
          complexity motifs. Equivalent to: -bdwn 100 -antp -b2p 0.01 -b2p
          0.1.

    -bc, --bc NUM
          Flag to set parameters according to binding characteristics of
          protein: see description in section below. In range [0..1].
    -bw, --bdw NUM
          Bandwidth for kernel density estimation used to access enrichment.
          NOTE: Increasing the bandwidth increases runtime and memory
          consumption. Default: 50. In range [1..500].
    -bwn, --bdwn NUM
          Bandwidth for kernel density estimation used to estimate n for
          binomial distributions. For proteins that are rather sliding along
          the RNA or showing long crosslink clusters this should be increased,
          e.g. to 100 (should be <= 4*bdw). Default: same as bdw. In range
          [1..500].

    -ld, --ld
          Use higher precision to compute emission probabilities etc. (i.e.
          long double). Useful in cases of extreme outliers, e.g. extreme high
          read start counts whose emission probabilities are close to zero and
          which would be discarded in default setting (along with warning
          messages). Note: increases memory consumption. Use in combination
          with '-iv'. Default: double.
-->
        <!-- Options for incorporating covariates -->
        
        <!-- Advanced user options -->
        
    </inputs>
    <outputs>
        <data format="bed" name="crosslink_bed_outfile" label="${tool.name} on ${on_string} crosslink sites (bed)" from_work_dir="crosslink_sites.bed"/>
        <data format="bed" name="binding_region_bed_outfile" label="${tool.name} on ${on_string} binding regions (bed)" from_work_dir="binding_regions.bed"/>
        <data format="txt" name="learned_params_outfile" label="${tool.name} on ${on_string} learned parameters (txt)" from_work_dir="learned_parameters.txt"/>
    </outputs>
    <help><![CDATA[
    Protein-RNA interaction site detection using a non-homogeneous HMM.
    ]]></help>
</tool>

