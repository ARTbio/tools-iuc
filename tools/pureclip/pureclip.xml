<tool id="pureclip" name="PureCLIP" version="1.0.4">
    <requirements>
        <requirement type="package" version="1.0.4">pureclip</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
pureclip
    -o crosslink_sites.bed
    -or binding_regions.bed
    -i '$input_bam'
    -bai '$input_bai'
    -g '$genome_fasta_file'
    #if $learn_params_contigs
        -iv '$learn_params_contigs'
    #end if
    #if $apply_hmm_contigs
        -iv '$apply_hmm_contigs'
    #end if
    -dm $merge_dist
    -bc 0
    #if str( $control_data.control_data_selector ) == 'supply_control_data':
        -ibam '$control_data.control_bam_file'
        -ibai '$control_data.control_bai_file'
    #end if

    #if str( $motif_data.motif_data_selector ) == 'supply_CL_motifs':
        -fis '$motif_data.cl_motif_bed_file'
        -nim $motif_data.max_motif_id
    #end if

    #if str( $bc_data.bc_data_selector ) == 'bc_0':
        -bc 0
    #elif str( $bc_data.bc_data_selector ) == 'bc_1':
        -bc 1
    #elif str( $bc_data.bc_data_selector ) == 'manual_setting':
        
antp selector


    #end if






    ]]></command>
    <inputs>
        <param name="target_bam_file" type="data" format="bam" label="Target BAM file" argument="-i"/>
        <param name="target_bai_file" type="data" format="bai" label="Target BAM index file" argument="-bai"
            help="Target BAM index file created e.g. with \"samtools index\" target.bam"/>
        <param name="genome_fasta_file" type="data" format="fasta" label="Genome reference file" argument="-g"/>
        <!-- Options -->
        <param name="learn_params_contigs" type="data" format="txt" optional="True"
               label="Genomic chromosomes to learn HMM parameters" argument="-iv" 
               help="Genomic chromosomes to learn HMM parameters, e.g. 'chr1;chr2;chr3'. Contigs have to be in the same order as in BAM file. Useful to reduce runtime and memory consumption. Default: all contigs from reference file are used (useful when applying to transcript-wise alignments or poor data)."/>
        <param name="apply_hmm_contigs" type="data" format="txt" label="Contigs to apply HMM" argument="-chr" optional="True"
               help="Contigs to apply HMM, e.g. 'chr1;chr2;chr3;'. Contigs have to be in the same order as in BAM file."/>
        <param name="merge_dist" type="integer" value="8" min="1"
               label="Distance used to merge individual crosslink sites to binding regions" argument="-dm"/>

        <conditional name="control_data">
            <param name="control_data_selector" type="select" label="Control data options">
                <option value="no_control_available" selected="true">No control available</option>
                <option value="supply_control_data">Supply control data</option>
            </param>
            <when value="no_control_available" />
            <when value="supply_control_data">
                <param name="control_bam_file" type="data" format="bam"
                       label="BAM file containing mapped reads from control experiment" argument="-ibam"
                       help="Mapped reads in BAM format from a control experiment, e.g. eCLIP input"/>
                <param name="control_bai_file" type="data" format="bai" label="BAI (BAM index) file for control experiment" argument="-ibai"
                       help="File containing BAM index corresponding to mapped reads from control experiment"/>
            </when>
        </conditional>
        <conditional name="motif_data">
            <param name="motif_data_selector" type="select" label="Crosslink-associated (CL) motif options">
                <option value="no_CL_motifs_available" selected="true">No CL motifs available</option>
                <option value="supply_CL_motifs">Supply CL motifs</option>
            </param>
            <when value="no_CL_motifs_available" />
            <when value="supply_CL_motifs">
                <param name="cl_motif_bed_file" type="data" format="bed"
                       label="FIMO input motif score covariates file" argument="-fis"
                       help="FIMO input motif score covariates file"/>
                <param name="max_motif_id" type="integer" value="1"
                       label="Max. motif ID to use" argument="-nim"
                       help="Max. motif ID to use (Default: only covariates with motif ID 1 are used)"/>
            </when>
        </conditional>

        <conditional name="bc_data">
            <param name="bc_data_selector" type="select" label="Define protein binding characteristics">
                <option value="bc_0" selected="true">RBP with short defined binding regions (-bc 0)</option>
                <option value="bc_1">RBP with larger crosslink clusters and lower read start counts (-bc 1)</option>
                <option value="manual_setting">Manual setting</option>
            </param>
            <when value="bc_0" />
            <when value="bc_1" />
            <when value="manual_setting">
                <param name="bandwidth" type="integer" value="50" min="1" max="500"
                       label="Bandwidth for kernel density estimation used to access enrichment" argument="-bw"
                       help="NOTE: Increasing the bandwidth increases runtime and memory consumption"/>
                <param name="bandwidthn" type="integer" value="50" min="1" max="500"
                       label="Bandwidth for kernel density estimation used to estimate n for binomial distributions" argument="-bwn"
                       help="For proteins that rather slide along the RNA or show long crosslink clusters increase -bwn, e.g. to 100 (should be <= 4*bw)"/>
                <param name="b1p_value" type="float" value="0.01"
                       label="Initial value for binomial probability parameter of 'non-crosslink' state" argument="-b1p"/>
                <param name="b2p_value" type="float" value="0.15"
                       label="Initial value for binomial probability parameter of 'crosslink' state" argument="-b2p"/>
                <conditional name="antp_option">
                    <param name="antp_option_selector" type="select" label="Choose n threshold for estimating crosslink state parameters" help="Either automatically choose n threshold (-ntp, -ntp2) to estimate parameters linked to crosslink states based on expected read start count at crosslink sites, or manually set values">
                        <option value="antp_select" selected="true">Automatically choose n threshold (-ntp, -ntp2)</option>
                        <option value="manual_select">Manually set -ntp, -ntp2</option>
                    </param>
                    <when value="antp_select" />
                    <when value="manual_select">
                        <param name="ntp_value" type="integer" value="10" argument="-ntp"
                               label="Only sites with n >= ntp are used to learn binomial probability parameters"/>
                        <param name="ntp2_value" type="integer" value="0" argument="-ntp2"
                               label="Only sites with n >= ntp2 are used to learn probability of transition from state '2' to '2' or '3'"
                               help="Useful for data with low truncation rates at crosslink sites or in general high fraction of non-coinciding read starts"/>
                    </when>
            </when>
        </conditional>
        <conditional name="advanced_params">
            <param name="advanced_params_selector" type="select" label="Additional advanced parameters">
                <option value="ap_not_specify" selected="true">Do not specify</option>
                <option value="ap_specify">Manually specify</option>
            </param>
            <when value="ap_not_specify" />
            <when value="ap_specify">
                <param name="ld_precision" label="Use higher precision to compute emission probabilities (long double)" type="boolean"
                       truevalue="-ld" falsevalue="" checked="False"
                       help="Useful in cases of extreme outliers, e.g. extreme high read start counts whose emission probabilities are close to zero and which would be discarded in default setting (along with warning messages). Note: increases memory consumption. Use in combination with '-iv' (default: double)"/>
                <param name="use_viterbi" label="Use Viterbi instead of posterior decoding" 
                       type="boolean" truevalue="-vtb" falsevalue="" checked="False"/>
                <param name="max_iter_brent" type="integer" optional="True" min="1" max="1000"
                       label="Maximum number of iterations within BRENT algorithm" argument="-m"/>
                <param name="max_iter_bw" type="integer" optional="True" min="0" max="500"
                       label="Maximum number of iterations within Baum-Welch algorithm" argument="-w"/>
                <param name="g1kmin_value" type="float" optional="True"
                       label="Minimum shape k of 'non-enriched' gamma distribution" argument="-g1kmin"/>
                <param name="g1kmax_value" type="float" optional="True"
                       label="Maximum shape k of 'non-enriched' gamma distribution" argument="-g1kmax"/>
                <param name="g2kmin_value" type="float" optional="True"
                       label="Minimum shape k of 'enriched' gamma distribution" argument="-g2kmin"/>
                <param name="g2kmax_value" type="float" optional="True"
                       label="Maximum shape k of 'enriched' gamma distribution" argument="-g2kmax"/>
                <param name="fk_value" label="Do not constrain 'non-enriched' shape parameter k" 
                       type="boolean" truevalue="-fk" falsevalue="" checked="False"
                       help="When incorporating input signal, do not constrain 'non-enriched' shape parameter k <= 'enriched' gamma parameter k"/>
                <param name="mkn_value" type="float" value="1.0" min="0.5" max="1.5"
                       label="Max. k/N ratio (read start sites/N) used to learn truncation probabilities for 'non-crosslink' and 'crosslink' emission probabilities" argument="-mkn"
                       help="NOTE: high ratios might originate from mapping artifacts that can disturb parameter learning"/>
                <param name="mtp_value" type="float" value="0.0001"
                       label="Min. transition probability from state '2' to '3'" argument="-mkn"
                       help="Helpful for poor data, where no clear distinction between 'enriched' and 'non-enriched' is possible"/>
                <param name="mk_value" type="float" optional="True"
                       label="Minimum KDE value used for fitting left-truncated gamma distributions" argument="-mk"
                       help="Default: corresponding to singleton read start."/>
                <param name="pa_value" type="integer" optional="True"
                       label="Length threshold for internal poly-X stretches to get excluded" argument="-pa"/>
                <param name="ea1_value" label="Exclude intervals containing poly-A stretches from learning" 
                       type="boolean" truevalue="-ea1" falsevalue="" checked="False"/>
                <param name="ea2_value" label="Exclude intervals containing poly-A stretches from analysis" 
                       type="boolean" truevalue="-ea2" falsevalue="" checked="False"/>
                <param name="et1_value" label="Exclude intervals containing poly-U stretches from learning" 
                       type="boolean" truevalue="-et1" falsevalue="" checked="False"/>
                <param name="et2_value" label="Exclude intervals containing poly-U stretches from analysis" 
                       type="boolean" truevalue="-et2" falsevalue="" checked="False"/>
                <param name="mrtf_value" type="float" optional="True"
                       label="Fit gamma shape k only for positions with min. covariate value" argument="-mrtf"/>
                <param name="mtc_value" type="integer" value="250" min="50" max="500"
                       label="Maximum number of truncations at one position used for learning" argument="-mtc"
                       help="NOTE: for sites with counts above threshold the whole covered regions will be ignored for learning!"/>
                <param name="pet_value" type="integer" value="7" min="2" max="50"
                       label="Prior enrichment threshold" argument="-pet"
                       help="A KDE threshold corresponding to -pet read start counts at one position will be used for initial classification of 'non-enriched' and 'enriched' site"/>
            </when>
        </conditional>
<!--
MISSING:
-p learned_parameters.txt
data format="txt" name="learned_params_outfile" label="${tool.name} on ${on_string} learned parameters (txt)" from_work_dir="learned_parameters.txt"/>

          
chrM:4000-8300.binding_regions.bed
chrM:4000-8300.crosslink_sites.bed.stats
chrM:4000-8300.crosslink_sites.bed


pureclip -i aligned.prepro.R2.chrM:4000-8300.bam -bai aligned.prepro.R2.chrM:4000-8300.bam.bai -g chrM.fa -nt 2 -o chrM:4000-8300.crosslink_sites.bed -or chrM:4000-8300.binding_regions.bed -p learned_parameters.txt

pureclip  -i aligned.prepro.R2.chrM:4000-8300.bam -bai aligned.prepro.R2.chrM:4000-8300.bam.bai -g chrM.fa -nt 2 -o chrM:4000-8300.crosslink_sites.cov_input_signal.bed -or chrM:4000-8300.binding_regions.cov_input_signal.bed -ibam input.aligned.prepro.R2.chrM:4000-8300.bam -ibai input.aligned.prepro.R2.chrM:4000-8300.bam.bai

target_bam_file
target_bai_file

-->

    </inputs>
    <outputs>
        <data format="bed" name="crosslink_bed_outfile" label="${tool.name} on ${on_string} crosslink sites (bed)" from_work_dir="crosslink_sites.bed"/>
        <data format="bed" name="binding_region_bed_outfile" label="${tool.name} on ${on_string} binding regions (bed)" from_work_dir="binding_regions.bed"/>
        <data format="txt" name="crosslink_bed_stats" label="${tool.name} on ${on_string} learning statistics (txt)" from_work_dir="crosslink_sites.bed.stats"/>
    </outputs>
    <tests>
        <test>
            <param name="target_bam_file" value="aligned.prepro.R2.chrM:4000-8300.bam" ftype="bam"/>
            <param name="target_bai_file" value="aligned.prepro.R2.chrM:4000-8300.bam.bai" ftype="bai"/>
            <param name="genome_fasta_file" value="hsa_chrM.fa" ftype="bai"/>
            
            <param name="alphabet_type" value="-rna"/>
            <param name="rev_com" value="false"/>
            <output name="html_outfile" file="dreme1.html" lines_diff="16"/>
            <output name="txt_outfile" file="dreme1.txt" lines_diff="22"/>
        </test>
        <test>
            <param name="pos_fasta_file" value="dreme_test_sites.fa" ftype="fasta"/>
            <param name="alphabet_type" value="-rna"/>
            <param name="rev_com" value="false"/>
            <param name="options_type_selector" value="advanced"/>
            <param name="e_value_thr" value="0.00001"/>
            <param name="motif_min_k" value="4"/>
            <param name="motif_max_k" value="10"/>
            <output name="html_outfile" file="dreme2.html" lines_diff="27"/>
            <output name="txt_outfile" file="dreme2.txt" lines_diff="27"/>
        </test>
    </tests>
    <help><![CDATA[
    Protein-RNA interaction site detection using a non-homogeneous HMM.
    ]]></help>
</tool>

